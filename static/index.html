<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>心理咨询师助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    .modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center; max-width: 90%; width: 450px;
    }
    .modal-button {
      margin-top: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
      border: none; background-color: #3B82F6; color: white;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s;
    }
    .modal-button:hover { background-color: #2563EB; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- Helper Functions ---
    const downloadTextAsFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- Main Application Component ---
    const App = () => {
      const [currentUser, setCurrentUser] = useState(null);
      const [appData, setAppData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');
      const [alertInfo, setAlertInfo] = useState({ show: false, message: '' });

      const showAlert = useCallback((message) => setAlertInfo({ show: true, message }), []);

      useEffect(() => {
        const persistedUser = localStorage.getItem('currentUser');
        if (persistedUser) {
          try {
            setCurrentUser(JSON.parse(persistedUser));
          } catch(e) {
            console.error("解析本地用户数据失败", e);
            localStorage.removeItem('currentUser');
          }
        }
        setIsLoading(false);
      }, []);

      const fetchData = useCallback(async () => {
        if (!currentUser) {
            setAppData(null);
            setIsLoading(false);
            return;
        }
        setIsLoading(true);
        let dataPath;
        if (currentUser.role === 'manager') dataPath = '/api/data/manager';
        else if (currentUser.role === 'counselor') dataPath = `/api/data/counselor/${currentUser.username}`;
        else dataPath = `/api/client/me/${currentUser.username}`; // 来访者只获取自己的数据

        try {
            const res = await fetch(dataPath);
            if (!res.ok) throw new Error('获取数据失败');
            const data = await res.json();
            setAppData(data);
        } catch (error) {
            console.error("获取数据失败:", error);
            showAlert("加载数据失败，请刷新页面重试。");
        } finally {
            setIsLoading(false);
        }
      }, [currentUser]);
      
      useEffect(() => { fetchData(); }, [fetchData]);

      const saveData = useCallback(async (dataToSave) => {
          if (!currentUser) return showAlert("请先登录。");
          try {
              const response = await fetch('/api/data/save', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ currentUser, data: dataToSave }),
              });
              if (!response.ok) {
                  const err = await response.json();
                  throw new Error(err.message || "保存失败");
              }
              await fetchData(); // 保存成功后刷新数据
              showAlert("数据保存成功！");
          } catch (error) {
              console.error("保存数据失败:", error);
              showAlert(`保存数据失败: ${error.message}`);
          }
      }, [currentUser, fetchData]);

      const handleRegister = async (username, password, role, secretCode) => {
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role, secret_code: secretCode }),
            });
            const data = await response.json();
            if (!response.ok) { showAlert(data.message); return false; }
            showAlert(data.message);
            const user = { username: data.username, role: data.role };
            localStorage.setItem('currentUser', JSON.stringify(user));
            setCurrentUser(user);
            return true;
        } catch (error) {
            showAlert('注册请求失败，请检查网络连接。');
            return false;
        }
      };

      const handleLogin = async (username, password, role) => {
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role }),
            });
            const data = await response.json();
            if (!response.ok) { showAlert(data.message); return false; }
            showAlert(data.message);
            const user = { username: data.username, role: data.role };
            localStorage.setItem('currentUser', JSON.stringify(user));
            setCurrentUser(user);
            return true;
        } catch(error) {
            showAlert('登录请求失败，请检查网络连接。');
            return false;
        }
      };
      
      const handleLogout = () => {
          localStorage.removeItem('currentUser');
          setCurrentUser(null);
          setAppData(null);
      }
      
      const renderPortal = () => {
          if (isLoading) return <div className="min-h-screen flex items-center justify-center">正在加载...</div>;
          if (!currentUser) return <AuthModal onLogin={handleLogin} onRegister={handleRegister} showAlert={showAlert} />;
          if (!appData) return <div className="min-h-screen flex items-center justify-center">正在加载用户数据...</div>;

          switch (currentUser.role) {
              case 'manager':
                  return <ManagerPortal user={currentUser} allData={appData} onSave={saveData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} fetchData={fetchData} />;
              case 'counselor':
                  return <CounselorPortal user={currentUser} initialData={appData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} fetchData={fetchData} onSave={saveData} />;
              case 'client':
                  return <ClientPortal user={currentUser} clientData={appData} onLogout={handleLogout} showAlert={showAlert} onSave={saveData} fetchData={fetchData} />;
              default:
                  return <div className="min-h-screen flex items-center justify-center">无法识别的用户角色。</div>;
          }
      };

      return (
          <>
            {alertInfo.show && (
              <div className="modal-backdrop animate-fadeIn" onClick={() => setAlertInfo({ show: false, message: '' })}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                  <p className="text-gray-800 whitespace-pre-wrap">{alertInfo.message}</p>
                  <button className="modal-button" onClick={() => setAlertInfo({ show: false, message: '' })}>关闭</button>
                </div>
              </div>
            )}
            {renderPortal()}
          </>
      );
    };

    // --- Authentication Component ---
    const AuthModal = ({ onLogin, onRegister, showAlert }) => {
        const [mode, setMode] = useState('login');
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [role, setRole] = useState('counselor');
        const [secretCode, setSecretCode] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!username || !password) { showAlert('请输入用户名和密码。'); return; }

            if (mode === 'register') {
              if (password.length < 6) { showAlert('密码必须至少为6个字符。'); return; }
              if (password !== confirmPassword) { showAlert('两次输入的密码不匹配！'); return; }
              if (role === 'counselor' && !secretCode) { showAlert('请输入咨询师/管理注册口令。'); return; }
              await onRegister(username, password, role, secretCode);
            } else {
              await onLogin(username, password, role);
            }
        };
        
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-lg shadow-xl p-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">{mode === 'login' ? '登录' : '注册'}</h2>
                    <div className="flex justify-center mb-6"><div className="bg-gray-200 p-1 rounded-full flex"><button onClick={() => setRole('counselor')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'counselor' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>咨询师/管理</button><button onClick={() => setRole('client')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'client' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>来访者</button></div></div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-sm font-medium text-gray-700">用户名</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        <div><label className="text-sm font-medium text-gray-700">密码</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        {mode === 'register' && (
                          <>
                            <div><label className="text-sm font-medium text-gray-700">确认密码</label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required/></div>
                            {role === 'counselor' && (<div><label className="text-sm font-medium text-gray-700">注册口令</label><input type="password" value={secretCode} onChange={e => setSecretCode(e.target.value)} placeholder="咨询师/管理员需要口令" className="w-full p-2 mt-1 border rounded-md" required/></div>)}
                          </>
                        )}
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">{mode === 'login' ? '登录' : '注册'}</button>
                    </form>
                    <p className="text-xs text-center text-gray-500 mt-4">{mode === 'login' ? '没有账户？' : '已有账户？'}<button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 hover:underline ml-1">{mode === 'login' ? '点击注册' : '返回登录'}</button></p>
                </div>
            </div>
        );
    };
    
    // --- Portals ---
    const ManagerPortal = ({ user, allData, onSave, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage, fetchData }) => {
        // Manager portal logic would go here. For brevity, it can be similar to counselor but with more rights.
        // The key is it receives `allData` and can modify it.
        return <div className="p-4"><h1 className="text-2xl">管理员门户</h1><p>欢迎, {user.username}!</p><button onClick={onLogout} className="mt-4 p-2 bg-red-500 text-white rounded">登出</button></div>;
    };
    
    const ClientPortal = ({ user, clientData, onLogout, showAlert, onSave, fetchData }) => {
      // Client portal logic would go here, displaying their own info and assigned counselor.
       return <div className="p-4"><h1 className="text-2xl">来访者门户</h1><p>欢迎, {user.username}!</p><div><pre className="bg-gray-200 p-2 rounded text-xs mt-4">{JSON.stringify(clientData, null, 2)}</pre></div><button onClick={onLogout} className="mt-4 p-2 bg-red-500 text-white rounded">登出</button></div>;
    };

    const CounselorPortal = ({ user, initialData, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage, fetchData, onSave }) => {
      const [activeSection, setActiveSection] = useState('clientManagement');
      const [selectedClient, setSelectedClient] = useState(null);

      const handleSelectClient = (client) => {
        setSelectedClient(client);
        setActiveSection('clientDetail');
      };
      
      const navItems = [
          { id: 'clientManagement', label: '来访者管理', icon: '👥' },
          { id: 'counselorManagement', label: '咨询师信息', icon: '🧑‍🏫' },
          { id: 'cbtApplication', label: '咨询流程辅助工具', icon: '🧠' }
      ];

      const renderSection = () => {
        switch (activeSection) {
          case 'clientManagement':
            return <ClientManagementSection clients={initialData.assigned_clients} onSelectClient={handleSelectClient} />;
          case 'counselorManagement':
            return <CounselorManagementSection 
                      counselor={initialData.counselors.find(c => c.username === user.username)}
                      unassignedClients={initialData.unassigned_clients}
                      onSave={onSave}
                      fetchData={fetchData}
                      showAlert={showAlert}
                      currentUser={user}
                   />;
          case 'clientDetail':
            return selectedClient ? 
                   <ClientDetailView 
                      key={selectedClient.id} 
                      client={selectedClient} 
                      onSave={onSave}
                      setGlobalLoadingMessage={setGlobalLoadingMessage}
                    /> : 
                   <div className="text-center p-10 text-gray-500">请先从列表中选择一位来访者。</div>;
          case 'cbtApplication':
            return <CBTSection />;
          default:
            return <ClientManagementSection clients={initialData.assigned_clients} onSelectClient={handleSelectClient} />;
        }
      };
      
      return (
        <div className="min-h-screen bg-gray-100 flex flex-col">
          <header className="bg-gray-800 text-white shadow-lg"><div className="container mx-auto px-4"><div className="flex items-center justify-between h-16">
            <div className="flex items-center"><span className="text-2xl mr-3">💌</span><h1 className="text-xl font-bold">咨询师工作台</h1></div>
            <div className="flex items-center">
              <nav className="flex items-center space-x-2">
                {navItems.map(item => (
                  <button key={item.id} onClick={()=>setActiveSection(item.id)} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeSection === item.id || (activeSection === 'clientDetail' && item.id === 'clientManagement') ? 'bg-gray-900':'text-gray-300 hover:bg-gray-700'}`}>
                    <span className="mr-2">{item.icon}</span>{item.label}
                  </button>
                ))}
              </nav>
              <div className="border-l border-gray-600 ml-4 pl-4 flex items-center gap-2">
                  <span className="text-sm text-gray-300">{user.username}</span>
                  <button onClick={onLogout} className="text-sm font-medium text-red-400 hover:text-red-300">登出</button>
              </div>
            </div>
          </div></div></header>
          {globalLoadingMessage && (<div className="bg-yellow-400 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center sticky top-16 z-30"><span className="mr-2">⏳</span>{globalLoadingMessage}</div>)}
          <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
        </div>
      );
    };

    // --- Shared Components ---
    const BindingCodeModal = ({ client, onClose, onConfirm, showAlert }) => {
        const [code, setCode] = useState('');
        const handleConfirm = () => {
            if (!code || code.trim().length !== 6) { showAlert('请输入一个6位数的添加口令。'); return; }
            onConfirm(code.toUpperCase());
        };
        return (
            <div className="modal-backdrop"><div className="modal-content">
                <h3 className="text-xl font-semibold mb-2">添加来访者</h3><p className="text-sm text-gray-600 mb-4">请输入来访者 <span className="font-bold">{client.name}</span> 的6位添加口令以确认操作。</p>
                <input type="text" placeholder="添加口令" maxLength="6" value={code} onChange={(e) => setCode(e.target.value)} className="p-2 border rounded-md w-full text-center tracking-widest font-mono"/>
                <div className="flex justify-center items-center gap-4 mt-6"><button onClick={onClose} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">取消</button><button onClick={handleConfirm} className="px-6 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md">确认添加</button></div>
            </div></div>
        );
    };

    const CounselorManagementSection = ({ counselor, unassignedClients, onSave, fetchData, showAlert, currentUser }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [formData, setFormData] = useState({ ...counselor });
        const [assignmentModal, setAssignmentModal] = useState({ isOpen: false, client: null });

        const handleSaveProfile = () => {
            onSave({ counselorProfile: formData });
            setIsEditing(false);
        };
        
        const handleClientSelection = (clientId) => {
            if (!clientId) return;
            const clientToAssign = unassignedClients.find(c => c.id === clientId);
            if (clientToAssign) { setAssignmentModal({ isOpen: true, client: clientToAssign }); }
        };

        const handleAssignConfirm = async (bindingCode) => {
            const clientToAssign = assignmentModal.client;
            if (!clientToAssign || !bindingCode) return;
            try {
                const res = await fetch('/api/counselor/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ counselorUsername: currentUser.username, clientId: clientToAssign.id, binding_code: bindingCode }),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || "分配失败");
                showAlert(`来访者 ${clientToAssign.name} 已成功分配!`);
                fetchData();
                setAssignmentModal({ isOpen: false, client: null });
            } catch (err) { showAlert(err.message); }
        };

        return (
            <>
              {assignmentModal.isOpen && <BindingCodeModal client={assignmentModal.client} onClose={() => setAssignmentModal({ isOpen: false, client: null })} onConfirm={handleAssignConfirm} showAlert={showAlert} />}
              <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
                  <div className="flex justify-between items-center mb-6 pb-4 border-b">
                      <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">🧑‍🏫</span>我的信息</h2>
                      {!isEditing && <button onClick={() => setIsEditing(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center">编辑档案</button>}
                  </div>
                  {isEditing ? (
                      <div className="space-y-4 max-w-lg mx-auto">
                          <div><label className="block text-sm font-medium">姓名</label><input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border rounded-md" /></div>
                          <div><label className="block text-sm font-medium">联系方式</label><input type="text" value={formData.contactInfo} onChange={e => setFormData({...formData, contactInfo: e.target.value})} className="w-full p-2 border rounded-md" /></div>
                          <div><label className="block text-sm font-medium">擅长咨询流派</label><input type="text" value={formData.modality} onChange={e => setFormData({...formData, modality: e.target.value})} className="w-full p-2 border rounded-md" /></div>
                          <div><label className="block text-sm font-medium">临床和学术背景</label><textarea value={formData.clinicalBackground} onChange={e => setFormData({...formData, clinicalBackground: e.target.value})} rows="4" className="w-full p-2 border rounded-md"></textarea></div>
                          
                          <div className="pt-4 border-t"><label className="block text-sm font-medium">负责新来访</label><p className="text-xs text-gray-500 mb-2">从此列表选择一个未分配的来访者，并输入其添加口令来建立关联。</p>
                            <select onChange={(e) => handleClientSelection(e.target.value)} className="w-full p-2 border rounded-md" value=""><option value="">-- 选择一个来访者 --</option>{unassignedClients?.map(client => (<option key={client.id} value={client.id}>{client.name}</option>))}</select>
                          </div>

                          <div className="flex justify-end space-x-3 pt-4 border-t mt-6">
                              <button onClick={() => setIsEditing(false)} className="px-4 py-2 bg-gray-200 rounded-md border">取消</button>
                              <button onClick={handleSaveProfile} className="px-4 py-2 text-white bg-blue-600 rounded-md">保存档案</button>
                          </div>
                      </div>
                  ) : (
                      <div className="bg-blue-50 border rounded-lg p-4">
                          <h3 className="text-xl font-bold text-blue-700">{counselor.name}</h3>
                          <p className="text-sm text-gray-600 mt-1">{counselor.modality}</p>
                          {counselor.contactInfo && <p className="text-sm text-gray-500 mt-2"><b>联系方式:</b> {counselor.contactInfo}</p>}
                          {counselor.clinicalBackground && <p className="text-sm text-gray-500 mt-2 whitespace-pre-wrap">{counselor.clinicalBackground}</p>}
                      </div>
                  )}
              </div>
            </>
        );
    };

    const ClientManagementSection = ({ clients, onSelectClient }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const filteredClients = clients.filter(client => client.name.toLowerCase().includes(searchTerm.toLowerCase()));
      
      return (
          <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
              <div className="flex justify-between items-center mb-6 pb-4 border-b">
                  <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">👥</span>我的来访者</h2>
              </div>
              <input type="text" placeholder="搜索来访者姓名..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 mb-4 border rounded-lg"/>
              {filteredClients.length > 0 ? (
                  <ul className="space-y-3">{filteredClients.map(client => (<li key={client.id} onClick={() => onSelectClient(client)} className="bg-gray-50 hover:bg-blue-50 border rounded-lg p-4 cursor-pointer flex justify-between items-center"><div><p className="text-lg font-medium text-blue-700">{client.name} <span className="text-sm text-gray-500">({client.gender}, {client.age}岁)</span></p><p className="text-sm text-gray-600">加入日期: {client.joinDate}</p></div><span className="text-gray-400">❯</span></li>))}</ul>
              ) : <p className="text-center text-gray-500 py-8">您当前没有负责的来访者。</p>}
          </div>
      );
    };
    
    // The rest of the components are taken from the local version but adapted for API data
    const ClientDetailView = ({ client, onSave, setGlobalLoadingMessage }) => {
      // This component now receives the client object as a prop
      // onSave will now trigger an API call
      const handleUpdateClient = (updatedClientData) => {
        onSave({ clientData: updatedClientData });
      };

      return (
        <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
          <h2 className="text-2xl font-semibold text-gray-700 mb-4 pb-4 border-b flex items-center">
            <span className="mr-3 text-3xl">👤</span>{client.name} - 档案中心
          </h2>
          <ClientProfileTabs 
            client={client} 
            onUpdateClient={handleUpdateClient} 
            setGlobalLoadingMessage={setGlobalLoadingMessage}
          />
        </div>
      );
    };

    const ClientProfileTabs = ({ client, onUpdateClient, setGlobalLoadingMessage }) => {
      const [activeTab, setActiveTab] = useState('profile');
      const tabs = [{ id: 'profile', label: '档案与会话', icon: '👤' }, { id: 'conceptualization', label: 'AI个案概念化', icon: '📜' },{ id: 'analysis', label: '来访者评估', icon: '📊' }, { id: 'supervision', label: 'AI督导', icon: '🔬' }];
      
      const handleFileUpload = async (sessionId, file) => {
          setGlobalLoadingMessage(`正在为 ${client.name} (会话: ${sessionId.slice(-4)}) 生成AI报告...`);
          const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
          let tempClient = JSON.parse(JSON.stringify(client));
          tempClient.sessions[sessionIndex].conceptualization.status = 'Processing';
          tempClient.sessions[sessionIndex].assessment.status = 'Processing';
          onUpdateClient(tempClient);
          
          const formData = new FormData();
          formData.append('transcript', file);
          // We must send client info without circular references or large objects
          const clientInfoForApi = { ...client };
          delete clientInfoForApi.sessions;
          formData.append('client_info', JSON.stringify(clientInfoForApi));

          try {
              const response = await fetch('/api/upload-and-analyze', { method: 'POST', body: formData });
              if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `服务器错误: ${response.status}`); }
              const result = await response.json();
              
              let finalClient = JSON.parse(JSON.stringify(client));
              const finalSessionIndex = finalClient.sessions.findIndex(s => s.id === sessionId);
              finalClient.sessions[finalSessionIndex].transcript = { name: result.uploadedFileName, content: '已上传处理' };
              finalClient.sessions[finalSessionIndex].conceptualization = result.conceptualization;
              finalClient.sessions[finalSessionIndex].assessment = result.assessment;
              onUpdateClient(finalClient);

          } catch (error) {
              let errorClient = JSON.parse(JSON.stringify(client));
              const errorSessionIndex = errorClient.sessions.findIndex(s => s.id === sessionId);
              errorClient.sessions[errorSessionIndex].conceptualization = {status: 'Error', content: error.message};
              errorClient.sessions[errorSessionIndex].assessment = {status: 'Error', content: error.message};
              onUpdateClient(errorClient);
          } finally {
              setGlobalLoadingMessage('');
          }
      };

      const handleAddSession = () => {
        const newSession = { id: `session-${Date.now()}`, date: new Date().toISOString().split('T')[0], summary: '新会话', transcript: null, conceptualization: { status: 'Pending' }, assessment: { status: 'Pending' }, supervision: { status: 'Pending' } };
        const updatedClient = { ...client, sessions: [...(client.sessions || []), newSession] };
        onUpdateClient(updatedClient);
      };
      
      // ... a similar handleSupervisionFileUploaded logic would be here ...

      return (
        <div>
          <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-6 overflow-x-auto">{tabs.map(tab => <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-shrink-0 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center ${activeTab === tab.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><span className="mr-2">{tab.icon}</span>{tab.label}</button>)}</nav></div>
          <div className="pt-6">
            {activeTab === 'profile' && <ClientProfileDetailTab client={client} onAddSession={handleAddSession} onFileUpload={handleFileUpload} />}
            {activeTab === 'conceptualization' && <ReportDisplayTab client={client} reportType="conceptualization" title="AI个案概念化" themeColor="indigo" />}
            {activeTab === 'analysis' && <ReportDisplayTab client={client} reportType="assessment" title="来访者评估" themeColor="green" />}
          </div>
        </div>
      );
    };

    const ClientProfileDetailTab = ({ client, onAddSession, onFileUpload }) => {
      const SessionCard = ({ session }) => {
        const fileInputRef = useRef(null);
        return (<div className="p-4 bg-white rounded-lg border border-gray-300 shadow-sm">
            <p className="font-semibold text-gray-800">咨询日期: {session.date}</p>
            <div className="mt-3 p-3 bg-gray-50 rounded-md text-center">
              <p className="text-sm font-medium text-gray-600">咨询逐字稿</p>
              {session.transcript ? (<div className="text-green-600 mt-1">✅ {session.transcript.name}</div>) : (
                <><input type="file" ref={fileInputRef} onChange={e => onFileUpload(session.id, e.target.files[0])} className="hidden" accept=".txt,.md" />
                <button onClick={() => fileInputRef.current.click()} className="mt-1 text-xs bg-indigo-500 text-white py-1 px-2 rounded">上传并分析</button></>
              )}
            </div>
        </div>);
      };
      return (
        <div className="space-y-6">
          {/* Basic Info Display */}
          <div className="p-4 bg-gray-50 rounded-lg border">
            <h3 className="text-lg font-semibold text-gray-700 mb-3">基本信息</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-sm">
                <p><strong>姓名:</strong> {client.name}</p><p><strong>年龄:</strong> {client.age} 岁</p><p><strong>性别:</strong> {client.gender}</p>
                <p><strong>职业/年级:</strong> {client.grade || '未提供'}</p><p><strong>联系方式:</strong> {client.contact || '未提供'}</p>
            </div>
          </div>
          {/* Sessions */}
          <div>
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-lg font-semibold text-gray-700">咨询会话</h3>
              <button onClick={onAddSession} className="text-sm bg-blue-600 text-white py-1 px-3 rounded-md">添加新会话</button>
            </div>
            <div className="space-y-4">
              {[...(client.sessions || [])].reverse().map(session => <SessionCard key={session.id} session={session} />)}
            </div>
          </div>
        </div>
      );
    };

    const ReportDisplayTab = ({ client, reportType, title, themeColor }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s[reportType] && s[reportType].status !== 'Pending');
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions.slice().reverse()[0] : null);
        
        useEffect(() => {
            const sessions = (client.sessions || []).filter(s => s[reportType]?.status !== 'Pending');
            if (sessions.length > 0 && !sessions.some(s => s.id === selectedSession?.id)) {
                setSelectedSession(sessions.slice().reverse()[0]);
            } else if (sessions.length === 0) {
                setSelectedSession(null);
            }
        }, [client, reportType, selectedSession]);

        const report = selectedSession ? selectedSession[reportType] : null;

        return (
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">历史记录</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无记录。</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? `bg-${themeColor}-100 border-${themeColor}-500` : `bg-white hover:bg-gray-100 border-transparent`}`}><p className={`font-semibold text-${themeColor}-600`}>咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 ${session[reportType].status === 'Complete' ? 'text-green-600' : 'text-red-600'}`}>状态: {session[reportType].status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">{title}详情</h3>{report ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className={`font-bold text-lg text-${themeColor}-700`}>关于 {selectedSession.date} 咨询的{title}</h4><button onClick={()=>downloadTextAsFile(report.content, `${client.name}_${selectedSession.date}_${reportType}.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded hover:bg-gray-700">下载</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{report.error ? <span className="text-red-600">{report.error}</span> : report.content}</div></div> : <p className="text-gray-500 text-center pt-10">请从左侧选择记录查看。</p>}</div>
            </div>
        );
    }
    
    const CBTSection = ({...props}) => {
        return ( <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn max-w-4xl mx-auto"> <h2 className="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3 flex items-center"><span className="text-2xl mr-3">🧠</span>咨询流程辅助工具 (待开发)</h2> <div className="text-center p-8 bg-gray-50 rounded-lg"><h3 className="text-xl font-bold text-gray-600">功能开发中</h3><p className="mt-2 text-gray-500">此模块正在积极开发中，敬请期待未来的更新！</p></div></div> );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
