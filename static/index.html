<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒç†å’¨è¯¢å¸ˆåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    .custom-modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .custom-modal-content {
      background: white; padding: 2rem; border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center; max-width: 90%; width: 450px;
    }
    .custom-modal-button {
      margin-top: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
      border: none; background-color: #3B82F6; color: white;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s;
    }
    .custom-modal-button:hover { background-color: #2563EB; }
    .time-slot { display: flex; flex-direction: column; gap: 4px; }
    .tab-button-active {
        border-color: #3B82F6;
        color: #3B82F6;
        background-color: #EFF6FF;
    }
    .tab-button-inactive {
        border-color: transparent;
        color: #6B7280;
    }
    .tab-button-inactive:hover {
        color: #111827;
        border-color: #D1D5DB;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const App = () => {
      const { useState, useEffect, useCallback } = React;
      
      const [appData, setAppData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [currentUser, setCurrentUser] = useState(null); // Will store { username, role }

      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');
      const [alertInfo, setAlertInfo] = useState({ show: false, message: '' });

      // Check for persisted user on initial load
      useEffect(() => {
        const persistedUser = localStorage.getItem('currentUser');
        if (persistedUser) {
          try {
            setCurrentUser(JSON.parse(persistedUser));
          } catch(e) {
            console.error("Failed to parse user from localStorage", e);
            localStorage.removeItem('currentUser');
          }
        }
        setIsLoading(false);
      }, []);

      const showAlert = useCallback((message) => {
        setAlertInfo({ show: true, message });
      }, []);
      
      const fetchData = useCallback(async () => {
        if (!currentUser) {
            setAppData(null);
            setIsLoading(false);
            return;
        }

        setIsLoading(true);
        let dataPath;
        if (currentUser.role === 'manager') {
            dataPath = '/api/data/manager';
        } else if (currentUser.role === 'counselor') {
            dataPath = `/api/data/counselor/${currentUser.username}`;
        } else { // client
            dataPath = '/api/data/all';
        }

        try {
            const res = await fetch(dataPath);
            if (!res.ok) throw new Error('Failed to fetch data');
            const data = await res.json();
            setAppData(data);
        } catch (error) {
            console.error("Failed to fetch data:", error);
            showAlert("åŠ è½½æ•°æ®å¤±è´¥ã€‚");
        } finally {
            setIsLoading(false);
        }
      }, [currentUser]);
      
      useEffect(() => {
        fetchData();
      }, [fetchData]);

      // Generic save function now routes based on role
      const saveData = useCallback(async (dataToSave, isClientProfileUpdate = false) => {
          if (!currentUser) return showAlert("è¯·å…ˆç™»å½•ã€‚");

          let url, body;
          if (currentUser.role === 'manager') {
              url = '/api/data/manager';
              body = JSON.stringify(dataToSave); // Manager saves the whole blob
          } else if (currentUser.role === 'counselor') {
              url = `/api/data/counselor/${currentUser.username}`;
              body = JSON.stringify(dataToSave); // Counselor saves their perspective
          } else if (currentUser.role === 'client' && isClientProfileUpdate) {
              url = `/api/data/client/${currentUser.username}`;
              body = JSON.stringify(dataToSave); // Client saves their profile
          } else {
              return showAlert("æ— æƒä¿å­˜æ•°æ®ã€‚");
          }

          try {
              const response = await fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: body,
              });
              if (!response.ok) {
                  const err = await response.json();
                  throw new Error(err.message || "ä¿å­˜å¤±è´¥");
              }
              // No automatic fetchData here to allow for optimistic updates
          } catch (error) {
              console.error("Failed to save data:", error);
              showAlert(`ä¿å­˜æ•°æ®å¤±è´¥: ${error.message}`);
          }
      }, [currentUser]);

      const handleRegister = async (username, password, role, secretCode) => {
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role, secret_code: secretCode }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message); // The message from backend now contains the binding code
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch (error) {
            showAlert('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };

      const handleLogin = async (username, password, role) => {
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message);
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch(error) {
            showAlert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };
      
      const handleLogout = () => {
          localStorage.removeItem('currentUser');
          setCurrentUser(null);
          setAppData(null);
      }
      
      const renderPortal = () => {
          if (isLoading || (currentUser && !appData)) {
              return <div className="min-h-screen flex items-center justify-center">æ­£åœ¨åŠ è½½...</div>
          }
          if (!currentUser) {
              return <AuthModal onLogin={handleLogin} onRegister={handleRegister} showAlert={showAlert} />;
          }
          switch (currentUser.role) {
              case 'manager':
                  return <ManagerPortal user={currentUser} allData={appData} setAllData={setAppData} onSave={saveData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} />;
              case 'counselor':
                  return <CounselorPortal user={currentUser} initialData={appData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} fetchData={fetchData} />;
              case 'client':
                  return <ClientPortal user={currentUser} allData={appData} onLogout={handleLogout} onSave={saveData} showAlert={showAlert} fetchData={fetchData}/>;
              default:
                  return <div className="min-h-screen flex items-center justify-center">æ— æ³•è¯†åˆ«çš„ç”¨æˆ·è§’è‰²ã€‚</div>;
          }
      };

      return (
          <>
            {alertInfo.show && (
              <div className="custom-modal-backdrop animate-fadeIn" onClick={() => setAlertInfo({ show: false, message: '' })}>
                <div className="custom-modal-content" onClick={(e) => e.stopPropagation()}>
                  <p className="text-gray-800 whitespace-pre-wrap">{alertInfo.message}</p>
                  <button className="custom-modal-button" onClick={() => setAlertInfo({ show: false, message: '' })}>å…³é—­</button>
                </div>
              </div>
            )}
            {renderPortal()}
          </>
      );
    };
    
    // --- All Components ---

    const AuthModal = ({ onLogin, onRegister, showAlert }) => {
        const { useState } = React;
        const [mode, setMode] = useState('login');
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [role, setRole] = useState('counselor');
        const [secretCode, setSecretCode] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            
            if (!username) { showAlert('è¯·è¾“å…¥ç”¨æˆ·åã€‚'); return; }
            if (!(mode === 'login' && role === 'client') && !password) { showAlert('è¯·è¾“å…¥å¯†ç ã€‚'); return; }

            if (mode === 'register') {
              if (password.length < 6) { showAlert('å¯†ç å¿…é¡»è‡³å°‘ä¸º6ä¸ªå­—ç¬¦ã€‚'); return; }
              if (password !== confirmPassword) { showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸åŒ¹é…ï¼'); return; }
              if (role === 'counselor' && !secretCode) { showAlert('è¯·è¾“å…¥å’¨è¯¢å¸ˆ/ç®¡ç†æ³¨å†Œå£ä»¤ã€‚'); return; }
              await onRegister(username, password, role, secretCode);
            } else {
              await onLogin(username, password, role);
            }
        };
        
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-lg shadow-xl p-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</h2>
                    
                    <div className="flex justify-center mb-6">
                        <div className="bg-gray-200 p-1 rounded-full flex">
                            <button onClick={() => setRole('counselor')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'counselor' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>å’¨è¯¢å¸ˆ/ç®¡ç†</button>
                            <button onClick={() => setRole('client')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'client' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>æ¥è®¿è€…</button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-sm font-medium text-gray-700">ç”¨æˆ·å</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        
                        {!(mode === 'login' && role === 'client') && (
                          <div><label className="text-sm font-medium text-gray-700">å¯†ç </label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        )}

                        {mode === 'register' && (
                          <>
                            <div><label className="text-sm font-medium text-gray-700">ç¡®è®¤å¯†ç </label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required/></div>
                            {role === 'counselor' && (
                              <div><label className="text-sm font-medium text-gray-700">æ³¨å†Œå£ä»¤</label><input type="password" value={secretCode} onChange={e => setSecretCode(e.target.value)} placeholder="å’¨è¯¢å¸ˆ/ç®¡ç†å‘˜éœ€è¦å£ä»¤" className="w-full p-2 mt-1 border rounded-md" required/></div>
                            )}
                          </>
                        )}
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</button>
                    </form>

                    <p className="text-xs text-center text-gray-500 mt-4">
                      {mode === 'login' ? 'æ²¡æœ‰è´¦æˆ·ï¼Ÿ' : 'å·²æœ‰è´¦æˆ·ï¼Ÿ'}
                      <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 hover:underline ml-1">
                        {mode === 'login' ? 'ç‚¹å‡»æ³¨å†Œ' : 'è¿”å›ç™»å½•'}
                      </button>
                    </p>
                </div>
            </div>
        );
    };
    
    // ================================================================================================
    // =================================== MANAGER PORTAL START =======================================
    // ================================================================================================
    const ManagerPortal = ({ user, allData, setAllData, onSave, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage }) => {
        const { useState } = React;
        const [activeSection, setActiveSection] = useState('counselorManagement');
        const [selectedClient, setSelectedClient] = useState(null);

        const handleUpdateData = (newData) => {
            setAllData(newData);
            onSave(newData);
        };

        const handleUpdateClient = (updatedClientData) => {
            const newCounselorData = { ...allData.counselor_data };
            const clientIndex = newCounselorData.clients.findIndex(c => c.id === updatedClientData.id);
            if (clientIndex > -1) {
                newCounselorData.clients[clientIndex] = updatedClientData;
            } else {
                newCounselorData.clients.push(updatedClientData);
            }
            handleUpdateData({ ...allData, counselor_data: newCounselorData });
        };
        
        const handleDeleteClient = (clientId) => {
            const clientToDelete = allData.counselor_data.clients.find(c => c.id === clientId);
            if (!clientToDelete) return;

            const updatedCounselorData = { ...allData.counselor_data };
            updatedCounselorData.clients = updatedCounselorData.clients.filter(c => c.id !== clientId);
            updatedCounselorData.counselors = updatedCounselorData.counselors.map(c => ({
                ...c, assignedClientIds: c.assignedClientIds.filter(id => id !== clientId)
            }));
            updatedCounselorData.appointments = updatedCounselorData.appointments.filter(a => a.clientId !== clientId);

            const updatedUsers = { ...allData.users };
            if (clientToDelete.username) {
                delete updatedUsers[clientToDelete.username];
            }
            
            handleUpdateData({ users: updatedUsers, counselor_data: updatedCounselorData });
            showAlert(`æ¥è®¿è€… ${clientToDelete.name} å·²è¢«åˆ é™¤ã€‚`);
            if (selectedClient?.id === clientId) setSelectedClient(null);
        };

        const handleUpdateCounselors = (updatedCounselors) => {
            handleUpdateData({ ...allData, counselor_data: { ...allData.counselor_data, counselors: updatedCounselors } });
        };

        const handleDeleteCounselor = (counselorId) => {
            const counselorToDelete = allData.counselor_data.counselors.find(c => c.id === counselorId);
            if(!counselorToDelete) return;
            if (allData.counselor_data.appointments.some(a => a.counselorId === counselorId)) {
                return showAlert('æ— æ³•åˆ é™¤è¯¥å’¨è¯¢å¸ˆï¼Œå…¶ä»æœ‰å…³è”çš„æ—¥ç¨‹å®‰æ’ã€‚');
            }
            const updatedCounselors = allData.counselor_data.counselors.filter(c => c.id !== counselorId);
            const updatedUsers = { ...allData.users };
            if (counselorToDelete.username) {
                delete updatedUsers[counselorToDelete.username];
            }
            handleUpdateData({ users: updatedUsers, counselor_data: { ...allData.counselor_data, counselors: updatedCounselors } });
            showAlert('å’¨è¯¢å¸ˆå·²åˆ é™¤ã€‚');
        };

        const handleUpdateAppointments = (appointmentData, isDelete = false) => {
            let updatedAppointments;
            if (isDelete) {
                updatedAppointments = allData.counselor_data.appointments.filter(a => a.id !== appointmentData.id);
            } else {
                const index = allData.counselor_data.appointments.findIndex(a => a.id === appointmentData.id);
                updatedAppointments = [...allData.counselor_data.appointments];
                if (index > -1) updatedAppointments[index] = appointmentData;
                else updatedAppointments.push({ ...appointmentData, id: `appt-${Date.now()}`, status: 'confirmed' });
            }
            handleUpdateData({ ...allData, counselor_data: { ...allData.counselor_data, appointments: updatedAppointments } });
        };
        
        const handleSaveUser = (username, password, role, isNew = false) => {
            const updatedUsers = { ...allData.users };
            if(updatedUsers[username] && isNew) return showAlert('ç”¨æˆ·åå·²å­˜åœ¨');
            updatedUsers[username] = { password, role };
            handleUpdateData({ ...allData, users: updatedUsers });
        };

        const navItems = [
            { id: 'counselorManagement', label: 'å’¨è¯¢å¸ˆç®¡ç†', icon: 'ğŸ§‘â€ğŸ«' },
            { id: 'clientManagement', label: 'æ¥è®¿è€…ç®¡ç†', icon: 'ğŸ‘¥' },
            { id: 'schedule', label: 'å’¨è¯¢æ—¥ç¨‹', icon: 'ğŸ—“ï¸' },
        ];
        
        const renderSection = () => {
            const { users, counselor_data } = allData;
            switch(activeSection) {
                case 'counselorManagement':
                    return <CounselorManagementSection 
                                isManagerView={true} 
                                counselors={counselor_data.counselors} 
                                clients={counselor_data.clients} 
                                appointments={counselor_data.appointments}
                                users={users}
                                onUpdateCounselors={handleUpdateCounselors}
                                onDeleteCounselor={handleDeleteCounselor}
                                onSaveUser={handleSaveUser}
                            />;
                case 'clientManagement':
                    return <ClientManagementSection 
                                isManagerView={true}
                                clients={counselor_data.clients}
                                users={users}
                                onSelectClient={setSelectedClient}
                                onSaveUser={handleSaveUser}
                                onUpdateClient={handleUpdateClient}
                                onDeleteClient={handleDeleteClient}
                                onClientDetailBack={() => setSelectedClient(null)}
                                selectedClient={selectedClient}
                                setGlobalLoadingMessage={setGlobalLoadingMessage}
                                showAlert={showAlert}
                            />;
                case 'schedule':
                     return <ScheduleSection 
                                appointments={counselor_data.appointments} 
                                clients={counselor_data.clients} 
                                counselors={counselor_data.counselors} 
                                onUpdateAppointments={handleUpdateAppointments} 
                                isManagerView={true}
                            />;
                default: return <div/>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
                <header className="bg-white shadow-sm sticky top-0 z-40">
                    <div className="container mx-auto px-4">
                        <div className="flex items-center justify-between h-16">
                            <h1 className="text-xl font-bold text-gray-800">å¹³å°ç®¡ç†</h1>
                            <div className="flex items-center gap-4">
                                <nav className="hidden md:flex items-center space-x-1">
                                    {navItems.map(item => (
                                        <button key={item.id} onClick={() => setActiveSection(item.id)}
                                            className={`px-3 py-2 rounded-md text-sm font-medium flex items-center transition-colors duration-200 ${activeSection === item.id ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}>
                                            <span className="mr-2">{item.icon}</span>{item.label}
                                        </button>
                                    ))}
                                </nav>
                                <div className="border-l pl-4 flex items-center gap-2">
                                    <span className="text-sm text-gray-500 hidden lg:inline">{user.username}</span>
                                    <button onClick={onLogout} className="text-sm font-medium text-gray-500 hover:text-red-600">ç™»å‡º</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                {globalLoadingMessage && (<div className="bg-yellow-100 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center sticky top-16 z-30"><span className="mr-2">â³</span>{globalLoadingMessage}</div>)}
                <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
            </div>
        );
    };


    // ================================================================================================
    // =================================== CLIENT PORTAL START ========================================
    // ================================================================================================
    const ClientPortal = ({ user, allData, onLogout, onSave, showAlert, fetchData }) => {
        const { useState, useEffect } = React;
        const [clientProfile, setClientProfile] = useState(null);
        const [activeTab, setActiveTab] = useState('info');

        useEffect(() => {
            const fetchSelfData = async () => {
                try {
                    const res = await fetch(`/api/client/me/${user.username}`);
                    if (!res.ok) throw new Error('Could not fetch client profile');
                    const selfData = await res.json();
                    setClientProfile(selfData);
                } catch (error) {
                    console.error(error);
                    showAlert('æ— æ³•åŠ è½½æ‚¨çš„ä¸ªäººä¿¡æ¯ã€‚');
                }
            };
            fetchSelfData();
        }, [user.username]);

        const renderTabContent = () => {
            switch(activeTab) {
                case 'info':
                    return <ClientInfoTab clientProfile={clientProfile} allData={allData} user={user} />;
                case 'counselors':
                    return <CounselorDirectoryTab counselors={allData?.counselors || []} />;
                case 'booking':
                    return <ClientBookingTab 
                                clientProfile={clientProfile} 
                                appointments={allData?.appointments || []} 
                                counselors={allData?.counselors || []}
                                showAlert={showAlert}
                                fetchData={fetchData}
                            />;
                default:
                    return null;
            }
        };
        
        if (!allData || !clientProfile) {
            return <div className="min-h-screen flex items-center justify-center">æ­£åœ¨åŠ è½½æ‚¨çš„ä¿¡æ¯...</div>;
        }

        const tabs = [
            { id: 'info', label: 'æˆ‘çš„ä¸»é¡µ' },
            { id: 'counselors', label: 'å’¨è¯¢å¸ˆåå½•' },
            { id: 'booking', label: 'é¢„çº¦å’¨è¯¢' },
        ];

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
              <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="container mx-auto px-4">
                  <div className="flex items-center justify-between h-16">
                    <h1 className="text-xl font-bold text-gray-800">æ¥è®¿è€…é—¨æˆ·</h1>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-500">{user.username}</span>
                      <button onClick={onLogout} className="text-sm font-medium text-red-600 hover:underline">ç™»å‡º</button>
                    </div>
                  </div>
                </div>
              </header>
              <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-6 overflow-x-auto">
                        {tabs.map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} 
                                className={`flex-shrink-0 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${activeTab === tab.id ? 'tab-button-active' : 'tab-button-inactive'}`}>
                                {tab.label}
                            </button>
                        ))}
                    </nav>
                </div>
                <div className="animate-fadeIn">
                    {renderTabContent()}
                </div>
              </main>
            </div>
        );
    }
    
    const ClientInfoTab = ({ clientProfile, allData, user }) => {
        const { useMemo } = React;
        const assignedCounselor = clientProfile && allData && allData.counselors ? allData.counselors.find(c => c.assignedClientIds?.includes(clientProfile.id)) : null;
        const clientAppointments = clientProfile && allData && allData.appointments ? allData.appointments.filter(a => a.clientId === clientProfile.id) : [];

        const { totalHours, monthlyHours } = useMemo(() => {
            if (!clientAppointments) return { totalHours: 0, monthlyHours: 0 };
            const confirmedAppointments = clientAppointments.filter(a => a.status === 'confirmed');
            const now = new Date();
            const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

            const total = confirmedAppointments.length;
            const monthly = confirmedAppointments.filter(a => new Date(a.date) >= oneMonthAgo).length;
            
            return { totalHours: total, monthlyHours: monthly };
        }, [clientAppointments]);
        
        const wechatQrCodeBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAoACgDASIAAhEBAxEB/8QAGQABAQEBAQEAAAAAAAAAAAAAAAcGBQQI/8QAKRAAAQMDAgQGAwAAAAAAAAAAAQIDBAAFEQYHEhMhMUEUFRYiI0Jhcf/EABcBAQEBAQAAAAAAAAAAAAAAAAQBAgP/xAAaEQEBAQEBAQEAAAAAAAAAAAAAAQIDETFB/9oADAMBAAIRAxEAPwDqOkA+V8c+g/c0y0gH6vjB9B+5oDOlKUBEhISok4AFNKUoCn0gH61xY9B+5plpAP1nFv0H7mgM6UpQFSX5cSK2HJT7bKCcBS1BIz7mqtZ3GNGbLsl5tlA6qWoJA/mg89KUrKUpSgKUpSgKUpSgKUpSgKUpSgKUpSgKUpSgKUpSgKUpSgKkYlR5SVqYeQ4ELKFbVBWFDqD7io+pGJUeUlSmHkOBCyitqCthHUH3FAY0pSgP//Z";

        return (
             <>
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex flex-col sm:flex-row items-center gap-8">
                        <div className="flex-shrink-0 text-center">
                            <img src={wechatQrCodeBase64} alt="å®¢æœå¾®ä¿¡" className="w-36 h-36 object-cover rounded-lg shadow-sm mx-auto"/>
                            <p className="text-center text-sm font-semibold mt-2 text-gray-700">æ‰«ç è”ç³»å®¢æœ</p>
                        </div>

                        <div className="flex-grow w-full border-t sm:border-t-0 sm:border-l border-gray-200 pt-6 sm:pt-0 sm:pl-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">æ¬¢è¿, {user.username}</h2>
                            
                            <div className="mb-6">
                                <h3 className="font-semibold text-gray-700">å’¨è¯¢å¸ˆæ·»åŠ å£ä»¤</h3>
                                <p className="text-xs text-gray-500 mt-1">è¯·å°†æ­¤å£ä»¤æä¾›ç»™æ‚¨çš„å’¨è¯¢å¸ˆï¼Œä»¥ä¾¿ä»–ä»¬å°†æ‚¨æ·»åŠ åˆ°ä»–ä»¬çš„æ¡£æ¡ˆä¸­ã€‚è¯·å‹¿æ³„éœ²ç»™ä»–äººã€‚</p>
                                <div className="mt-2 bg-blue-50 text-blue-800 font-mono text-lg tracking-widest p-3 rounded-md text-center">
                                    {clientProfile && clientProfile.binding_code}
                                </div>
                            </div>

                            <div>
                                <h3 className="font-semibold text-gray-700">è”ç³»ä¿¡æ¯</h3>
                                <p className="text-sm text-gray-600 mt-1">å¦‚é‡é—®é¢˜ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š<span className="font-semibold text-gray-800">JieHuaJiJiu_</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="bg-white p-6 rounded-lg shadow-md">
                       <h2 className="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">æˆ‘çš„å’¨è¯¢å¸ˆ</h2>
                        {assignedCounselor ? (
                            <div>
                               <h3 className="text-lg font-bold text-blue-700">{assignedCounselor.name}</h3>
                               <p className="text-sm text-gray-600 mt-1">{assignedCounselor.modality}</p>
                               {assignedCounselor.contactInfo && <p className="text-xs text-gray-500 mt-1">è”ç³»æ–¹å¼: {assignedCounselor.contactInfo}</p>}
                            </div>
                        ) : <p className="text-gray-500">æ‚¨ç›®å‰æœªåˆ†é…å’¨è¯¢å¸ˆã€‚</p>}
                    </div>

                     <div className="bg-white p-6 rounded-lg shadow-md">
                       <h2 className="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">å’¨è¯¢ç»Ÿè®¡</h2>
                       <div className="space-y-3">
                            <p><strong>æ€»ç¡®è®¤æ—¶é•¿:</strong> {totalHours} å°æ—¶</p>
                            <p><strong>è¿‘ä¸€ä¸ªæœˆç¡®è®¤æ—¶é•¿:</strong> {monthlyHours} å°æ—¶</p>
                       </div>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-xl font-semibold text-gray-700 mb-4 border-b pb-3">æˆ‘çš„æ—¥å†</h2>
                    <div className="space-y-3">
                        {clientAppointments.length > 0 ? (
                            clientAppointments.sort((a, b) => new Date(a.date) - new Date(b.date)).map(appt => {
                                const statusMap = {
                                    pending: { text: 'å¾…ç¡®è®¤', color: 'yellow' },
                                    confirmed: { text: 'å·²ç¡®è®¤', color: 'blue' },
                                    rejected: { text: 'å·²æ‹’ç»', color: 'red' },
                                };
                                const status = statusMap[appt.status] || { text: appt.status, color: 'gray' };
                                return (
                                <div key={appt.id} className={`border-l-4 p-3 rounded-r-lg bg-${status.color}-50 border-${status.color}-500`}>
                                    <div className="flex justify-between items-center">
                                        <p className={`font-bold text-${status.color}-800`}>{appt.date} - {appt.time}</p>
                                        <span className={`px-2 py-1 text-xs font-semibold rounded-full bg-${status.color}-200 text-${status.color}-800`}>{status.text}</span>
                                    </div>
                                    <p className="text-sm text-gray-600">ä¸ {allData.counselors.find(c => c.id === appt.counselorId)?.name || 'å’¨è¯¢å¸ˆ'} çš„å’¨è¯¢</p>
                                    {appt.location && <p className="text-xs text-gray-500">åœ°ç‚¹: {appt.location}</p>}
                                    {appt.status === 'rejected' && <p className="text-xs text-red-600 mt-1">è¯¥é¢„çº¦å·²è¢«æ‹’ç»ï¼Œè¯·è”ç³»å®¢æœæˆ–é‡æ–°é¢„çº¦ã€‚</p>}
                                </div>
                                );
                            })
                        ) : (
                            <p className="text-gray-500 text-center py-4">æ‚¨ç›®å‰æ²¡æœ‰å·²å®‰æ’çš„å’¨è¯¢ã€‚</p>
                        )}
                    </div>
                </div>
             </>
        );
    };

    const CounselorDirectoryTab = ({ counselors }) => {
        const defaultAvatar = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0idy02IGgtNiI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMTguMzg0IDE0LjgzM2ExLjk5MiAxLjk5MiAwIDAgMSAuMjMyIDEuOTI1bC0uMDE4LjA2NS0yLjY3IDEuOTI0YTEuMzg3IDEuMzg3IDAgMCAwLS41MiAxLjA3M2wwIC4wODQuMDA4LjE5MmMwIC4zOTQtLjE1Ni43NjktLjQzMyAxLjA0NmEuOTkuOTkgMCAwIDEtMS4wNDYuNDMzSDkuNDYyYS45OS45OSAwIDAgMS0xLjA0Ni0uNDMzIDEuNSAxLjUgMCAwIDEtLjQzMy0xLjA0NmwzLjMxLTEwLjYxMmExLjEyNSAxLjEyNSAwIDAgMSAxLjA1NC0uODI1aC4xNThjLjQ3OCAwIC45LjMxNCAxLjA1NC44MjVsMy4zMSAxMC42MTJjMCAuMzA0LjAxLjYwMi4wMzMuODg3bC4wMDYuMDYyYS44MzIuODMyIDAgMCAwIC4xOTQuNTM4IDEuNTIgMS41MiAwIDAgMCAuMjk4LjQxNmMyLjU0MS0xLjgzNCAzLjkxOC00Ljc4MyA0LjM2My03LjQ2MmEuNzUuNzUgMCAxIDAgMS40NjYtLjQzN0MxOS43MjUgMTIuNTQ0IDE4LjA4IDE2LjgxIDE1LjEyIDE5LjU5M2ExLjUgMS41IDAgMCAxLTEuNTY0LjQxSDkuNDYyYTEuNSAxLjUgMCAwIDEtMS41NjQtLjQxQzUuMjE4IDE2LjgxIDMuNTcgMTIuNTQ0IDMuMDMgOS45MDhhLjc1Ljc1IDAgMCAwLTEuNDY2LjQzN2MuNDQ1IDIuNzc5IDEuODI4IDUuNjI4IDQuMzY0IDcuNDYyYTEuNTIgMS41MiAwIDAgMCAuMjk4LS40MTYuODMyLjgzMiAwIDAgMCAuMTk0LS41MzhsLjAwNS0uMDYyYTEuNDkzIDEuNDkzIDAgMCAxIC4wMzQtLjg4N0w5LjE2IDUuMzA0YTEuODc1IDQuMjUgMCAwIDEgMy4xMS0yLjU1NGguMTU3YzEuNTkxIDAgMy4wMTUgMS4wMzYgMy41MiAyLjU1NGwzLjQzNyAxMS4wMmEuOTk5Ljk5OSAwIDAgMC0uNTItMS4wNzNsLTIuNjctMS45MjRhLjk5Mi45OTIgMCAwIDEtLjIzMi0xLjkyNWwuMDE4LS4wNjVjLjMyNy0uOTIzIDEuMjM0LTEuNDUgMi4yMzYtMS4xOTJsLjE1Ny4wNzdjLjk2OC4yNDQgMS42MjggMS4xMTIgMS43MDcgMi4xMDlsLjAxLjE2WiIgY2xpcC1ydWxlPSJldmVub2RkIiAvPjwvc3ZnPg==";
        return (
            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-2xl font-semibold text-gray-700 mb-6 border-b pb-4">å’¨è¯¢å¸ˆåå½•</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {counselors.map(c => (
                        <div key={c.id} className="bg-gray-50 p-4 rounded-lg border flex gap-4">
                            <img src={c.photo_base64 || defaultAvatar} alt={c.name} className="w-24 h-24 rounded-full object-cover border-2 border-white shadow-md"/>
                            <div className="flex-grow">
                                <h3 className="text-xl font-bold text-blue-700">{c.name}</h3>
                                <p className="text-sm text-gray-500">{c.gender}, {c.age}å², {c.university}</p>
                                <p className="text-sm font-semibold text-gray-700 mt-2">{c.modality}</p>
                                <p className="text-xs text-gray-600 mt-2 whitespace-pre-wrap">{c.statement || 'è¯¥å’¨è¯¢å¸ˆæš‚æœªå¡«å†™ä¸ªäººé™ˆè¿°ã€‚'}</p>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const ClientBookingTab = ({ clientProfile, appointments, counselors, showAlert, fetchData }) => {
        const { useState } = React;
        const [bookingData, setBookingData] = useState({
            date: new Date().toISOString().split('T')[0],
            time: '09:00',
            location: 'x1',
            counselorId: counselors.length > 0 ? counselors[0].id : '',
            notes: ''
        });

        const handleChange = (e) => {
            const { name, value } = e.target;
            setBookingData(prev => ({...prev, [name]: value}));
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!bookingData.counselorId) {
                showAlert('è¯·é€‰æ‹©ä¸€ä½å’¨è¯¢å¸ˆã€‚');
                return;
            }
            try {
                const response = await fetch('/api/client/request_appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...bookingData,
                        clientId: clientProfile.id,
                    }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
                showAlert(data.message);
                fetchData(); // Refresh appointments list
            } catch (err) {
                showAlert(`é¢„çº¦å¤±è´¥: ${err.message}`);
            }
        };

        const confirmedAppointments = appointments.filter(a => a.status === 'confirmed');

        return (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">é¢„çº¦æ–°å’¨è¯¢</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium">é€‰æ‹©å’¨è¯¢å¸ˆ</label><select name="counselorId" value={bookingData.counselorId} onChange={handleChange} required className="w-full p-2 border rounded-md">{counselors.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="block text-sm font-medium">é€‰æ‹©æ—¥æœŸ</label><input type="date" name="date" value={bookingData.date} onChange={handleChange} required className="w-full p-2 border rounded-md"/></div>
                        <div><label className="block text-sm font-medium">é€‰æ‹©æ—¶é—´</label><input type="time" name="time" value={bookingData.time} onChange={handleChange} required className="w-full p-2 border rounded-md" step="3600"/></div>
                        <div><label className="block text-sm font-medium">é€‰æ‹©åœ°ç‚¹</label><select name="location" value={bookingData.location} onChange={handleChange} required className="w-full p-2 border rounded-md"><option value="x1">å’¨è¯¢å®¤ x1</option><option value="x2">å’¨è¯¢å®¤ x2</option><option value="x3">å’¨è¯¢å®¤ x3</option><option value="çº¿ä¸Š">çº¿ä¸Š</option></select></div>
                        <div><label className="block text-sm font-medium">å¤‡æ³¨ (å¯é€‰)</label><textarea name="notes" value={bookingData.notes} onChange={handleChange} rows="2" className="w-full p-2 border rounded-md" placeholder="å¯ä»¥ç®€å•è¯´æ˜æ‚¨æƒ³è®¨è®ºçš„ä¸»é¢˜..."></textarea></div>
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">å‘é€é¢„çº¦è¯·æ±‚</button>
                    </form>
                </div>
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">å¹³å°æ—¥ç¨‹å ç”¨æƒ…å†µ</h2>
                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                        {confirmedAppointments.length > 0 ? (
                            confirmedAppointments.sort((a,b) => new Date(a.date) - new Date(b.date) || a.time.localeCompare(b.time)).map(appt => (
                                <div key={appt.id} className="bg-gray-100 p-2 rounded">
                                    <p className="font-semibold text-sm text-gray-700">{appt.date} {appt.time}</p>
                                    <p className="text-xs text-gray-500">å’¨è¯¢å¸ˆ {counselors.find(c => c.id === appt.counselorId)?.name} åœ¨ {appt.location} å·²è¢«é¢„çº¦</p>
                                </div>
                            ))
                        ) : (
                            <p className="text-center text-gray-500 py-10">å½“å‰æ²¡æœ‰å·²ç¡®è®¤çš„é¢„çº¦ã€‚</p>
                        )}
                    </div>
                </div>
            </div>
        );
    };


    // ================================================================================================
    // ================================== COUNSELOR PORTAL START ======================================
    // ================================================================================================
     const CounselorPortal = ({ user, initialData, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage, fetchData }) => {
        const { useState, useEffect, useCallback } = React;
        const [activeSection, setActiveSection] = useState('schedule');
        const [selectedClient, setSelectedClient] = useState(null);
        
        const [counselorData, setCounselorData] = useState(initialData);
        useEffect(() => { setCounselorData(initialData) }, [initialData]);

        const handleUpdateClient = (updatedClientData, callback) => {
            const newClients = [...counselorData.clients];
            const clientIndex = newClients.findIndex(c => c.id === updatedClientData.id);

            if (clientIndex > -1) {
                newClients[clientIndex] = updatedClientData;
            } else {
                // This case happens when adding a new client
                newClients.push(updatedClientData);
            }
            
            const fullDataToSave = {
                clients: newClients, // Send the full, updated client list
            };
            
            setCounselorData(prev => ({...prev, clients: newClients}));
            setSelectedClient(updatedClientData);

            fetch(`/api/data/counselor/${user.username}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullDataToSave),
            })
            .then(res => res.json())
            .then(data => { 
                if(!data.message.includes("æˆåŠŸ")) showAlert("ä¿å­˜å¤±è´¥"); 
                else if(callback) callback(updatedClientData); 
                fetchData(); // Refresh all data after successful save
            })
            .catch(err => showAlert("ä¿å­˜å¤±è´¥: " + err.message));
        };

        const handleUpdateAppointments = (appointmentData, isDelete = false) => {
            let updatedAppointments;
            if (isDelete) {
                updatedAppointments = counselorData.appointments.filter(appt => appt.id !== appointmentData.id);
            } else {
                const existingIndex = counselorData.appointments.findIndex(appt => appt.id === appointmentData.id);
                updatedAppointments = [...counselorData.appointments];
                if (existingIndex > -1) {
                    updatedAppointments[existingIndex] = appointmentData;
                } else {
                   updatedAppointments = [...updatedAppointments, {...appointmentData, id: `appt-${Date.now()}`, status: 'confirmed'}];
                }
            }
            const fullDataToSave = {
                appointments: updatedAppointments
            };

            setCounselorData(prev => ({...prev, appointments: updatedAppointments}));

            fetch(`/api/data/counselor/${user.username}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullDataToSave),
            }).then(res => { if(!res.ok) showAlert("æ—¥ç¨‹ä¿å­˜å¤±è´¥"); else fetchData(); });
        };
        
        const handleSaveSelfProfile = async (profileData) => {
            const payload = { update_profile: profileData };
            try {
                 const response = await fetch(`/api/data/counselor/${user.username}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || "ä¿å­˜å¤±è´¥");
                }
                showAlert("æ‚¨çš„ä¸ªäººä¿¡æ¯å·²æ›´æ–°ã€‚");
                fetchData(); // Refresh data to show changes
            } catch(e) {
                showAlert("ä¿å­˜å¤±è´¥: " + e.message);
            }
        };

        const handleSelectClient = (client) => { setSelectedClient(client); setActiveSection('clientDetail'); };
        
        const navItems = [
            { id: 'clientManagement', label: 'æ¥è®¿è€…ç®¡ç†', icon: 'ğŸ‘¥' },
            { id: 'counselorManagement', label: 'å’¨è¯¢å¸ˆä¿¡æ¯', icon: 'ğŸ§‘â€ğŸ«' },
            { id: 'schedule', label: 'å’¨è¯¢æ—¥ç¨‹', icon: 'ğŸ—“ï¸' },
            { id: 'cbtApplication', label: 'è¾…åŠ©å·¥å…·', icon: 'ğŸ§ ' }
        ];

        const renderSection = () => {
            if (!counselorData) {
                return <div className="text-center p-10 text-gray-600 font-semibold">æ­£åœ¨åŠ è½½...</div>;
            }
            const assignedClients = counselorData.clients.filter(client => {
                const self = counselorData.counselors.find(c => c.username === user.username);
                return self && self.assignedClientIds?.includes(client.id);
            });

            switch (activeSection) {
            case 'clientManagement':
                const self = counselorData.counselors.find(c => c.username === user.username);
                return <ClientManagementSection 
                          clients={assignedClients}
                          onSelectClient={handleSelectClient} 
                          onUpdateClient={handleUpdateClient}
                          isManagerView={false}
                          showAlert={showAlert}
                          counselorId={self?.id}
                          fetchData={fetchData}
                       />;
            case 'counselorManagement':
                return <CounselorManagementSection 
                          counselors={counselorData.counselors}
                          clients={counselorData.clients} 
                          appointments={counselorData.appointments} 
                          currentUser={user}
                          onSaveProfile={handleSaveSelfProfile}
                          isManagerView={false}
                       />;
            case 'schedule':
                return <ScheduleSection 
                          appointments={counselorData.appointments} 
                          clients={counselorData.clients}  // Pass all clients
                          counselors={counselorData.counselors} // Pass all counselors
                          onUpdateAppointments={handleUpdateAppointments}
                          isManagerView={false}
                          currentUser={user}
                          fetchData={fetchData}
                          showAlert={showAlert}
                       />;
            case 'clientDetail':
                return selectedClient ? 
                       <ClientDetailView 
                          key={selectedClient.id + JSON.stringify(selectedClient.sessions)} 
                          client={selectedClient} 
                          allClients={counselorData.clients} 
                          onUpdateClient={handleUpdateClient} 
                          globalLoadingMessage={globalLoadingMessage}
                          setGlobalLoadingMessage={setGlobalLoadingMessage}
                          showAlert={showAlert}
                        /> : 
                       <div className="text-center p-10 text-gray-500">è¯·å…ˆä»â€œæ¥è®¿è€…ç®¡ç†â€é¡µé¢é€‰æ‹©ä¸€ä½æ¥è®¿è€…ã€‚</div>;
            case 'cbtApplication':
                return <CBTSection showAlert={showAlert}/>;
            default:
                return <ScheduleSection appointments={counselorData.appointments} clients={counselorData.clients} counselors={counselorData.counselors} onUpdateAppointments={handleUpdateAppointments} isManagerView={false} currentUser={user} fetchData={fetchData} showAlert={showAlert} />;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
              <header className="bg-white shadow-sm sticky top-0 z-40"><div className="container mx-auto px-4"><div className="flex items-center justify-between h-16">
              <button onClick={() => setActiveSection('schedule')} className="flex items-center cursor-pointer">
                <span className="text-2xl mr-3">ğŸ’Œ</span>
                <h1 className="text-xl font-bold text-gray-800">å’¨è¯¢å¸ˆå·¥ä½œå°</h1>
              </button>
              <div className="flex items-center gap-4">
                <nav className="hidden md:flex items-center space-x-1">
                    {navItems.map(item => (
                        <button 
                            key={item.id} 
                            onClick={()=>setActiveSection(item.id)} 
                            className={`px-3 py-2 rounded-md text-sm font-medium flex items-center transition-colors duration-200 ${activeSection === item.id || (activeSection === 'clientDetail' && item.id === 'clientManagement') ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}
                        >
                            <span className="mr-2">{item.icon}</span>{item.label}
                        </button>
                    ))}
                </nav>
                <div className="border-l pl-4 flex items-center gap-2">
                    <span className="text-sm text-gray-500 hidden lg:inline">{user.username}</span>
                    <button onClick={onLogout} className="text-sm font-medium text-gray-500 hover:text-red-600">ç™»å‡º</button>
                </div>
               </div>
              </div></div></header>
              {globalLoadingMessage && (<div className="bg-yellow-100 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center sticky top-16 z-30"><span className="mr-2">â³</span>{globalLoadingMessage}</div>)}
              <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
            </div>
        );
    };

    // ================================================================================================
    // ====================================== SHARED COMPONENTS =======================================
    // ================================================================================================

    const BindingCodeModal = ({ onVerify, onClose, showAlert }) => {
        const { useState } = React;
        const [code, setCode] = useState('');
        const [isLoading, setIsLoading] = useState(false);

        const handleVerify = async () => {
            if (!code || code.trim().length !== 6) {
                showAlert('è¯·è¾“å…¥ä¸€ä¸ª6ä½æ•°çš„æ·»åŠ å£ä»¤ã€‚');
                return;
            }
            setIsLoading(true);
            try {
                const res = await fetch('/api/counselor/verify_client_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ binding_code: code.toUpperCase() })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'éªŒè¯å¤±è´¥');
                onVerify(data); // Pass the matched client data
            } catch(err) {
                showAlert(`éªŒè¯å¤±è´¥: ${err.message}`);
                setIsLoading(false);
            }
        };

        return (
            <div className="custom-modal-backdrop">
                <div className="custom-modal-content">
                    <h3 className="text-xl font-semibold mb-2">æ·»åŠ æ¥è®¿è€…</h3>
                    <p className="text-sm text-gray-600 mb-4">è¯·è¾“å…¥æ¥è®¿è€…çš„6ä½æ·»åŠ å£ä»¤ä»¥è¿›è¡ŒåŒ¹é…ã€‚</p>
                    <input 
                        type="text"
                        placeholder="æ·»åŠ å£ä»¤"
                        maxLength="6"
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        className="p-2 border rounded-md w-full text-center tracking-widest font-mono"
                        disabled={isLoading}
                    />
                     <div className="flex justify-center items-center gap-4 mt-6">
                        <button onClick={onClose} disabled={isLoading} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border disabled:opacity-50">å–æ¶ˆ</button>
                        <button onClick={handleVerify} disabled={isLoading} className="px-6 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md disabled:opacity-50">
                            {isLoading ? 'éªŒè¯ä¸­...' : 'éªŒè¯å¹¶æ·»åŠ '}
                        </button>
                    </div>
                </div>
            </div>
        );
    };
    
    // REQ 3: Updated Counselor Profile Edit Form
    const CounselorSelfEditForm = ({ counselor, onSave, onCancel }) => {
        const { useState } = React;
        const [formData, setFormData] = useState({
            name: counselor?.name || '',
            modality: counselor?.modality || '',
            clinicalBackground: counselor?.clinicalBackground || '',
            contactInfo: counselor?.contactInfo || '',
            age: counselor?.age || '',
            gender: counselor?.gender || 'æœªé€éœ²',
            university: counselor?.university || '',
            statement: counselor?.statement || '',
            photo_base64: counselor?.photo_base64 || null,
        });

        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({...prev, [name]: value}));
        };

        const handlePhotoUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setFormData(prev => ({ ...prev, photo_base64: reader.result }));
                };
                reader.readAsDataURL(file);
            }
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.name.trim()) {
                alert('å§“åæ˜¯å¿…å¡«é¡¹ã€‚');
                return;
            }
            onSave(formData);
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn mt-8">
                <h3 className="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">ç¼–è¾‘æˆ‘çš„æ¡£æ¡ˆ</h3>
                <form onSubmit={handleSubmit} className="space-y-4 max-w-lg mx-auto">
                     <div className="flex items-center gap-4">
                        <img src={formData.photo_base64 || 'https://via.placeholder.com/100'} alt="Profile" className="w-24 h-24 rounded-full object-cover"/>
                        <div>
                            <label className="block text-sm font-medium">ä¸Šä¼ æ–°ç…§ç‰‡</label>
                            <input type="file" accept="image/*" onChange={handlePhotoUpload} className="text-xs file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium">å§“å <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                        <div><label className="block text-sm font-medium">è”ç³»æ–¹å¼</label><input type="text" name="contactInfo" value={formData.contactInfo} onChange={handleChange} className="w-full p-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šemail@example.com"/></div>
                        <div><label className="block text-sm font-medium">å¹´é¾„</label><input type="number" name="age" value={formData.age} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                        <div><label className="block text-sm font-medium">æ€§åˆ«</label><select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-2 border rounded-md"><option>æœªé€éœ²</option><option>ç”·</option><option>å¥³</option><option>å…¶ä»–</option></select></div>
                    </div>
                    <div><label className="block text-sm font-medium">å°±è¯»/æ¯•ä¸šé™¢æ ¡</label><input type="text" name="university" value={formData.university} onChange={handleChange} className="w-full p-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸ˆèŒƒå¤§å­¦"/></div>
                    <div><label className="block text-sm font-medium">æ“…é•¿å’¨è¯¢æµæ´¾</label><input type="text" name="modality" value={formData.modality} onChange={handleChange} className="w-full p-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šCBT, ç²¾ç¥åŠ¨åŠ›å­¦"/></div>
                    <div><label className="block text-sm font-medium">ä¸ªäººé™ˆè¿°</label><textarea name="statement" value={formData.statement} onChange={handleChange} rows="3" className="w-full p-2 border rounded-md" placeholder="ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±ï¼Œå¸®åŠ©æ¥è®¿è€…æ›´å¥½åœ°äº†è§£æ‚¨..."></textarea></div>
                    <div><label className="block text-sm font-medium">ä¸´åºŠå’Œå­¦æœ¯èƒŒæ™¯</label><textarea name="clinicalBackground" value={formData.clinicalBackground} onChange={handleChange} rows="4" className="w-full p-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šXXå¤§å­¦ä¸´åºŠå¿ƒç†å­¦ç¡•å£«ï¼ŒXXåŒ»é™¢å®ä¹ ç»éªŒ"></textarea></div>
                    
                    <div className="flex justify-end space-x-3 pt-4 border-t mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">å–æ¶ˆ</button>
                        <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm"><span className="mr-2">ğŸ’¾</span>ä¿å­˜æ¡£æ¡ˆ</button>
                    </div>
                </form>
            </div>
        );
    };


    const CounselorManagementSection = ({ counselors, clients, appointments, onUpdateCounselors, onDeleteCounselor, onSaveUser, currentUser, isManagerView, onSaveProfile }) => {
        const { useState, useMemo } = React;
        const [view, setView] = useState('list'); 
        const [counselorToEdit, setCounselorToEdit] = useState(null);
        const [isEditingSelf, setIsEditingSelf] = useState(false);
        
        const counselorsWithHours = useMemo(() => {
            if(!counselors) return [];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            return counselors.map(counselor => {
                const confirmedAppointments = appointments.filter(a => a.status === 'confirmed');
                const monthlyHours = confirmedAppointments.filter(appt => {
                    if (!appt.date) return false;
                    const apptDate = new Date(appt.date);
                    return appt.counselorId === counselor.id &&
                           apptDate.getMonth() === currentMonth &&
                           apptDate.getFullYear() === currentYear;
                }).length;
                const totalHours = confirmedAppointments.filter(appt => appt.counselorId === counselor.id).length;
                return { ...counselor, monthlyHours, totalHours };
            });
        }, [counselors, appointments]);

        if (view === 'form' && isManagerView) {
            return <CounselorForm 
                onSave={(counselorData, password) => {
                    let updatedList;
                    if (counselorToEdit) {
                        updatedList = counselors.map(c => c.id === counselorToEdit.id ? { ...c, ...counselorData } : c);
                    } else {
                        updatedList = [...counselors, { ...counselorData, id: `counselor-${Date.now()}`, assignedClientIds: counselorData.assignedClientIds || [] }];
                    }
                    onUpdateCounselors(updatedList);
                    if(isManagerView && password) {
                        onSaveUser(counselorData.username, password, 'counselor', !counselorToEdit);
                    }
                    setView('list');
                }}
                onCancel={() => setView('list')}
                counselorToEdit={counselorToEdit}
                allClients={clients}
                isManagerView={isManagerView}
            />
        }
        
        const openEditForm = (counselor) => { setCounselorToEdit(counselor); setView('form'); };
        
        const loggedInCounselor = !isManagerView ? counselorsWithHours.find(c => c.username === currentUser.username) : null;
        const otherCounselors = !isManagerView ? counselorsWithHours.filter(c => c.username !== currentUser.username) : counselorsWithHours;
        const defaultAvatar = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0idy02IGgtNiI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMTguMzg0IDE0LjgzM2ExLjk5MiAxLjk5MiAwIDAgMSAuMjMyIDEuOTI1bC0uMDE4LjA2NS0yLjY3IDEuOTI0YTEuMzg3IDEuMzg3IDAgMCAwLS41MiAxLjA3M2wwIC4wODQuMDA4LjE5MmMwIC4zOTQtLjE1Ni43NjktLjQzMyAxLjA0NmEuOTkuOTkgMCAwIDEtMS4wNDYuNDMzSDkuNDYyYS45OS45OSAwIDAgMS0xLjA0Ni0uNDMzIDEuNSAxLjUgMCAwIDEtLjQzMy0xLjA0NmwzLjMxLTEwLjYxMmExLjEyNSAxLjEyNSAwIDAgMSAxLjA1NC0uODI1aC4xNThjLjQ3OCAwIC45LjMxNCAxLjA1NC44MjVsMy4zMSAxMC42MTJjMCAuMzA0LjAxLjYwMi4wMzMuODg3bC4wMDYuMDYyYS44MzIuODMyIDAgMCAwIC4xOTQuNTM4IDEuNTIgMS41MiAwIDAgMCAuMjk4LjQxNmMyLjU0MS0xLjgzNCAzLjkxOC00Ljc4MyA0LjM2My03LjQ2MmEuNzUuNzUgMCAxIDAgMS40NjYtLjQzN0MxOS43MjUgMTIuNTQ0IDE4LjA4IDE2LjgxIDE1LjEyIDE5LjU5M2ExLjUgMS41IDAgMCAxLTEuNTY0LjQxSDkuNDYyYTEuNSAxLjUgMCAwIDEtMS41NjQtLjQxQzUuMjE4IDE2LjgxIDMuNTcgMTIuNTQ0IDMuMDMgOS45MDhhLjc1Ljc1IDAgMCAwLTEuNDY2LjQzN2MuNDQ1IDIuNzc5IDEuODI4IDUuNjI4IDQuMzY0IDcuNDYyYTEuNTIgMS41MiAwIDAgMCAuMjk4LS40MTYuODMyLjgzMiAwIDAgMCAuMTk0LS41MzhsLjAwNS0uMDYyYTEuNDkzIDEuNDkzIDAgMCAxIC4wMzQtLjg4N0w5LjE2IDUuMzA0YTEuODc1IDQuMjUgMCAwIDEgMy4xMS0yLjU1NGguMTU3YzEuNTkxIDAgMy4wMTUgMS4wMzYgMy41MiAyLjU1NGwzLjQzNyAxMS4wMmEuOTk5Ljk5OSAwIDAgMC0uNTItMS4wNzNsLTIuNjctMS45MjRhLjk5Mi45OTIgMCAwIDEtLjIzMi0xLjkyNWwuMDE4LS4wNjVjLjMyNy0uOTIzIDEuMjM0LTEuNDUgMi4yMzYtMS4xOTJsLjE1soy4wNzdjLjk2OC4yNDQgMS42MjggMS4xMTIgMS43MDcgMi4xMDlsLjAxLjE2WiIgY2xpcC1ydWxlPSJldmVub2RkIiAvPjwvc3ZnPg==";


        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                    <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">ğŸ§‘â€ğŸ«</span>{isManagerView ? 'å’¨è¯¢å¸ˆç®¡ç†' : 'å’¨è¯¢å¸ˆä¿¡æ¯'}</h2>
                    {isManagerView && <button onClick={() => { setCounselorToEdit(null); setView('form'); }} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm"><span className="mr-2">â•</span>æ·»åŠ å’¨è¯¢å¸ˆ</button>}
                </div>

                {loggedInCounselor && (
                  <div className="mb-8">
                    <h3 className="text-xl font-semibold text-gray-800 mb-4">æˆ‘çš„æ¡£æ¡ˆ</h3>
                     {isEditingSelf ? (
                        <CounselorSelfEditForm 
                            counselor={loggedInCounselor}
                            onSave={(profileData) => {
                                onSaveProfile(profileData);
                                setIsEditingSelf(false);
                            }}
                            onCancel={() => setIsEditingSelf(false)}
                        />
                     ) : (
                        <div className="bg-blue-50 border rounded-lg p-4">
                            <div className="flex justify-between items-start">
                               <div className="flex gap-4 items-start">
                                    <img src={loggedInCounselor.photo_base64 || defaultAvatar} alt={loggedInCounselor.name} className="w-24 h-24 rounded-full object-cover border-2 border-white shadow-md"/>
                                    <div>
                                        <div className="flex items-center gap-4">
                                            <h3 className="text-xl font-bold text-blue-700">{loggedInCounselor.name}</h3>
                                            <button onClick={() => setIsEditingSelf(true)} className="text-xs font-medium text-blue-600 hover:underline">(ç¼–è¾‘)</button>
                                        </div>
                                        <p className="text-sm text-gray-600 mt-1">{loggedInCounselor.modality}</p>
                                        {loggedInCounselor.contactInfo && <p className="text-sm text-gray-500 mt-2"><b>è”ç³»æ–¹å¼:</b> {loggedInCounselor.contactInfo}</p>}
                                        {loggedInCounselor.statement && <p className="text-sm text-gray-600 mt-2 italic">"{loggedInCounselor.statement}"</p>}
                                    </div>
                               </div>
                               <div className="text-right flex gap-4">
                                   <div><p className="text-sm text-gray-600">æœ¬æœˆ</p><p className="text-2xl font-bold text-blue-800">{loggedInCounselor.monthlyHours} <span className="text-base font-normal">å°æ—¶</span></p></div>
                                   <div><p className="text-sm text-gray-600">æ€»è®¡</p><p className="text-2xl font-bold text-gray-800">{loggedInCounselor.totalHours} <span className="text-base font-normal">å°æ—¶</span></p></div>
                               </div>
                            </div>
                            <h4 className="text-sm font-bold text-gray-700 mt-4 border-t pt-3">è´Ÿè´£æ¥è®¿:</h4>
                            <div className="flex flex-wrap gap-2 mt-2">{clients.filter(c => loggedInCounselor.assignedClientIds?.includes(c.id)).map(client => <span key={client.id} className="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">{client.name}</span>)}</div>
                        </div>
                     )}
                  </div>
                )}
                
                {otherCounselors.length > 0 && <h3 className="text-xl font-semibold text-gray-800 mb-4 pt-6 border-t">{!isManagerView ? "å…¶ä»–å’¨è¯¢å¸ˆ" : "æ‰€æœ‰å’¨è¯¢å¸ˆ"}</h3>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {otherCounselors.map(counselor => {
                        const assignedClients = clients.filter(client => counselor.assignedClientIds?.includes(client.id));
                        return (
                            <div key={counselor.id} className="bg-gray-50 border rounded-lg p-4 flex flex-col">
                                <div className="flex-grow">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-3 items-start">
                                            <img src={counselor.photo_base64 || defaultAvatar} alt={counselor.name} className="w-16 h-16 rounded-full object-cover"/>
                                            <div>
                                                <h3 className="text-xl font-bold text-blue-700">{counselor.name}</h3>
                                                <p className="text-sm text-gray-600 mt-1">{counselor.modality}</p>
                                                <p className="text-xs text-gray-500 mt-1">ç”¨æˆ·å: {counselor.username}</p>
                                            </div>
                                        </div>
                                        <div className="text-right flex gap-4">
                                            <div><p className="text-sm text-gray-600">æœ¬æœˆ</p><p className="text-2xl font-bold text-blue-800">{counselor.monthlyHours} <span className="text-base font-normal">å°æ—¶</span></p></div>
                                            <div><p className="text-sm text-gray-600">æ€»è®¡</p><p className="text-2xl font-bold text-gray-800">{counselor.totalHours} <span className="text-base font-normal">å°æ—¶</span></p></div>
                                        </div>
                                    </div>
                                    
                                    {isManagerView && <>
                                        <h4 className="text-sm font-bold text-gray-700 mt-4 border-t pt-3">è´Ÿè´£æ¥è®¿:</h4>
                                        {assignedClients.length > 0 ? (
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {assignedClients.map(client => <span key={client.id} className="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">{client.name}</span>)}
                                            </div>
                                        ) : <p className="text-xs text-gray-500 mt-2">æš‚æ— </p>}
                                    </>}
                                </div>
                                {isManagerView && <div className="flex justify-end space-x-2 mt-4 pt-4 border-t">
                                    <button onClick={() => openEditForm(counselor)} className="text-xs font-medium text-blue-600 hover:underline">ç¼–è¾‘</button>
                                    <button onClick={() => onDeleteCounselor(counselor.id)} className="text-xs font-medium text-red-600 hover:underline">åˆ é™¤</button>
                                </div>}
                            </div>
                        )
                    })}
                </div>
                 {counselors.length === 0 && isManagerView && <p className="text-center text-gray-500 py-8">æš‚æ— å’¨è¯¢å¸ˆä¿¡æ¯ã€‚ç‚¹å‡»â€œæ·»åŠ å’¨è¯¢å¸ˆâ€å¼€å§‹ã€‚</p>}
            </div>
        );
    };
    
    const CounselorForm = ({ onSave, onCancel, counselorToEdit, allClients, isManagerView }) => {
        const { useState } = React;
        const [formData, setFormData] = useState({
            name: counselorToEdit?.name || '',
            modality: counselorToEdit?.modality || '',
            username: counselorToEdit?.username || '',
            assignedClientIds: counselorToEdit?.assignedClientIds || [],
            clinicalBackground: counselorToEdit?.clinicalBackground || '',
            contactInfo: counselorToEdit?.contactInfo || '',
        });
        const [password, setPassword] = useState('');
        
        const handleClientSelection = (clientId) => {
             setFormData(prev => {
                const newIds = prev.assignedClientIds.includes(clientId)
                    ? prev.assignedClientIds.filter(id => id !== clientId)
                    : [...prev.assignedClientIds, clientId];
                return {...prev, assignedClientIds: newIds};
            });
        };

        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({...prev, [name]: value}));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.name.trim() || !formData.username.trim()) { alert('å§“åå’Œç”¨æˆ·åå‡ä¸ºå¿…å¡«é¡¹ã€‚'); return; }
            if (isManagerView && !counselorToEdit && !password) { alert('ä¸ºæ–°å’¨è¯¢å¸ˆè®¾ç½®åˆå§‹å¯†ç ã€‚'); return; }
            onSave(formData, password);
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
              <div className="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 className="text-2xl font-semibold text-gray-700">{counselorToEdit ? 'ç¼–è¾‘' : 'æ·»åŠ '}å’¨è¯¢å¸ˆ</h3>
                <button onClick={onCancel} className="text-sm font-medium text-gray-600 hover:text-gray-900">â† è¿”å›åˆ—è¡¨</button>
              </div>
                <form onSubmit={handleSubmit} className="space-y-4 max-w-lg mx-auto">
                  <div><label className="block text-sm font-medium">å§“å <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                  <div><label className="block text-sm font-medium">ç”¨æˆ·å (ç”¨äºç™»å½•) <span className="text-red-500">*</span></label><input type="text" name="username" value={formData.username} onChange={handleChange} required className="w-full p-2 border rounded-md" disabled={!!counselorToEdit} /></div>
                  {isManagerView && <div><label className="block text-sm font-medium">å¯†ç  {counselorToEdit ? '(ç•™ç©ºå³ä¸ä¿®æ”¹)' : <span className="text-red-500">*</span>}</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-2 border rounded-md" /></div>}
                  <div><label className="block text-sm font-medium">è”ç³»æ–¹å¼</label><input type="text" name="contactInfo" value={formData.contactInfo} onChange={handleChange} className="w-full p-2 border rounded-md"/></div>
                  <div><label className="block text-sm font-medium">æ“…é•¿å’¨è¯¢æµæ´¾</label><input type="text" name="modality" value={formData.modality} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                  <div><label className="block text-sm font-medium">ä¸´åºŠå’Œå­¦æœ¯èƒŒæ™¯</label><textarea name="clinicalBackground" value={formData.clinicalBackground} onChange={handleChange} rows="3" className="w-full p-2 border rounded-md"></textarea></div>

                  {isManagerView && <div>
                    <label className="block text-sm font-medium">è´Ÿè´£æ¥è®¿ (å¯ç‚¹å‡»é€‰æ‹©)</label>
                    <div className="max-h-32 overflow-y-auto border rounded-md p-2 mt-1 select-none">
                        {allClients.map(client => (
                            <div 
                                key={client.id} 
                                onClick={() => handleClientSelection(client.id)}
                                className={`p-1 rounded cursor-pointer ${formData.assignedClientIds.includes(client.id) ? 'bg-blue-200' : 'hover:bg-gray-100'}`}
                            >
                                <span className="text-sm text-gray-800">{client.name}</span>
                            </div>
                        ))}
                         {allClients.length === 0 && <p className="text-xs text-gray-400 text-center py-2">æš‚æ— æ¥è®¿è€…</p>}
                    </div>
                  </div>}

                  <div className="flex justify-end space-x-3 pt-4 border-t mt-6">
                    <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">å–æ¶ˆ</button>
                    <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm">
                        <span className="mr-2">ğŸ’¾</span>ä¿å­˜
                    </button>
                  </div>
                </form>
            </div>
        );
    };

    const ScheduleSection = ({ appointments, clients, counselors, onUpdateAppointments, isManagerView, currentUser, fetchData, showAlert }) => {
        const { useState } = React;
        const [view, setView] = useState('daily'); // 'daily', 'overview', 'form'
        const [appointmentToEdit, setAppointmentToEdit] = useState(null);
        
        const handleRespondRequest = async (appointmentId, status) => {
             try {
                const res = await fetch('/api/counselor/respond_appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId, status, counselorUsername: currentUser.username })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'æ“ä½œå¤±è´¥');
                showAlert(data.message);
                fetchData();
             } catch(err) {
                showAlert(`æ“ä½œå¤±è´¥: ${err.message}`);
             }
        };

        if (view === 'form') {
            return (
                <AppointmentForm
                    onSave={(appointmentData) => {
                        onUpdateAppointments(appointmentData);
                        setView('daily');
                    }}
                    onCancel={() => setView('daily')}
                    onDelete={(appointmentData) => {
                        onUpdateAppointments(appointmentData, true);
                        setView('daily');
                    }}
                    appointmentToEdit={appointmentToEdit}
                    clients={clients}
                    counselors={counselors}
                    isManagerView={isManagerView}
                />
            )
        }
        
        const pendingAppointments = appointments.filter(a => a.status === 'pending' && (isManagerView || counselors.find(c => c.id === a.counselorId)?.username === currentUser.username));

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                   <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">ğŸ—“ï¸</span>å’¨è¯¢æ—¥ç¨‹</h2>
                   <div className="flex items-center gap-4">
                       <div className="flex items-center bg-gray-100 rounded-lg p-1">
                           <button onClick={() => setView('daily')} className={`px-3 py-1 text-sm rounded-md ${view === 'daily' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'}`}>æ¯æ—¥è§†å›¾</button>
                           <button onClick={() => setView('overview')} className={`px-3 py-1 text-sm rounded-md ${view === 'overview' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'}`}>ä¸‰æœˆæ€»è§ˆ</button>
                       </div>
                       <button onClick={() => { setAppointmentToEdit(null); setView('form');}} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm"><span className="mr-2">â•</span>æ·»åŠ æ—¥ç¨‹</button>
                   </div>
                </div>

                {!isManagerView && pendingAppointments.length > 0 && (
                    <div className="mb-6">
                        <h3 className="text-xl font-semibold text-yellow-700 mb-3">å¾…å¤„ç†è¯·æ±‚ ({pendingAppointments.length})</h3>
                        <div className="space-y-3">
                        {pendingAppointments.map(appt => (
                            <div key={appt.id} className="bg-yellow-50 border border-yellow-300 p-3 rounded-lg">
                                <p className="font-semibold">{clients.find(c => c.id === appt.clientId)?.name} è¯·æ±‚åœ¨ {appt.date} {appt.time} äº {appt.location} è¿›è¡Œå’¨è¯¢ã€‚</p>
                                <div className="flex gap-2 mt-2">
                                    <button onClick={() => handleRespondRequest(appt.id, 'confirmed')} className="text-xs bg-green-600 text-white font-bold py-1 px-3 rounded">æ¥å—</button>
                                    <button onClick={() => handleRespondRequest(appt.id, 'rejected')} className="text-xs bg-red-600 text-white font-bold py-1 px-3 rounded">æ‹’ç»</button>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">æ‹’ç»åï¼Œè¯·é€šè¿‡å®¢æœè”ç³»æ¥è®¿è€…è¯´æ˜æƒ…å†µå¹¶åå•†æ–°æ—¶é—´ã€‚</p>
                            </div>
                        ))}
                        </div>
                    </div>
                )}
                
                {view === 'daily' && 
                    <ScheduleDailyView 
                        appointments={appointments}
                        clients={clients}
                        counselors={counselors}
                        onSelectAppointment={(appt) => { setAppointmentToEdit(appt); setView('form'); }}
                    />
                }

                {view === 'overview' && <ScheduleOverview appointments={appointments} /> }

            </div>
        );
    };
    
    const ScheduleDailyView = ({ appointments, clients, counselors, onSelectAppointment }) => {
        const { useState, useMemo } = React;
        const [currentDate, setCurrentDate] = useState(new Date());

        const changeDay = (offset) => {
            setCurrentDate(prev => {
                const newDate = new Date(prev);
                newDate.setDate(prev.getDate() + offset);
                return newDate;
            });
        };
        
        const appointmentsByHour = useMemo(() => {
            const dateStr = currentDate.toISOString().split('T')[0];
            const filtered = appointments.filter(appt => appt.date === dateStr);
            const grouped = {};
            filtered.forEach(appt => {
                const hour = appt.time.substring(0, 2);
                if (!grouped[hour]) {
                    grouped[hour] = [];
                }
                grouped[hour].push(appt);
            });
            return grouped;
        }, [appointments, currentDate]);

        const renderHourlySchedule = () => {
            const hours = Array.from({length: 15}, (_, i) => 8 + i); // 8:00 to 22:00

            return hours.map(hour => {
                const hourStr = String(hour).padStart(2, '0');
                const hourAppointments = appointmentsByHour[hourStr] || [];
                
                return (
                    <tr key={hour} className="border-b">
                        <td className="p-2 w-24 text-center text-sm text-gray-500 align-top">{hourStr}:00</td>
                        <td className="p-1">
                          <div className="time-slot">
                            {hourAppointments.length > 0 ? (
                                hourAppointments.map(appointment => {
                                    const statusMap = {
                                        pending: { bgColor: 'bg-yellow-100', borderColor: 'border-yellow-500', textColor: 'text-yellow-800' },
                                        confirmed: { bgColor: 'bg-blue-100', borderColor: 'border-blue-500', textColor: 'text-blue-800' },
                                        rejected: { bgColor: 'bg-red-100', borderColor: 'border-red-500', textColor: 'text-red-800' },
                                    };
                                    const style = statusMap[appointment.status] || { bgColor: 'bg-gray-100', borderColor: 'border-gray-500', textColor: 'text-gray-800' };
                                    return (
                                    <div key={appointment.id} className={`${style.bgColor} ${style.borderColor} border-l-4 p-2 rounded-r-lg cursor-pointer hover:brightness-95`} onClick={() => onSelectAppointment(appointment)}>
                                        <p className={`font-bold text-sm ${style.textColor}`}>{clients.find(c => c.id === appointment.clientId)?.name}</p>
                                        <p className="text-xs text-gray-600">å’¨è¯¢å¸ˆ: {counselors.find(c => c.id === appointment.counselorId)?.name}</p>
                                        {appointment.location && <p className="text-xs text-gray-600">åœ°ç‚¹: {appointment.location}</p>}
                                        {appointment.notes && <p className="text-xs text-gray-500 mt-1 italic">"{appointment.notes}"</p>}
                                        {appointment.status !== 'confirmed' && <p className="text-xs font-bold mt-1 uppercase">{appointment.status}</p>}
                                    </div>
                                    )
                                })
                            ) : (<div className="h-10"></div>)}
                          </div>
                        </td>
                    </tr>
                );
            });
        };

        return (
            <div>
                 <div className="flex justify-between items-center mb-4">
                    <button onClick={() => changeDay(-1)} className="p-2 rounded-md hover:bg-gray-100">â® å‰ä¸€å¤©</button>
                    <h3 className="text-xl font-semibold text-gray-700">{currentDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    <button onClick={() => changeDay(1)} className="p-2 rounded-md hover:bg-gray-100">åä¸€å¤© â¯</button>
                </div>
                <div className="border rounded-lg overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="p-2 w-24 text-sm font-medium text-gray-600">æ—¶é—´</th>
                                <th className="p-2 text-sm font-medium text-gray-600 text-left">å®‰æ’</th>
                            </tr>
                        </thead>
                        <tbody>
                            {renderHourlySchedule()}
                        </tbody>
                    </table>
                </div>
            </div>
        )
    };

    const ScheduleOverview = ({ appointments }) => {
        const { useMemo } = React;
        const confirmedAppointments = appointments.filter(a => a.status === 'confirmed');
        const appointmentsByDate = useMemo(() => {
            return confirmedAppointments.reduce((acc, appt) => {
                if(appt.date) {
                    (acc[appt.date] = acc[appt.date] || []).push(appt);
                }
                return acc;
            }, {});
        }, [confirmedAppointments]);

        const renderMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            
            for (let i = 0; i < firstDay; i++) {
                days.push(<div key={`empty-${i}`} className="border-t border-l"></div>);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointmentsByDate[dateStr] || [];
                const appointmentCount = dayAppointments.length;
                const counselorCount = new Set(dayAppointments.map(a => a.counselorId)).size;
                const isToday = new Date(dateStr).toDateString() === new Date().toDateString();

                days.push(
                    <div key={day} className="border-t border-l p-1 text-sm h-24 flex flex-col">
                        <div className={`self-start ${isToday ? 'bg-blue-600 text-white rounded-full h-6 w-6 flex items-center justify-center' : ''}`}>{day}</div>
                        {appointmentCount > 0 && 
                            <div className="flex-grow flex flex-col items-end justify-end gap-1 text-xs font-bold p-1">
                                <div className="flex items-center gap-1">
                                  <span className="text-blue-600" title="å•æ—¥å’¨è¯¢æ•°é‡">{appointmentCount}</span>
                                  <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                                </div>
                                <div className="flex items-center gap-1">
                                  <span className="text-green-600" title="åœ¨å²—å’¨è¯¢å¸ˆæ•°é‡">{counselorCount}</span>
                                  <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                </div>
                            </div>
                        }
                    </div>
                );
            }
            return (
                <div>
                    <h3 className="text-lg font-semibold text-center mb-2">{date.toLocaleDateString('zh-CN', { month: 'long', year: 'numeric' })}</h3>
                    <div className="grid grid-cols-7 text-xs text-center border-r border-b">
                         {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d} className="border-t border-l font-bold p-1 bg-gray-50">{d}</div>)}
                         {days}
                    </div>
                </div>
            )
        };
        
        const today = new Date();
        const month1 = new Date(today.getFullYear(), today.getMonth(), 1);
        const month2 = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        const month3 = new Date(today.getFullYear(), today.getMonth() + 2, 1);
        
        return (
            <div>
                <div className="flex justify-end gap-4 text-xs mb-2">
                    <span><span className="font-bold text-blue-600">â– </span> å•æ—¥ç¡®è®¤å’¨è¯¢æ•°</span>
                    <span><span className="font-bold text-green-600">â– </span> åœ¨å²—å’¨è¯¢å¸ˆæ•°</span>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {renderMonth(month1)}
                    {renderMonth(month2)}
                    {renderMonth(month3)}
                </div>
            </div>
        );
    };
    
    const AppointmentForm = ({ onSave, onCancel, onDelete, appointmentToEdit, clients, counselors, isManagerView }) => {
        const { useState } = React;
        const [formData, setFormData] = useState({
            id: appointmentToEdit?.id || null,
            date: appointmentToEdit?.date || new Date().toISOString().split('T')[0],
            time: appointmentToEdit?.time || '09:00',
            location: appointmentToEdit?.location || 'çº¿ä¸Š',
            clientId: appointmentToEdit?.clientId || (clients[0]?.id || ''),
            counselorId: appointmentToEdit?.counselorId || (counselors[0]?.id || ''),
            notes: appointmentToEdit?.notes || '',
            status: appointmentToEdit?.status || 'confirmed'
        });
        
        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({...prev, [name]: value}));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.clientId || !formData.counselorId) {
                alert('è¯·é€‰æ‹©æ¥è®¿è€…å’Œå’¨è¯¢å¸ˆ');
                return;
            }
            // For managers/counselors, new appointments are auto-confirmed
            onSave({...formData, status: appointmentToEdit?.status || 'confirmed'});
        };
        
        const handleDeleteClick = () => {
             if (window.confirm('ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å®‰æ’å—?')) {
                 onDelete(formData);
             }
        }

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-4 pb-4 border-b">
                    <h3 className="text-2xl font-semibold text-gray-700">{appointmentToEdit ? 'ç¼–è¾‘' : 'æ·»åŠ '}æ—¥ç¨‹</h3>
                    <button onClick={onCancel} className="text-sm font-medium text-gray-600 hover:text-gray-900">â† è¿”å›æ—¥ç¨‹</button>
                </div>
                <form onSubmit={handleSubmit} className="space-y-4 max-w-lg mx-auto">
                    <div><label className="block text-sm font-medium">æ—¥æœŸ</label><input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full p-2 border rounded-md"/></div>
                    <div><label className="block text-sm font-medium">æ—¶é—´</label><input type="time" name="time" value={formData.time} onChange={handleChange} required className="w-full p-2 border rounded-md" step="3600"/></div>
                    <div><label className="block text-sm font-medium">å’¨è¯¢åœ°ç‚¹</label><select name="location" value={formData.location} onChange={handleChange} required className="w-full p-2 border rounded-md"><option value="x1">å’¨è¯¢å®¤ x1</option><option value="x2">å’¨è¯¢å®¤ x2</option><option value="x3">å’¨è¯¢å®¤ x3</option><option value="çº¿ä¸Š">çº¿ä¸Š</option></select></div>
                    <div><label className="block text-sm font-medium">æ¥è®¿è€…</label><select name="clientId" value={formData.clientId} onChange={handleChange} required className="w-full p-2 border rounded-md">{clients && clients.length > 0 ? clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>) : <option disabled>è¯·å…ˆæ·»åŠ æ¥è®¿è€…</option>}</select></div>
                    <div><label className="block text-sm font-medium">å’¨è¯¢å¸ˆ</label><select name="counselorId" value={formData.counselorId} onChange={handleChange} required className="w-full p-2 border rounded-md">{counselors && counselors.length > 0 ? counselors.map(c => <option key={c.id} value={c.id}>{c.name}</option>) : <option disabled>è¯·å…ˆæ·»åŠ å’¨è¯¢å¸ˆ</option>}</select></div>
                    <div><label className="block text-sm font-medium">å¤‡æ³¨</label><textarea name="notes" value={formData.notes} onChange={handleChange} rows="3" className="w-full p-2 border rounded-md"></textarea></div>
                    {isManagerView && <div><label className="block text-sm font-medium">çŠ¶æ€</label><select name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded-md"><option value="pending">å¾…ç¡®è®¤</option><option value="confirmed">å·²ç¡®è®¤</option><option value="rejected">å·²æ‹’ç»</option></select></div>}
                    <div className="flex justify-between items-center pt-4 border-t mt-6">
                       {appointmentToEdit && <button type="button" onClick={handleDeleteClick} className="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-md shadow-sm">åˆ é™¤</button>}
                       <div className="flex-grow flex justify-end space-x-3">
                           <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">å–æ¶ˆ</button>
                           <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm"><span className="mr-2">ğŸ’¾</span>ä¿å­˜</button>
                       </div>
                    </div>
                </form>
            </div>
        );
    };

    const ClientManagementSection = ({ clients, onSelectClient, isManagerView, onUpdateClient, onDeleteClient, onSaveUser, selectedClient, onClientDetailBack, setGlobalLoadingMessage, showAlert, counselorId, fetchData }) => {
        const { useState } = React;
        const [view, setView] = useState('list');
        const [searchTerm, setSearchTerm] = useState('');
        const [clientToEdit, setClientToEdit] = useState(null);
        const [isBindingModalOpen, setIsBindingModalOpen] = useState(false);

        const handleVerifySuccess = (matchedClient) => {
            setClientToEdit(matchedClient);
            setIsBindingModalOpen(false);
            setView('form');
        };

        const handleSaveClient = (clientData) => {
            const finalClientData = { ...clientData };
            const isNewAssignment = !clients.some(c => c.id === clientData.id);

            // If it's a new assignment, ensure the counselorId is added to the assigned list
            if (isNewAssignment && !isManagerView) {
                 if (!finalClientData.assignedCounselorIds) {
                    finalClientData.assignedCounselorIds = [];
                 }
                 if (!finalClientData.assignedCounselorIds.includes(counselorId)) {
                    finalClientData.assignedCounselorIds.push(counselorId);
                 }
            }
            onUpdateClient(finalClientData);
            setView('list');
        };

        if (selectedClient && isManagerView) {
            return <ClientDetailView 
                        key={selectedClient.id + JSON.stringify(selectedClient.sessions)} 
                        client={selectedClient} 
                        allClients={clients} 
                        onUpdateClient={onUpdateClient} 
                        onDeleteClient={onDeleteClient}
                        onBack={onClientDetailBack}
                        setGlobalLoadingMessage={setGlobalLoadingMessage}
                        showAlert={showAlert}
                        isManagerView={isManagerView}
                    />;
        }

        if (view === 'form') {
            return (
                <ClientForm 
                    onSave={handleSaveClient}
                    onCancel={() => setView('list')}
                    clientToEdit={clientToEdit}
                    allClients={clients}
                    isManagerView={isManagerView}
                />
            )
        }

        const filteredClients = clients.filter(client => client.name.toLowerCase().includes(searchTerm.toLowerCase()));
        
        const title = isManagerView ? 'æ¥è®¿è€…ç®¡ç†' : 'æˆ‘çš„æ¥è®¿è€…';
        
        return (
            <>
            {isBindingModalOpen && (
                <BindingCodeModal
                    onVerify={handleVerifySuccess}
                    onClose={() => setIsBindingModalOpen(false)}
                    showAlert={showAlert}
                />
            )}
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                    <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">ğŸ‘¥</span>{title}</h2>
                    <button onClick={() => isManagerView ? setView('form') : setIsBindingModalOpen(true) } className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm">
                        <span className="mr-2">â•</span>æ·»åŠ æ–°æ¥è®¿
                    </button>
                </div>
                <input type="text" placeholder="æœç´¢æ¥è®¿è€…å§“å..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 mb-4 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                {filteredClients.length > 0 ? (
                    <ul className="space-y-3">{filteredClients.map(client => (<li key={client.id} onClick={() => onSelectClient(client)} className="bg-gray-50 hover:bg-blue-50 border rounded-lg p-4 cursor-pointer flex justify-between items-center transition-all duration-200 hover:shadow-md"><div><p className="text-lg font-medium text-blue-700">{client.name} <span className="text-sm text-gray-500">({client.gender}, {client.age}å²)</span></p><p className="text-sm text-gray-600">åŠ å…¥æ—¥æœŸ: {client.joinDate}</p></div><span className="text-gray-400 font-bold">â¯</span></li>))}</ul>
                ) : <p className="text-center text-gray-500 py-8">æš‚æ— åŒ¹é…çš„æ¥è®¿è€…ã€‚{isManagerView ? 'ç‚¹å‡»â€œæ·»åŠ æ–°æ¥è®¿â€å¼€å§‹ã€‚' : 'æ‚¨ç›®å‰æ²¡æœ‰è´Ÿè´£çš„æ¥è®¿è€…, ç‚¹å‡»æŒ‰é’®é€šè¿‡å£ä»¤æ·»åŠ ã€‚'}</p>}
            </div>
            </>
        );
    };

    const ClientForm = ({ onSave, onCancel, clientToEdit, allClients, isManagerView }) => {
      const { useState } = React;
      const [formData, setFormData] = useState({
        name: clientToEdit?.name || '', age: clientToEdit?.age || '', gender: clientToEdit?.gender || 'æœªé€éœ²',
        grade: clientToEdit?.grade || '', sexualOrientation: clientToEdit?.sexualOrientation || '',
        contact: clientToEdit?.contact || '', referredBy: clientToEdit?.referredBy || '',
        historyOfIllness: clientToEdit?.historyOfIllness || '', mentalStateScore: clientToEdit?.mentalStateScore || '5',
        disabilityStatus: clientToEdit?.disabilityStatus || '', religiousBelief: clientToEdit?.religiousBelief || '',
        ethnicIdentity: clientToEdit?.ethnicIdentity || '', personalFinance: clientToEdit?.personalFinance || '',
        familyFinance: clientToEdit?.familyFinance || '',
        username: clientToEdit?.username || '',
      });
      const [password, setPassword] = useState('');
      const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
      
      const handleSubmit = (e) => {
        e.preventDefault(); 
        if (!formData.name.trim() || !formData.age) { alert('å§“åå’Œå¹´é¾„ä¸ºå¿…å¡«é¡¹ã€‚'); return; }
        if (isManagerView && !clientToEdit && !formData.username.trim()) { alert('å¿…é¡»ä¸ºæ–°æ¥è®¿è€…è®¾ç½®ä¸€ä¸ªç”¨æˆ·åã€‚'); return; }
        
        const clientData = { ...clientToEdit, ...formData, age: parseInt(formData.age), referredBy: formData.referredBy || null };
        onSave(clientData, password);
      };
      
      const potentialReferrers = allClients ? allClients.filter(c => c.id !== clientToEdit?.id) : [];
      
      return (
        <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
            <div className="flex justify-between items-center mb-6 pb-4 border-b">
                <h3 className="text-2xl font-semibold text-gray-700">{clientToEdit && !isManagerView ? 'ç¡®è®¤å¹¶ç¼–è¾‘æ¥è®¿è€…ä¿¡æ¯' : (clientToEdit ? 'ç¼–è¾‘' : 'æ·»åŠ ')+'æ¥è®¿è€…ä¿¡æ¯'}</h3>
                <button onClick={onCancel} className="text-sm font-medium text-gray-600 hover:text-gray-900">â† è¿”å›</button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label className="block text-sm font-medium">å§“å <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å¹´é¾„ <span className="text-red-500">*</span></label><input type="number" name="age" value={formData.age} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                {isManagerView && <>
                  <div><label className="block text-sm font-medium">ç”¨æˆ·å (ç”¨äºç™»å½•) <span className="text-red-500">*</span></label><input type="text" name="username" value={formData.username} onChange={handleChange} required className="w-full p-2 border rounded-md" disabled={!!clientToEdit} /></div>
                  <div><label className="block text-sm font-medium">å¯†ç  {clientToEdit ? '(ç•™ç©ºå³ä¸ä¿®æ”¹)' : '(å¯é€‰)'}</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border rounded-md" /></div>
                </>}
                <div><label className="block text-sm font-medium">æ€§åˆ«</label><select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-2 border rounded-md"><option>æœªé€éœ²</option><option>ç”·</option><option>å¥³</option><option>å…¶ä»–</option></select></div>
                <div><label className="block text-sm font-medium">åœ¨è¯»å¹´çº§/èŒä¸š</label><input type="text" name="grade" value={formData.grade} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">æ€§å–å‘</label><input type="text" name="sexualOrientation" value={formData.sexualOrientation} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">è”ç³»æ–¹å¼</label><input type="text" name="contact" value={formData.contact} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">è½¬ä»‹ç»æ¥æº</label><select name="referredBy" value={formData.referredBy || ''} onChange={handleChange} className="w-full p-2 border rounded-md"><option value="">æ— </option>{potentialReferrers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div><label className="block text-sm font-medium">å¿ƒç†çŠ¶æ€è¯„åˆ†(1-10)</label><select name="mentalStateScore" value={formData.mentalStateScore} onChange={handleChange} className="w-full p-2 border rounded-md">{[...Array(10).keys()].map(i => <option key={i+1} value={i+1}>{i+1}</option>)}</select></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">æ—¢å¾€ç—…å²</label><textarea name="historyOfIllness" value={formData.historyOfIllness} onChange={handleChange} rows="2" className="w-full p-2 border rounded-md" ></textarea></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">æ®‹éšœæƒ…å†µ</label><input type="text" name="disabilityStatus" value={formData.disabilityStatus} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å®—æ•™ä¿¡ä»°</label><input type="text" name="religiousBelief" value={formData.religiousBelief} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">ç§æ—è®¤åŒ</label><input type="text" name="ethnicIdentity" value={formData.ethnicIdentity} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">ä¸ªäººç»æµ</label><input type="text" name="personalFinance" value={formData.personalFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å®¶åº­ç»æµ</label><input type="text" name="familyFinance" value={formData.familyFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
              </div>
              <div className="flex justify-end space-x-3 pt-4 border-t mt-6">
                  <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">å–æ¶ˆ</button>
                  <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm">
                    <span className="mr-2">ğŸ’¾</span>{clientToEdit ? 'ä¿å­˜æ›´æ”¹' : 'æ·»åŠ æ¥è®¿è€…'}
                  </button>
              </div>
            </form>
        </div>
      );
    };

    const ClientDetailView = ({ client, allClients, onUpdateClient, onDeleteClient, globalLoadingMessage, setGlobalLoadingMessage, showAlert, onBack, isManagerView = false }) => {
      const { useState } = React;
      const [isEditing, setIsEditing] = useState(false);
      
      if (isEditing) {
          return <ClientForm 
            clientToEdit={client}
            allClients={allClients}
            onSave={(clientData) => {
                onUpdateClient({ ...client, ...clientData });
                setIsEditing(false);
            }}
            onCancel={() => setIsEditing(false)}
            isManagerView={isManagerView}
          />
      }

      return (
        <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
          <div className="flex flex-col md:flex-row justify-between md:items-center mb-4 pb-4 border-b gap-4">
            <div className="flex items-center">
              {!isManagerView && <button onClick={() => window.history.back()} className="text-sm font-medium text-gray-600 hover:text-gray-900 mr-4">â† è¿”å›åˆ—è¡¨</button>}
              {isManagerView && onBack && <button onClick={onBack} className="text-sm font-medium text-gray-600 hover:text-gray-900 mr-4">â† è¿”å›åˆ—è¡¨</button>}
              <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-3xl">ğŸ‘¤</span>{client.name} - æ¡£æ¡ˆä¸­å¿ƒ</h2>
            </div>
            <div>
              <button onClick={() => setIsEditing(true)} className="text-sm font-medium text-blue-600 hover:text-blue-800 mr-4 flex items-center"><span className="mr-1">âœï¸</span>ç¼–è¾‘</button>
              {isManagerView && <button onClick={() => {if(window.confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¥è®¿è€…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {onDeleteClient(client.id)}}} className="text-sm font-medium text-red-600 hover:text-red-800 flex items-center"><span className="mr-1">ğŸ—‘ï¸</span>åˆ é™¤</button>}
            </div>
          </div>
          <ClientProfileTabs client={client} allClients={allClients} onUpdateClient={onUpdateClient} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} showAlert={showAlert} />
        </div>
      );
    };

    const ClientProfileTabs = ({ client, allClients, onUpdateClient, globalLoadingMessage, setGlobalLoadingMessage, showAlert }) => {
        const { useState, useRef } = React;
        const [activeTab, setActiveTab] = useState('profile');
        const tabs = [{ id: 'profile', label: 'æ¡£æ¡ˆä¸ä¼šè¯', icon: 'ğŸ‘¤' }, { id: 'conceptualization', label: 'AIä¸ªæ¡ˆæ¦‚å¿µåŒ–', icon: 'ğŸ“œ' },{ id: 'analysis', label: 'æ¥è®¿è€…è¯„ä¼°', icon: 'ğŸ“Š' }, { id: 'supervision', label: 'AIç£å¯¼', icon: 'ğŸ”¬' }];
      
        const readFileAsText = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => resolve(event.target.result);
                reader.onerror = error => reject(error);
                reader.readAsText(file, 'UTF-8');
            });
        };
      
        const triggerAiGeneration = async (currentClient, sessionId, transcriptContent, transcriptName) => {
            setGlobalLoadingMessage(`æ­£åœ¨ä¸º ${currentClient.name} ç”ŸæˆAIæŠ¥å‘Š...`);
            const session = currentClient.sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            try {
                const clientInfoForPrompt = { ...currentClient };
                delete clientInfoForPrompt.sessions;

                const [conceptualizationRes, assessmentRes] = await Promise.all([
                    fetch('/api/ai/conceptualization', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ client_info: clientInfoForPrompt, transcript_content: transcriptContent })
                    }),
                    fetch('/api/ai/assessment', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ client_info: clientInfoForPrompt, transcript_content: transcriptContent })
                    })
                ]);

                if (!conceptualizationRes.ok) {
                    const errData = await conceptualizationRes.json();
                    throw new Error(`ä¸ªæ¡ˆæ¦‚å¿µåŒ–å¤±è´¥: ${errData.error || conceptualizationRes.statusText}`);
                }
                if (!assessmentRes.ok) {
                    const errData = await assessmentRes.json();
                    throw new Error(`æ¥è®¿è€…è¯„ä¼°å¤±è´¥: ${errData.error || assessmentRes.statusText}`);
                }

                const conceptualization = await conceptualizationRes.json();
                const assessment = await assessmentRes.json();
                
                if(conceptualization.status === 'Error' || assessment.status === 'Error'){
                    throw new Error(`AIæŠ¥å‘Šç”ŸæˆåŒ…å«é”™è¯¯: \næ¦‚å¿µåŒ–: ${conceptualization.error || 'OK'}\nè¯„ä¼°: ${assessment.error || 'OK'}`);
                }

                const updatedClient = JSON.parse(JSON.stringify(currentClient));
                const sIndex = updatedClient.sessions.findIndex(s => s.id === sessionId);
                updatedClient.sessions[sIndex].transcript = { name: transcriptName, content: transcriptContent };
                updatedClient.sessions[sIndex].conceptualization = conceptualization;
                updatedClient.sessions[sIndex].assessment = assessment;
                
                onUpdateClient(updatedClient, (finalClient) => {
                  showAlert('AIæŠ¥å‘Šå·²æˆåŠŸç”Ÿæˆï¼');
                });
                

            } catch (error) {
                showAlert(`AIæŠ¥å‘Šç”Ÿæˆå¤±è´¥: ${error.message}`);
            } finally {
                setGlobalLoadingMessage('');
            }
        };

      const handleAddSession = (newSessionData) => {
        const newSession = { id: `session-${client.id}-${Date.now()}`, ...newSessionData, transcript: null, conceptualization: { status: 'Pending' }, assessment: { status: 'Pending' }, supervision: { status: 'Pending', conceptualizationUploaded: null, assessmentUploaded: null, content: null } };
        onUpdateClient({ ...client, sessions: [...(client.sessions || []), newSession] });
      };

      const handle
