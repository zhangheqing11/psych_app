<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒç†å’¨è¯¢å¸ˆåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    .custom-modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .custom-modal-content {
      background: white; padding: 2rem; border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center; max-width: 90%; width: 450px;
    }
    .custom-modal-button {
      margin-top: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
      border: none; background-color: #3B82F6; color: white;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s;
    }
    .custom-modal-button:hover { background-color: #2563EB; }
    .time-slot { display: flex; flex-direction: column; gap: 4px; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const App = () => {
      // ... (App component state and functions like useEffect, fetchData, saveData remain largely the same)
      const { useState, useEffect, useCallback } = React;
      
      const [appData, setAppData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [currentUser, setCurrentUser] = useState(null);

      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');
      const [alertInfo, setAlertInfo] = useState({ show: false, message: '' });

      useEffect(() => {
        const persistedUser = localStorage.getItem('currentUser');
        if (persistedUser) {
          try {
            setCurrentUser(JSON.parse(persistedUser));
          } catch(e) {
            console.error("Failed to parse user from localStorage", e);
            localStorage.removeItem('currentUser');
          }
        }
        setIsLoading(false);
      }, []);

      const showAlert = useCallback((message) => {
        setAlertInfo({ show: true, message });
      }, []);
      
      const fetchData = useCallback(async () => {
        if (!currentUser) {
            setAppData(null);
            setIsLoading(false);
            return;
        }
        setIsLoading(true);
        let dataPath;
        if (currentUser.role === 'manager') {
            dataPath = '/api/data/manager';
        } else if (currentUser.role === 'counselor') {
            dataPath = `/api/data/counselor/${currentUser.username}`;
        } else {
            dataPath = '/api/data/all';
        }
        try {
            const res = await fetch(dataPath);
            if (!res.ok) throw new Error('Failed to fetch data');
            const data = await res.json();
            setAppData(data);
        } catch (error) {
            console.error("Failed to fetch data:", error);
            showAlert("åŠ è½½æ•°æ®å¤±è´¥ã€‚");
        } finally {
            setIsLoading(false);
        }
      }, [currentUser]);
      
      useEffect(() => {
        fetchData();
      }, [fetchData]);

      const saveData = useCallback(async (dataToSave, isClientProfileUpdate = false) => {
          if (!currentUser) return showAlert("è¯·å…ˆç™»å½•ã€‚");
          let url, body;
          if (currentUser.role === 'manager') {
              url = '/api/data/manager';
              body = JSON.stringify(dataToSave);
          } else if (currentUser.role === 'counselor') {
              url = `/api/data/counselor/${currentUser.username}`;
              body = JSON.stringify(dataToSave);
          } else if (currentUser.role === 'client' && isClientProfileUpdate) {
              url = `/api/data/client/${currentUser.username}`;
              body = JSON.stringify(dataToSave);
          } else {
              return showAlert("æ— æƒä¿å­˜æ•°æ®ã€‚");
          }
          try {
              const response = await fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: body,
              });
              if (!response.ok) {
                  const err = await response.json();
                  throw new Error(err.message || "ä¿å­˜å¤±è´¥");
              }
          } catch (error) {
              console.error("Failed to save data:", error);
              showAlert(`ä¿å­˜æ•°æ®å¤±è´¥: ${error.message}`);
          }
      }, [currentUser]);

      // MODIFIED: handleRegister to include registrationKey
      const handleRegister = async (username, password, role, registrationKey) => {
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role, registrationKey }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message);
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch (error) {
            showAlert('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };

      const handleLogin = async (username, password, role) => {
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message);
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch(error) {
            showAlert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };
      
      const handleLogout = () => {
          localStorage.removeItem('currentUser');
          setCurrentUser(null);
          setAppData(null);
      }
      
      const renderPortal = () => {
          if (isLoading || (currentUser && !appData)) {
              return <div className="min-h-screen flex items-center justify-center">æ­£åœ¨åŠ è½½...</div>
          }
          if (!currentUser) {
              return <AuthModal onLogin={handleLogin} onRegister={handleRegister} showAlert={showAlert} />;
          }
          switch (currentUser.role) {
              case 'manager':
                  return <ManagerPortal user={currentUser} allData={appData} setAllData={setAppData} onSave={saveData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} />;
              case 'counselor':
                  return <CounselorPortal user={currentUser} initialData={appData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} fetchData={fetchData} />;
              case 'client':
                  return <ClientPortal user={currentUser} allData={appData} onLogout={handleLogout} onSave={saveData} showAlert={showAlert} />;
              default:
                  return <div className="min-h-screen flex items-center justify-center">æ— æ³•è¯†åˆ«çš„ç”¨æˆ·è§’è‰²ã€‚</div>;
          }
      };

      return (
          <>
            {alertInfo.show && (
              <div className="custom-modal-backdrop animate-fadeIn" onClick={() => setAlertInfo({ show: false, message: '' })}>
                <div className="custom-modal-content" onClick={(e) => e.stopPropagation()}>
                  <p className="text-gray-800">{alertInfo.message}</p>
                  <button className="custom-modal-button" onClick={() => setAlertInfo({ show: false, message: '' })}>å…³é—­</button>
                </div>
              </div>
            )}
            {renderPortal()}
          </>
      );
    };
    
    // --- All Components ---

    // MODIFIED: AuthModal to include registrationKey
    const AuthModal = ({ onLogin, onRegister, showAlert }) => {
        const { useState } = React;
        const [mode, setMode] = useState('login');
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [role, setRole] = useState('counselor');
        const [registrationKey, setRegistrationKey] = useState(''); // New state for registration key

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!username || !password) { showAlert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚'); return; }

            if (mode === 'register') {
              if (password.length < 6) { showAlert('å¯†ç å¿…é¡»è‡³å°‘ä¸º6ä¸ªå­—ç¬¦ã€‚'); return; }
              if (password !== confirmPassword) { showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸åŒ¹é…ï¼'); return; }
              // Pass the registration key if the role is counselor
              await onRegister(username, password, role, role === 'counselor' ? registrationKey : undefined);
            } else {
              await onLogin(username, password, role);
            }
        };
        
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-lg shadow-xl p-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</h2>
                    
                    <div className="flex justify-center mb-6">
                        <div className="bg-gray-200 p-1 rounded-full flex">
                            <button onClick={() => setRole('counselor')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'counselor' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>å’¨è¯¢å¸ˆ/ç®¡ç†</button>
                            <button onClick={() => setRole('client')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'client' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>æ¥è®¿è€…</button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-sm font-medium text-gray-700">ç”¨æˆ·å</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        <div><label className="text-sm font-medium text-gray-700">å¯†ç </label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        {mode === 'register' && (
                          <>
                            <div><label className="text-sm font-medium text-gray-700">ç¡®è®¤å¯†ç </label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required/></div>
                            {role === 'counselor' && ( // Conditionally show registration key input
                                <div><label className="text-sm font-medium text-gray-700">æ³¨å†Œå£ä»¤</label><input type="text" value={registrationKey} onChange={e => setRegistrationKey(e.target.value)} className="w-full p-2 mt-1 border rounded-md" placeholder="å’¨è¯¢å¸ˆ/ç®¡ç†å‘˜éœ€è¦å£ä»¤" required/></div>
                            )}
                          </>
                        )}
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</button>
                    </form>

                    <p className="text-xs text-center text-gray-500 mt-4">
                      {mode === 'login' ? 'æ²¡æœ‰è´¦æˆ·ï¼Ÿ' : 'å·²æœ‰è´¦æˆ·ï¼Ÿ'}
                      <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 hover:underline ml-1">
                        {mode === 'login' ? 'ç‚¹å‡»æ³¨å†Œ' : 'è¿”å›ç™»å½•'}
                      </button>
                    </p>
                </div>
            </div>
        );
    };
    
    // ... ManagerPortal remains the same ...
    const ManagerPortal = ({ user, allData, setAllData, onSave, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage }) => {
        // ... no changes needed here ...
        return <div>Manager Portal Content...</div>
    }

    // MODIFIED: ClientPortal to show assignment key
    const ClientPortal = ({ user, allData, onLogout, onSave, showAlert }) => {
        const { useState, useMemo, useEffect } = React;
        const [isEditing, setIsEditing] = useState(false);
        const [clientProfile, setClientProfile] = useState(null);

        useEffect(() => {
            if (allData && allData.clients) {
                const profile = allData.clients.find(c => c.username === user.username);
                setClientProfile(profile);
            }
        }, [allData, user.username]);

        const assignedCounselor = clientProfile && allData.counselors ? allData.counselors.find(c => c.assignedClientIds?.includes(clientProfile.id)) : null;
        const clientAppointments = clientProfile && allData.appointments ? allData.appointments.filter(a => a.clientId === clientProfile.id) : [];

        // ... (memoized calculations remain same)

        const handleSaveProfile = (updatedProfile) => {
            onSave(updatedProfile, true); 
            setClientProfile(updatedProfile);
            setIsEditing(false);
            showAlert("æ‚¨çš„ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼");
        };

        if (!clientProfile) {
            return <div className="min-h-screen flex items-center justify-center">æ­£åœ¨åŠ è½½æ‚¨çš„ä¿¡æ¯...</div>;
        }

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
              <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="container mx-auto px-4">
                  <div className="flex items-center justify-between h-16">
                    <h1 className="text-xl font-bold text-gray-800">æ¥è®¿è€…é—¨æˆ·</h1>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-500">{user.username}</span>
                      <button onClick={onLogout} className="text-sm font-medium text-red-600 hover:underline">ç™»å‡º</button>
                    </div>
                  </div>
                </div>
              </header>
              <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
                {isEditing ? (
                    <ClientForm 
                        clientToEdit={clientProfile}
                        onSave={handleSaveProfile}
                        onCancel={() => setIsEditing(false)}
                        allClients={allData.clients}
                        isManagerView={false}
                    />
                ) : (
                    <>
                    {/* NEW: Display Assignment Key */}
                    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                      <h3 className="font-bold text-yellow-800">æ‚¨çš„ä¸“å±æ·»åŠ å£ä»¤</h3>
                      <p className="text-sm text-yellow-700 mt-1">è¯·å°†æ­¤å£ä»¤æä¾›ç»™æ‚¨çš„å’¨è¯¢å¸ˆï¼Œä»¥ä¾¿ä»–ä»¬å°†æ‚¨æ·»åŠ åˆ°ç³»ç»Ÿä¸­è¿›è¡Œç®¡ç†ã€‚</p>
                      <p className="mt-2 text-2xl font-mono tracking-widest bg-white inline-block px-4 py-1 rounded border text-gray-800">{clientProfile.assignmentKey}</p>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h2 className="text-xl font-semibold text-gray-700">æˆ‘çš„ä¿¡æ¯</h2>
                            <button onClick={() => setIsEditing(true)} className="text-sm font-medium text-blue-600 hover:underline">ç¼–è¾‘</button>
                        </div>
                        {/* ... (rest of client profile display remains same) ... */}
                    </div>
                    {/* ... (rest of client portal remains same) ... */}
                    </>
                )}
              </main>
            </div>
        );
    }
    
    // ... CounselorPortal remains largely the same, but the components it renders are modified
     const CounselorPortal = ({ user, initialData, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage, fetchData }) => {
        // ... same state and functions
        return <div>Counselor Portal Content...</div>; // Render modified components below
    };

    // MODIFIED: CounselorManagementSection to allow self-editing
    const CounselorManagementSection = ({ counselors, clients, appointments, onUpdateCounselors, onDeleteCounselor, onSaveUser, currentUser, isManagerView, showAlert, fetchData }) => {
        const { useState, useMemo } = React;
        const [view, setView] = useState('list');
        const [counselorToEdit, setCounselorToEdit] = useState(null);
        const [isEditingMyProfile, setIsEditingMyProfile] = useState(false); // New state for self-edit

        // ... (memoized calculations are the same)
        const counselorsWithHours = useMemo(() => { /* ... */ }, [counselors, appointments]);
        
        // New handler for self-profile update
        const handleSaveMyProfile = async (profileData) => {
            try {
                const response = await fetch(`/api/counselor/profile/${currentUser.username}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                showAlert("æ¡£æ¡ˆæ›´æ–°æˆåŠŸï¼");
                setIsEditingMyProfile(false);
                fetchData(); // Refresh data to show changes
            } catch (error) {
                showAlert(`æ›´æ–°å¤±è´¥: ${error.message}`);
            }
        };

        if (view === 'form') { /* ... Manager's form view is the same */ }
        
        if (isEditingMyProfile) {
            const myProfile = counselors.find(c => c.username === currentUser.username);
            return <MyCounselorProfileForm 
                        profile={myProfile} 
                        onSave={handleSaveMyProfile} 
                        onCancel={() => setIsEditingMyProfile(false)} 
                    />
        }
        
        const loggedInCounselor = !isManagerView ? counselorsWithHours.find(c => c.username === currentUser.username) : null;
        const otherCounselors = !isManagerView ? counselorsWithHours.filter(c => c.username !== currentUser.username) : counselorsWithHours;

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                    <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">ğŸ§‘â€ğŸ«</span>{isManagerView ? 'å’¨è¯¢å¸ˆç®¡ç†' : 'å’¨è¯¢å¸ˆä¿¡æ¯'}</h2>
                    {isManagerView && <button onClick={() => { setCounselorToEdit(null); setView('form'); }} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">â• æ·»åŠ å’¨è¯¢å¸ˆ</button>}
                </div>

                {loggedInCounselor && (
                  <div className="mb-8 border-b pb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-semibold text-gray-800">æˆ‘çš„æ¡£æ¡ˆ</h3>
                        <button onClick={() => setIsEditingMyProfile(true)} className="text-sm font-medium text-blue-600 hover:underline">ç¼–è¾‘æ¡£æ¡ˆ</button>
                    </div>
                    <div className="bg-blue-50 border rounded-lg p-4 flex flex-col">
                        <div className="flex justify-between items-start">
                           <div>
                                <h3 className="text-xl font-bold text-blue-700">{loggedInCounselor.name}</h3>
                                <p className="text-sm text-gray-600 mt-1">æ“…é•¿æµæ´¾: {loggedInCounselor.modality || 'æœªå¡«å†™'}</p>
                                <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">èƒŒæ™¯: {loggedInCounselor.clinicalBackground || 'æœªå¡«å†™'}</p>
                           </div>
                           <div className="text-right flex gap-4">
                               {/* ... hours display ... */}
                           </div>
                        </div>
                        <h4 className="text-sm font-bold text-gray-700 mt-4 border-t pt-3">è´Ÿè´£æ¥è®¿:</h4>
                        <div className="flex flex-wrap gap-2 mt-2">{clients.filter(c => loggedInCounselor.assignedClientIds?.includes(c.id)).map(client => <span key={client.id} className="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">{client.name}</span>)}</div>
                    </div>
                  </div>
                )}
                
                {/* ... rest of the component (displaying other counselors) is the same ... */}
            </div>
        );
    };

    // NEW Component: Form for counselor to edit their own profile
    const MyCounselorProfileForm = ({ profile, onSave, onCancel }) => {
        const { useState } = React;
        const [formData, setFormData] = useState({
            name: profile?.name || '',
            modality: profile?.modality || '',
            clinicalBackground: profile?.clinicalBackground || ''
        });
        const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
        const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn max-w-2xl mx-auto">
                <h3 className="text-2xl font-semibold text-gray-700 mb-4">ç¼–è¾‘æˆ‘çš„æ¡£æ¡ˆ</h3>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className="block text-sm font-medium">å§“å</label><input type="text" name="name" value={formData.name} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                    <div><label className="block text-sm font-medium">æ“…é•¿å’¨è¯¢æµæ´¾</label><input type="text" name="modality" value={formData.modality} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                    <div><label className="block text-sm font-medium">ä¸´åºŠå’Œå­¦æœ¯èƒŒæ™¯</label><textarea name="clinicalBackground" value={formData.clinicalBackground} onChange={handleChange} rows="4" className="w-full p-2 border rounded-md"></textarea></div>
                    <div className="flex justify-end space-x-3 pt-4 border-t mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">å–æ¶ˆ</button>
                        <button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md">ä¿å­˜æ›´æ”¹</button>
                    </div>
                </form>
            </div>
        );
    };
    
    // MODIFIED: ClientManagementSection for assignment key workflow
    const ClientManagementSection = ({ clients, unassignedClients, onSelectClient, onUpdateClient, onDeleteClient, onSaveUser, selectedClient, onClientDetailBack, setGlobalLoadingMessage, showAlert, currentUser, fetchData, isManagerView }) => {
        const { useState } = React;
        const [view, setView] = useState('list');
        const [searchTerm, setSearchTerm] = useState('');
        const [clientToEdit, setClientToEdit] = useState(null);
        const [isAssignModalOpen, setIsAssignModalOpen] = useState(false);
        const [assignmentKeys, setAssignmentKeys] = useState({}); // State for keys

        // ... (other parts of the component are the same)

        const handleAssignmentKeyChange = (clientId, key) => {
            setAssignmentKeys(prev => ({ ...prev, [clientId]: key }));
        };
        
        const handleAssignClient = async (clientId) => {
            const key = assignmentKeys[clientId] || '';
            if (key.length < 6) return showAlert('è¯·è¾“å…¥å®Œæ•´çš„6ä½æ·»åŠ å£ä»¤ã€‚');
            try {
                const res = await fetch('/api/counselor/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        counselorUsername: currentUser.username, 
                        clientId,
                        assignmentKey: key
                    }),
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.message || "åˆ†é…å¤±è´¥");
                showAlert('æ¥è®¿è€…å·²æˆåŠŸåˆ†é…åˆ°æ‚¨çš„åä¸‹ï¼');
                setIsAssignModalOpen(false);
                setAssignmentKeys({});
                fetchData(); // Re-fetch data to update lists
            } catch(err) {
                showAlert(err.message);
            }
        };

        const title = isManagerView ? 'æ¥è®¿è€…ç®¡ç†' : 'æˆ‘çš„æ¥è®¿è€…';
        const buttonText = isManagerView ? 'æ·»åŠ æ–°æ¥è®¿' : 'è´Ÿè´£æ–°æ¥è®¿';
        const handleButtonClick = () => {
            if (isManagerView) {
                setClientToEdit(null);
                setView('form');
            } else {
                setIsAssignModalOpen(true);
            }
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                {isAssignModalOpen && (
                    <div className="custom-modal-backdrop">
                        <div className="custom-modal-content w-full max-w-lg">
                            <h3 className="text-xl font-semibold mb-4">è´Ÿè´£æ–°æ¥è®¿</h3>
                            <p className="text-sm text-gray-600 mb-4">è¯·è¾“å…¥æ¥è®¿è€…æä¾›çš„6ä½æ·»åŠ å£ä»¤ä»¥å®Œæˆåˆ†é…ã€‚</p>
                            <div className="max-h-64 overflow-y-auto text-left space-y-2">
                                {unassignedClients.length > 0 ? unassignedClients.map(client => (
                                    <div key={client.id} className="p-2 border rounded-md flex justify-between items-center gap-2">
                                        <span className="flex-shrink-0">{client.name} ({client.age}å²)</span>
                                        <div className="flex-grow flex items-center gap-2">
                                          <input 
                                            type="text" 
                                            maxLength="6"
                                            placeholder="æ·»åŠ å£ä»¤"
                                            value={assignmentKeys[client.id] || ''}
                                            onChange={(e) => handleAssignmentKeyChange(client.id, e.target.value.toUpperCase())}
                                            className="w-full p-1 border rounded-md text-center font-mono tracking-widest"
                                          />
                                          <button onClick={() => handleAssignClient(client.id)} className="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-2 rounded">è´Ÿè´£</button>
                                        </div>
                                    </div>
                                )) : <p className="text-center text-gray-500">å½“å‰æ²¡æœ‰æœªåˆ†é…çš„æ¥è®¿è€…ã€‚</p>}
                            </div>
                            <button onClick={() => setIsAssignModalOpen(false)} className="custom-modal-button bg-gray-500 hover:bg-gray-600">å…³é—­</button>
                        </div>
                    </div>
                )}
                
                {/* ... rest of component is the same ... */}
            </div>
        );
    };

    // ... The rest of the components (ClientForm, ClientDetailView, Tabs, etc.) remain unchanged.

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
