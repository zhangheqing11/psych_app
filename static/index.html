<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>心理咨询师助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    /* Simple modal style for alerts */
    .alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .alert-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 90%;
      width: 400px;
    }
    .alert-modal-button {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      cursor: pointer;
    }
    .time-slot:hover {
        background-color: #eff6ff; /* blue-50 */
        cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    // --- AI PROMPT DEFINITIONS (Ported from app.py) ---
    // These functions contain the detailed instructions for the AI model.
    const getConceptualizationPromptText = () => `你是一位资深的心理咨询师。根据文件中的咨询逐字稿内容以及来访的基本信息，提供个案概念化报告。报告用于辅助另一位咨询师改善自己的咨询服务质量。个案概念化整体上应遵循‘’中的步骤：\n‘\t1.选择一个最适合来访者的理论范式,使用理论假设去指导个案概念化和治疗方案的建构\n\t2.利用一些假设、支持性的材料或结论，作为个案概念化的关键信息\n\t3.概述治疗计划，将长期、短期治疗目标作为发展治疗计划的关键要点。治疗目标的表述让来访可以理解，尽量符合其期望与价值观。\n4.提示咨询师何种表达方式对来访可能是有吸引力的。提示接下来的咨询方向（咨询师该怎样做），包括但不限于哪些话题可能需要被深入讨论和谈论哪些话题可能存在潜在风险。’\n\n关于个案概念化的结构要素和内容，参考{}内的要求：\n{\t1.概要：根据理论视角对来访核心优势和局限的简要分析假设。即对来访的核心印象、总览，以帮助通过阅读个案概念化对个案有大致了解。内容包括：人口学与社会文化等基本信息、问题情况与咨询目标简介。\n\t2.支持性素材：为概要提供细节依据，包括但不限于：1.对来访优势的深度分析（优势的地方、积极的因素、成功、应对策略、技能、促进改变的因子)；2.对弱点的深度分析（担心、困难、问题、症状、缺陷技术、治疗障碍）；3.来访的成长史、部分生活史，呈现过去成长和现在生活中的各种细节；困难和资源、咨询和生活中的模式等。4.咨询目标，实现目标的可能路径与阻碍\n\t3. 初始评估会谈及报告：聚焦来访当下的功能（功能维度：动力学）\n\t评估来访问题的严重程度，同时，也要从以下几个领域评估咨询师与来访的潜在差异：1.先后天残障；2.宗教信仰：3.种族和民族认同；4.个人经济地位；5.性取向与性别\n这种差异评估是为了鉴别权力差异（咨询专家与求助者）和防止发生压迫/侵犯。\n}\n\n关于治疗方案的建立，遵循[]中的要求：\n[一、治疗方案的结构要素\n\t1.治疗方案综述：简要介绍治疗计划是如何进行的。使用来访理解的语言增强对治疗的掌控感、责任心。和来访共同确认。\n\t2.长期治疗目标：实则由多个短期目标构成。\n\t3.短期治疗目标：具体、可测量。这种积极变化应对于来访是可完成的、有动机的，以内化进来访的内心。\n \n二、治疗方案的视角\n\t每个治疗目标和支持材料应聚焦于来访各种主要社会角色（员工、父亲、朋友……）的功能水平或行为症状。\n1.基于假设模式\n\t以动力学的理论假设为核心，建构概要、支持材料、治疗目标等。\n2.基于症状模式\n\t根据来访报告的客观症状或行为，分析行为的原因和可能结果。通过在咨询中重演不同情境下的相关行为，探索一个行为的trigger是什么，练习正念觉察。学习稳定和调适情绪的技术。\n3.基于人际关系模式\n\t根据来访与重要他人和咨询中的关系模式，探索并分析关系如何建立、加强、破裂，行为是哪些。可以向现实生活中的不同模板询问、学习。\n4.基于历史模式\n\t从过去习得了什么，这些习得的模式如何带来心理问题。来访的需要和当前状况，最迫切关注的焦点，是如何与过去的习得产生联系的。\n \n三、治疗方案的格式规范\n1.基本模式\n\t主要聚焦于来访者需要达到的、学习的或者需要发展的内容。\n2.问题模式\n\t根据需要减少的适应不良的行为或问题来确定治疗目标。\n3.短期目标模式\n\t清晰地呈现来访者当前的问题、问题的当下状态、治疗这个问题立即的应对计划，为什么选择这个治疗方案的说明。包括：来访主观素材、咨询师客观素材、基于两种素材咨询师开展的评估、与来访共同商定的治疗计划。]\n你的整体目标应该是帮助咨询师提升服务质量，指明后续咨询方向。`;
    const getAssessmentPromptText = () => `你是一位资深的心理咨询师。基于文件中咨询逐字稿的内容，并遵循以下我给出的评估维度，对该来访做出专业化的评估。\n\t一、个人信息维度\n\t1.目前心理状态\n\t2.成长史（初中及以前）与当下部分生活史，呈现过去成长和现在生活中的各种细节、困难和资源。咨询和生活中的行为模式\n\t3.早期及现在人际关系和依恋特点（初中及以前），咨询和生活中的关系模式\n\t4.优势的深度分析（优势之处、积极因素、获得的成功、健康应对策略、技能、促进改变的因子\n\t5.弱点的深度分析（困难、问题、症状、缺陷或僵化应对、治疗阻碍）\n\t二、功能维度\n\t1.自我功能\n\t1.1自我觉知：如何看待自己。包括：\n\t自我身份认同：对自己的定义（认为自己是谁）、价值观、能力与局限性。在青少年时期逐渐稳定\n\t自我评价：反映个人能力在主观和客观的相符程度，也包括对自我理想意象的幻想（即理想の自我是什么样的）。思想和行动符合，我们的内在理想就会感到自我实现和自豪；否则就会产生内疚、失败和一无是处的感觉。\n\t1.2自尊管理：从打击中恢复原状的能力。\n\t包括自尊的脆弱性（水平高低、稳定性）、应对挫败自尊的方式（自恋自大或自我挫败/受虐，而更健康的方式是直面问题 而不是困在自我中）、利用他人调节自尊。自尊是对自己的尊敬和或欣赏，自尊问题使我们变得无法承受情感和焦虑，无法现实评价能力和局限，无法控制我们的冲动，无法放松，等等。\n\t此外，自我评价的问题也会导致自我知觉的扭曲和自尊管理的困难。有的人会高估自己的能力(夸大)，而有的人会低估自己的能力（抑郁），又或者理想化他人。（嫉妒具有攻击性，而羡慕具有靠近的倾向）\n\t2.人际关系功能：保持稳定、信任、亲密关系的能力\n\t关键：1.关系中对自己和对方的信任感、2.感知度：既好又坏的立体性、独特个性的独立性（明白他人的思想和感受与自己不同，心智化能力）、过去到现在与未来可能变化的完整性。3.安全感：抵抗面对分离、分歧、消极情绪。4.亲密性（边界情况）；5.相互依存度：合适的依存是既给予也享受的。\n\t \n\t除此以外仍然关键的要素有：共情能力、来访意识与无意识对他人的期待和对关系的幻想。 \n\t两种关系问题：无意识投射与幻想、缺乏社交功能。前者揭露，后者支持\n\t在成长的过程中，小时候和重要他人的互动为他们整个人生中与人互动的方式打下了不可磨灭的烙印。被爱护和照料得很好的人学会了期待从他人那里也得到这些，而被虐待或忽视的人学会了预期被虐待。即使人们意识不到这些内化的无意识的关系模式和幻想，也依然影响着他们的每一次行动。\n\t这些幻想之所以残留在意识之外，是因为它们引发了羞愧、焦虑或其他令人不舒服的强烈情感。如果他们意识不到这些无意识的需求，人们就无法选择能和他们建立成熟满意的人际关系的他人。甚至意识层面的需求和无意识的需求有所冲突。\n\t社交功能包括：共情能力、对自我羞耻的程度、识别社会性线索的能力。这些都影响着融入人际关系的能力。\n\t以资访关系为模板，检查过往模式的重现并提供修正机会。如咨询师反馈自己的想法和感受，修正来访的错误知觉；强化适应性的防御并取代非适应性的（适应性的判断标准）；通过来访猜测咨询师-咨询师反馈，提升心智化功能等。最终使来访认清过往模式，并开始憧憬他们可以拥有对身边的人更为现实的、大不相同的期待\n\t3.适应功能：面对压力的调整\n\t内在压力包括思想和幻想、情感和焦虑、痛苦和其他身体感觉;外在压力包括与他人的人际关系、与经济状况和工作相关的压力、创伤以及其他环境因素。人们在忍受内部或外部的压力刺激时有着各自的阈限，也有着适应内部和外部压力刺激的不同方式，包括：防御机制、冲动控制、情绪管理、感觉调节\n\t感觉刺激管理能力：对各种感官刺激的耐受和注意力分配能力\n\t情绪管理能力：耐受、管理、稳定体验、表达情绪的能力。情绪快速激烈变化说明该能力差。\n\t冲动控制差可能有物质成瘾、控制性强、暴力、违法行为等问题\n\t \n\t无意识的调节压力即是防御机制，我们应对压力的个性化方式在早年时往往具有适应性意义，让我们免受负面感受的威胁。评价防御机制的三个维度：\n\t1.适应性：帮助适应压力的同时，保护或增强机能。适应性不是绝对的，一种情形下的强适应性机制可能是另一种情形下的弱适应性机制。2.灵活性。3.对思维与情感的自知力\n\t不适应的信号：1防御动用了过多的心理能量，以至于只给我们留下很少的精力去发动其他的重要功能。2防御损害了体验情感，或拥有成熟满意的人际关系的能力。3泛化、僵化的防御方式。4以自我毁灭或身体痛苦为代价\n\t不适应信号的识别：1心理或行为表现；2主观或客观的痛苦；3人际关系问题；4反移情（这也提示着生活中他人对来访的感受）\n\t干预第一步：帮助来访者认清他们的适应方式有问题，当前防御的效果是有限的。将僵化的防御与新习得的适应性防御，两种方式的结果进行比较、确认，能更好的留在来访心中。\n \n\t4.认知功能\n4.1组织与规划思维、决策制订和问题解决能力、创造性思维\n\tA有条理，以细节为导向，会提前规划，并且可以冷静地解决问题。B更加随意，频繁地改变主意，以一种更情绪化的方式解决问题。最终，两个方案都可以大获成功，但是就计划筹备它们的思路和过程而言，是相当不同的。我们的任务不是去评判哪个方式更好，而是描述我们的来访解决问题的风格，同时去思考这些风格是如何积极或消极地影响他们的生活的。\n\t4.2判断能力：意识到一个有意行为的适当性和可能发生的结果，且行为能够体现这种意识（知道踩油门会出车祸但还是踩了，冲动不叫有判断力）\n“明辨是非”的道德判断力是超我的功能，也可以通过内疚感来评估,如果满足愿望的冲动无法控制或道德判断不正常，都属于认知功能异常。判断力不是“全或无”的性质，而是可以在不同环境下增大或衰减的。\n\t4.3反思能力：评估/检验自身想法和行为的能力，修正不一致的态度和感受的能力。\n\t①心理感受性是和自省力有所关联的，它指的是思考某人产生思维、感觉和行为时的可能有的无意识动机的能力。自省的能力帮助人们认识和改善他们对自己和与他人关系的感知。\n\t②现实检验能力：分辨现实/事实与幻想/主管臆测的能力\n\t 来访的认知功能差，是无意识使其阻滞，还是从未习得？如果一个人有能力执行功能但是被阻滞了，就被认为是由冲突导致的问题；而如果一个人缺乏执行功能的能力，甚至从早年间就有过种种迹象，就被认为是由缺陷导致的\n\t另外，问题是长期/近期的、是总体性的还是选择性的，都有助于区分冲突/缺陷。 \n \n5.工作和娱乐功能\n\t工作是付出身体或是精神努力去做某事，有目的性的活动。一个人“选择”做了什么（当然也包括职业）可以反映出他的个人和人际生活，也匹配于他的心智、能力、局限性。\n\t娱乐指放松、沉浸于幻想、无焦虑的体验无意识情感和驱力的能力。会娱乐的人可能拥有更健康的情绪生活并且成长得更顺利，缺乏休闲活动暗示他们在放松和享受方面有巨大问题。\n\t评估工作和娱乐领域：1.很好地与他们的发展水平或年龄、天赋、局限性匹配；2.感到舒服或愉悦；3.物质基础足以照顾自己和家人。`;
    const getSupervisionPromptText = () => `你是资深心理咨询督导师，采用精神动力学取向整合视角。\n你的核心关注点包括：来访者福祉与伦理合规性、咨询过程微观分析、咨询师自我觉察与专业发展、以及关系动力系统解构。\n请根据提供的来访者信息和所有文件内容，从以下维度进行分析，并生成一份结构化的临床督导报告。\n\n# 分析维度：\n1.  **来访者分析:**\n    * **显性内容:** 分析表层陈述的事实、诉求，以及可观察的情绪反应强度与变化。\n    * **隐性心理过程:** 探索自体表征（自我价值感/完整性）、客体关系模式（互动期待/内在工作模型）、防御机制层级（从原始到成熟）、移情线索（对咨询师的角色投射），以及未满足的核心需求。\n    * **发展性评估:** 评估咨询前后表征模式的变化、心理化能力水平和反思功能的进展。\n2.  **咨询师分析:**\n    * **干预技术分析:** 命名具体技术（如『支持性面质』『隐喻性诠释』），评估技术实施时序（是否匹配进程节律），以及技术选择与个案概念化的逻辑联结。\n    * **回应效能评估:** 评估与来访者潜意识的匹配度（1-5级评分），对咨询联盟的影响（强化/削弱/中性），以及是否拓展心理空间（是/否/部分）。\n    * **反移情管理:** 识别咨询师的身体、情绪、认知等反移情线索及处理方式。\n3.  **关系动力分析:**\n    * **移情-反移情矩阵:** 分析投射性认同激活领域、互补性/一致性反移情模式，以及修复性体验发生节点。\n    * **此时此地互动:** 分析3轮对话内的情感传递精度及非言语同步性（语音停顿/语速匹配）。\n    * **平行过程监测:** 寻找咨询关系模式在督导中的重现证据及机构系统压力的传导路径。\n4.  **专业发展指导:**\n    * **能力成长点:** 指出需强化的理论模块和技术优化建议。\n    * **盲点警示:** 提示文化偏见风险和伦理敏感域。\n\n# 输出规格：\n* **格式:** 结构化临床督导报告。\n* **必须包含的章节:** 关键交互片段标记（时间戳+对话摘要）、动力过程概念化图谱、伦理风险评级（低/中/高）、具体可操作改进策略（按实施优先级排序），以及督导后反思问题（3个开放式提问）。\n* **禁止:** 绝对化诊断表述（如『来访者患有XX障碍』），脱离文本的推测性解读。\n\n# 特殊要求：\n* 标注每项结论的文本证据来源（如『L34来访者握拳陈述』）。\n* 区分观察事实与督导假设（使用『可能表明』『提示』等限定词）。\n* 整合至少2个理论视角（主体间性/依恋理论/关系精神分析等）。`;

    // --- Gemini API Call Function ---
    const callGeminiApi = async (systemPrompt, userPrompt) => {
        const apiKey = ""; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const chatHistory = [ { role: "user", parts: [{ text: systemPrompt + "\n\n" + userPrompt }] } ];
        const payload = { contents: chatHistory };
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                throw new Error("Invalid response structure from AI API.");
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            throw error;
        }
    };

    // --- Helper function to download text files ---
    const downloadTextAsFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- Mock Initial Data ---
    const initialClients = [
      { 
        id: 'client-001', name: '王芳', age: 32, gender: '女', grade: '在职', sexualOrientation: '异性恋',
        contact: '138********', joinDate: '2023-10-15', referredBy: null, referredClients: ['client-002'],
        historyOfIllness: '无重大既往史', mentalStateScore: 7, disabilityStatus: '无', religiousBelief: '无',
        ethnicIdentity: '汉族', personalFinance: '稳定', familyFinance: '良好',
        sessions: [
          { 
            id: 'session-001-1', date: '2023-10-15', summary: '首次访谈，建立咨询关系。',
            transcript: { name: '首次访谈逐字稿.txt', content: '模拟的逐字稿内容...' },
            conceptualization: { status: 'Complete', content: '这是AI为王芳生成的个案概念化报告示例。报告详细分析了来访者的核心问题，并根据精神动力学理论提出了初步的治疗假设和方向。' },
            assessment: { status: 'Complete', content: '这是AI为王芳生成的来访者评估报告示例。报告从自我功能、人际关系、适应能力等多个维度对来访者进行了全面的评估。' },
            supervision: { status: 'Pending', conceptualizationUploaded: false, assessmentUploaded: false, content: null }
          },
        ]
      },
      { 
        id: 'client-002', name: '李明', age: 28, gender: '男', grade: '硕士在读', sexualOrientation: '未提供',
        contact: '159********', joinDate: '2024-01-20', referredBy: 'client-001', referredClients: [],
        historyOfIllness: '无', mentalStateScore: 5, disabilityStatus: '无', religiousBelief: '无',
        ethnicIdentity: '汉族', personalFinance: '依赖家庭', familyFinance: '中等',
        sessions: []
      },
    ];
    
    const initialCounselors = [
        { id: 'counselor-01', name: '李慧', modality: '人本主义、精神分析', email: 'li.hui@example.com', assignedClientIds: ['client-001', 'client-002'] },
        { id: 'counselor-02', name: '张伟', modality: 'CBT、焦点解决', email: 'zhang.wei@example.com', assignedClientIds: [] },
    ];
    
    const getInitialAppointments = () => {
        const today = new Date();
        const getFutureDate = (days) => {
            const future = new Date();
            future.setDate(today.getDate() + days);
            return future.toISOString().split('T')[0];
        };
        return [
            { id: 'appt-01', date: getFutureDate(0), time: '10:00', clientId: 'client-001', counselorId: 'counselor-01', location: '线上会议室 A', notes: '第三次会谈' },
            { id: 'appt-02', date: getFutureDate(1), time: '14:00', clientId: 'client-002', counselorId: 'counselor-01', location: '咨询室 201', notes: '初步评估' },
            { id: 'appt-03', date: getFutureDate(1), time: '11:00', clientId: 'client-001', counselorId: 'counselor-01', location: '线上会议室 B', notes: '跟进' },
        ];
    };


    // --- Main Application Component ---
    const App = () => {
      const { useState, useEffect } = React;
      
      const [clients, setClients] = useState(() => {
        try { const saved = localStorage.getItem('psychClients'); return saved ? JSON.parse(saved) : initialClients; } 
        catch (e) { console.error("Failed to parse clients from localStorage", e); return initialClients; }
      });
      const [counselors, setCounselors] = useState(() => {
        try { const saved = localStorage.getItem('psychCounselors'); return saved ? JSON.parse(saved) : initialCounselors; }
        catch (e) { console.error("Failed to parse counselors from localStorage", e); return initialCounselors; }
      });
      const [appointments, setAppointments] = useState(() => {
        try { const saved = localStorage.getItem('psychAppointments'); return saved ? JSON.parse(saved) : getInitialAppointments(); }
        catch (e) { console.error("Failed to parse appointments from localStorage", e); return getInitialAppointments(); }
      });
      const [users, setUsers] = useState(() => {
          try { const saved = localStorage.getItem('psychUsers'); return saved ? JSON.parse(saved) : {}; }
          catch(e) { return {}; }
      });
      const [currentUser, setCurrentUser] = useState(() => {
          try { const saved = sessionStorage.getItem('psychCurrentUser'); return saved ? JSON.parse(saved) : null; }
          catch(e) { return null; }
      });

      const [activeSection, setActiveSection] = useState('schedule');
      const [selectedClient, setSelectedClient] = useState(null);
      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');
      const [alertInfo, setAlertInfo] = useState({ show: false, message: '' });

      useEffect(() => { 
        try {
            localStorage.setItem('psychClients', JSON.stringify(clients));
            localStorage.setItem('psychCounselors', JSON.stringify(counselors));
            localStorage.setItem('psychAppointments', JSON.stringify(appointments));
            localStorage.setItem('psychUsers', JSON.stringify(users));
            if(currentUser) {
                sessionStorage.setItem('psychCurrentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.removeItem('psychCurrentUser');
            }
        }
        catch (e) { console.error("Failed to save data to storage", e); }
      }, [clients, counselors, appointments, users, currentUser]);

      const showAlert = (message) => {
        setAlertInfo({ show: true, message });
      };

      const handleRegister = (username, password) => {
          if (users[username]) {
              showAlert('用户名已存在！');
              return false;
          }
          const newUsers = { ...users, [username]: { password } };
          setUsers(newUsers);
          setCurrentUser({ username });
          showAlert('注册成功！');
          return true;
      };

      const handleLogin = (username, password) => {
          if (users[username] && users[username].password === password) {
              setCurrentUser({ username });
              showAlert(`欢迎回来, ${username}!`);
              return true;
          }
          return false;
      };
      
      const handleLogout = () => {
          setCurrentUser(null);
      }

      const handleUpdateClient = (updatedClientData, callback) => {
        let newClientsState = [...clients];
        const oldClientState = newClientsState.find(c => c.id === updatedClientData.id);
        
        if (oldClientState) {
            const oldReferredBy = oldClientState.referredBy;
            const newReferredBy = updatedClientData.referredBy;
            if (oldReferredBy !== newReferredBy) {
              if (oldReferredBy) {
                const oldReferrerIndex = newClientsState.findIndex(c => c.id === oldReferredBy);
                if (oldReferrerIndex > -1) { newClientsState[oldReferrerIndex].referredClients = newClientsState[oldReferrerIndex].referredClients.filter(id => id !== updatedClientData.id); }
              }
              if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1) { if (!newClientsState[newReferrerIndex].referredClients.includes(updatedClientData.id)) { newClientsState[newReferrerIndex].referredClients.push(updatedClientData.id); } }
              }
            }
        }
        
        const clientIndex = newClientsState.findIndex(c => c.id === updatedClientData.id);
        if (clientIndex > -1) { newClientsState[clientIndex] = updatedClientData; } 
        else {
            newClientsState.push(updatedClientData);
            const newReferredBy = updatedClientData.referredBy;
            if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1 && !newClientsState[newReferrerIndex].referredClients.includes(updatedClientData.id)) {
                    newClientsState[newReferrerIndex].referredClients.push(updatedClientData.id);
                }
            }
        }
        
        setClients(newClientsState);
        if (selectedClient?.id === updatedClientData.id || !oldClientState) { setSelectedClient(updatedClientData); }
        if (callback) callback(updatedClientData);
      };

      const handleAddClient = (newClientData, clientToEdit) => {
          if (clientToEdit) {
              handleUpdateClient({ ...clientToEdit, ...newClientData });
          } else {
              const clientWithDefaults = {
                  ...newClientData,
                  id: `client-${Date.now()}`,
                  sessions: [],
                  joinDate: new Date().toISOString().split('T')[0],
                  referredBy: newClientData.referredBy || null,
                  referredClients: [],
              };
              handleUpdateClient(clientWithDefaults);
          }
      };
      
      const handleDeleteClient = (clientId) => {
        const clientToDelete = clients.find(c => c.id === clientId);
        if (!clientToDelete) return;
        let updatedClients = clients.filter(client => client.id !== clientId);
        updatedClients = updatedClients.map(client => {
          if (client.referredBy === clientId) { return { ...client, referredBy: null }; }
          if (client.referredClients.includes(clientId)) { return { ...client, referredClients: client.referredClients.filter(id => id !== clientId) }; }
          return client;
        });
        
        let updatedCounselors = counselors.map(counselor => ({
            ...counselor,
            assignedClientIds: counselor.assignedClientIds.filter(id => id !== clientId)
        }));

        showAlert(`来访者 ${clientToDelete?.name} 已被删除。`);
        setClients(updatedClients);
        setCounselors(updatedCounselors);
        setAppointments(prev => prev.filter(appt => appt.clientId !== clientId));
        if (selectedClient?.id === clientId) { setSelectedClient(null); setActiveSection('clientManagement'); }
      };
      
      const handleUpdateCounselors = (updatedCounselors) => {
          setCounselors(updatedCounselors);
      };

      const handleDeleteCounselor = (counselorId) => {
          if (appointments.some(appt => appt.counselorId === counselorId)) {
              showAlert('无法删除该咨询师，因为其仍有关联的日程安排。请先移除相关日程。');
              return;
          }
          setCounselors(prev => prev.filter(c => c.id !== counselorId));
          showAlert('咨询师已删除。');
      };

      const handleUpdateAppointments = (appointmentData, isDelete = false) => {
            if (isDelete) {
                setAppointments(prev => prev.filter(appt => appt.id !== appointmentData.id));
            } else {
                const existingIndex = appointments.findIndex(appt => appt.id === appointmentData.id);
                if (existingIndex > -1) {
                    const updated = [...appointments];
                    updated[existingIndex] = appointmentData;
                    setAppointments(updated);
                } else {
                    setAppointments(prev => [...prev, {...appointmentData, id: `appt-${Date.now()}`}]);
                }
            }
      };

      const handleSelectClient = (client) => { setSelectedClient(client); setActiveSection('clientDetail'); };
      
      const navItems = [
          { id: 'clientManagement', label: '来访者管理', icon: '👥' },
          { id: 'counselorManagement', label: '咨询师管理', icon: '🧑‍🏫' },
          { id: 'schedule', label: '咨询日程', icon: '🗓️' },
          { id: 'cbtApplication', label: '辅助工具', icon: '🧠' }
      ];

      const renderSection = () => {
        switch (activeSection) {
          case 'clientManagement':
            return <ClientManagementSection clients={clients} onAddClient={handleAddClient} onSelectClient={handleSelectClient} />;
          case 'counselorManagement':
            return <CounselorManagementSection counselors={counselors} clients={clients} appointments={appointments} onUpdateCounselors={handleUpdateCounselors} onDeleteCounselor={handleDeleteCounselor} />;
          case 'schedule':
            return <ScheduleSection appointments={appointments} clients={clients} counselors={counselors} onUpdateAppointments={handleUpdateAppointments} />;
          case 'clientDetail':
            return selectedClient ? 
                   <ClientDetailView 
                      key={selectedClient.id + JSON.stringify(selectedClient.sessions)} 
                      client={selectedClient} 
                      allClients={clients} 
                      onUpdateClient={handleUpdateClient} 
                      onDeleteClient={handleDeleteClient}
                      globalLoadingMessage={globalLoadingMessage}
                      setGlobalLoadingMessage={setGlobalLoadingMessage}
                      showAlert={showAlert}
                    /> : 
                   <div className="text-center p-10 text-gray-500">请先返回来访者列表选择一位来访者。</div>;
          case 'cbtApplication':
            return <CBTSection showAlert={showAlert}/>;
          default:
            return <ScheduleSection appointments={appointments} clients={clients} counselors={counselors} onUpdateAppointments={handleUpdateAppointments} />;
        }
      };

      if (!currentUser) {
          return <AuthModal onLogin={handleLogin} onRegister={handleRegister} users={users} showAlert={showAlert} />;
      }

      return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
          {alertInfo.show && (
            <div className="alert-modal animate-fadeIn" onClick={() => setAlertInfo({ show: false, message: '' })}>
              <div className="alert-modal-content" onClick={(e) => e.stopPropagation()}>
                <p>{alertInfo.message}</p>
                <button className="alert-modal-button" onClick={() => setAlertInfo({ show: false, message: '' })}>关闭</button>
              </div>
            </div>
          )}
          <header className="bg-white shadow-sm sticky top-0 z-40"><div className="container mx-auto px-4"><div className="flex items-center justify-between h-16">
          <button onClick={() => setActiveSection('schedule')} className="flex items-center cursor-pointer">
            <span className="text-2xl mr-3">💌</span>
            <h1 className="text-xl font-bold text-gray-800">心理咨询师助手</h1>
          </button>
          <div className="flex items-center gap-4">
            <nav className="flex items-center space-x-1">
                {navItems.map(item => (
                    <button 
                        key={item.id} 
                        onClick={()=>setActiveSection(item.id)} 
                        className={`px-3 py-2 rounded-md text-sm font-medium flex items-center transition-colors duration-200 ${activeSection === item.id || (activeSection === 'clientDetail' && item.id === 'clientManagement') ? 'bg-gray-100 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}
                    >
                        <span className="mr-2">{item.icon}</span>{item.label}
                    </button>
                ))}
            </nav>
            <div className="border-l pl-4">
                <button onClick={handleLogout} className="text-sm font-medium text-gray-500 hover:text-red-600">登出</button>
            </div>
           </div>
          </div></div></header>
          {globalLoadingMessage && (<div className="bg-yellow-100 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center sticky top-16 z-30"><span className="mr-2">⏳</span>{globalLoadingMessage}</div>)}
          <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
        </div>
      );
    };
    
    // --- Components ---
    
    const AuthModal = ({ onLogin, onRegister, users, showAlert }) => {
        const { useState } = React;
        const [mode, setMode] = useState('login'); // login or register
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');

        const handleLoginAttempt = (e) => {
            e.preventDefault();
            if (!username || !password) {
                showAlert('请输入用户名和密码。');
                return;
            }
            const loginSuccess = onLogin(username, password);
            if (!loginSuccess) {
                if (!users[username]) {
                    showAlert('用户不存在，请先注册。');
                    setMode('register');
                } else {
                    showAlert('密码错误！');
                }
            }
        };
        
        const handleRegisterAttempt = (e) => {
            e.preventDefault();
            if (!username || !password || !confirmPassword) {
                showAlert('请填写所有字段。');
                return;
            }
            if (password !== confirmPassword) {
                showAlert('两次输入的密码不匹配！');
                return;
            }
            onRegister(username, password);
        };

        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-lg shadow-xl p-8 animate-fadeIn">
                   {mode === 'login' ? (
                       <div>
                           <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">登录</h2>
                           <form onSubmit={handleLoginAttempt} className="space-y-4">
                               <div><label className="text-sm font-medium text-gray-700">用户名</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" /></div>
                               <div><label className="text-sm font-medium text-gray-700">密码</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" /></div>
                               <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">登录</button>
                           </form>
                           <p className="text-xs text-center text-gray-500 mt-4">没有账户？ <button onClick={() => setMode('register')} className="text-blue-600 hover:underline">点击注册</button></p>
                       </div>
                   ) : (
                       <div>
                           <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">注册</h2>
                           <form onSubmit={handleRegisterAttempt} className="space-y-4">
                               <div><label className="text-sm font-medium text-gray-700">用户名</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" /></div>
                               <div><label className="text-sm font-medium text-gray-700">密码</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" /></div>
                               <div><label className="text-sm font-medium text-gray-700">确认密码</label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" /></div>
                               <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">注册</button>
                           </form>
                           <p className="text-xs text-center text-gray-500 mt-4">已有账户？ <button onClick={() => setMode('login')} className="text-blue-600 hover:underline">返回登录</button></p>
                       </div>
                   )}
                </div>
            </div>
        );
    };

    const CounselorManagementSection = ({ counselors, clients, appointments, onUpdateCounselors, onDeleteCounselor }) => {
        const { useState, useMemo } = React;
        const [showAddModal, setShowAddModal] = useState(false);
        const [counselorToEdit, setCounselorToEdit] = useState(null);

        const counselorsWithHours = useMemo(() => {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            return counselors.map(counselor => {
                const monthlyHours = appointments.filter(appt => {
                    const apptDate = new Date(appt.date);
                    return appt.counselorId === counselor.id &&
                           apptDate.getMonth() === currentMonth &&
                           apptDate.getFullYear() === currentYear;
                }).length; // Each appointment is 1 hour
                const totalHours = appointments.filter(appt => appt.counselorId === counselor.id).length;
                return { ...counselor, monthlyHours, totalHours };
            });
        }, [counselors, appointments]);

        const handleSaveCounselor = (counselorData) => {
            let updatedCounselors;
            if (counselorToEdit) {
                updatedCounselors = counselors.map(c => c.id === counselorData.id ? counselorData : c);
            } else {
                updatedCounselors = [...counselors, { ...counselorData, id: `counselor-${Date.now()}`, assignedClientIds: counselorData.assignedClientIds || [] }];
            }
            onUpdateCounselors(updatedCounselors);
            setShowAddModal(false);
            setCounselorToEdit(null);
        };

        const openEditModal = (counselor) => {
            setCounselorToEdit(counselor);
            setShowAddModal(true);
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">🧑‍🏫</span>咨询师管理</h2><button onClick={() => { setCounselorToEdit(null); setShowAddModal(true); }} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm"><span className="mr-2">➕</span>添加咨询师</button></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {counselorsWithHours.map(counselor => {
                        const assignedClients = clients.filter(client => counselor.assignedClientIds?.includes(client.id));
                        return (
                            <div key={counselor.id} className="bg-gray-50 border rounded-lg p-4 flex flex-col">
                                <div className="flex-grow">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-xl font-bold text-blue-700">{counselor.name}</h3>
                                            <p className="text-sm text-gray-600 mt-1">{counselor.modality}</p>
                                        </div>
                                        <div className="text-right flex gap-4">
                                            <div>
                                                <p className="text-sm text-gray-600">本月</p>
                                                <p className="text-2xl font-bold text-blue-800">{counselor.monthlyHours} <span className="text-base font-normal">小时</span></p>
                                            </div>
                                             <div>
                                                <p className="text-sm text-gray-600">职业总计</p>
                                                <p className="text-2xl font-bold text-gray-800">{counselor.totalHours} <span className="text-base font-normal">小时</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2 mb-4">{counselor.email}</p>
                                    
                                    <h4 className="text-sm font-bold text-gray-700 mt-4 border-t pt-3">负责来访:</h4>
                                    {assignedClients.length > 0 ? (
                                        <div className="flex flex-wrap gap-2 mt-2">
                                            {assignedClients.map(client => <span key={client.id} className="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">{client.name}</span>)}
                                        </div>
                                    ) : <p className="text-xs text-gray-500 mt-2">暂无</p>}
                                </div>
                                <div className="flex justify-end space-x-2 mt-4 pt-4 border-t">
                                    <button onClick={() => openEditModal(counselor)} className="text-xs font-medium text-blue-600 hover:underline">编辑</button>
                                    <button onClick={() => onDeleteCounselor(counselor.id)} className="text-xs font-medium text-red-600 hover:underline">删除</button>
                                </div>
                            </div>
                        )
                    })}
                </div>
                 {counselors.length === 0 && <p className="text-center text-gray-500 py-8">暂无咨询师信息。</p>}
                {showAddModal && <AddCounselorModal onClose={() => { setShowAddModal(false); setCounselorToEdit(null); }} onSave={handleSaveCounselor} counselorToEdit={counselorToEdit} allClients={clients} />}
            </div>
        );
    };

    const AddCounselorModal = ({ onClose, onSave, counselorToEdit, allClients }) => {
        const { useState, useRef, useEffect } = React;
        const [formData, setFormData] = useState({
            name: counselorToEdit?.name || '',
            modality: counselorToEdit?.modality || '',
            email: counselorToEdit?.email || '',
            assignedClientIds: counselorToEdit?.assignedClientIds || [],
        });
        const [isDragging, setIsDragging] = useState(false);
        const dragStartClientId = useRef(null);

        const handleClientSelection = (clientId) => {
             setFormData(prev => {
                const newIds = prev.assignedClientIds.includes(clientId)
                    ? prev.assignedClientIds.filter(id => id !== clientId)
                    : [...prev.assignedClientIds, clientId];
                return {...prev, assignedClientIds: newIds};
            });
        };

        const handleMouseDown = (e, clientId) => {
            e.preventDefault();
            setIsDragging(true);
            dragStartClientId.current = clientId;
            handleClientSelection(clientId);
        };

        const handleMouseOver = (clientId) => {
            if (isDragging) {
                 const currentAssigned = formData.assignedClientIds;
                 if(!currentAssigned.includes(clientId)) {
                    handleClientSelection(clientId);
                 }
            }
        };

        const handleMouseUp = () => {
            setIsDragging(false);
            dragStartClientId.current = null;
        };
        
        useEffect(() => {
            const mouseUpHandler = () => handleMouseUp();
            window.addEventListener('mouseup', mouseUpHandler);
            return () => window.removeEventListener('mouseup', mouseUpHandler);
        }, []);


        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({...prev, [name]: value}));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.name.trim()) { alert('姓名不能为空'); return; }
            onSave({ ...counselorToEdit, ...formData });
        };

        return (
             <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
              <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg">
                <div className="flex justify-between items-center mb-4 pb-2 border-b"><h3 className="text-xl font-semibold">{counselorToEdit ? '编辑' : '添加'}咨询师</h3><button onClick={onClose} className="text-gray-500 hover:text-red-500">❌</button></div>
                <form onSubmit={handleSubmit} className="space-y-4" onMouseUp={handleMouseUp}>
                  <div><label className="block text-sm font-medium">姓名 <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                  <div><label className="block text-sm font-medium">擅长咨询流派</label><input type="text" name="modality" value={formData.modality} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                  <div><label className="block text-sm font-medium">邮箱</label><input type="email" name="email" value={formData.email} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                  
                  <div>
                    <label className="block text-sm font-medium">负责来访 (可点击或滑动选择)</label>
                    <div className="max-h-32 overflow-y-auto border rounded-md p-2 mt-1 select-none">
                        {allClients.map(client => (
                            <div 
                                key={client.id} 
                                onMouseDown={(e) => handleMouseDown(e, client.id)}
                                onMouseOver={() => handleMouseOver(client.id)}
                                className={`p-1 rounded cursor-pointer ${formData.assignedClientIds.includes(client.id) ? 'bg-blue-200' : 'hover:bg-gray-100'}`}
                            >
                                <span className="text-sm text-gray-800">{client.name}</span>
                            </div>
                        ))}
                    </div>
                  </div>

                  <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">取消</button><button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm"><span className="mr-2">💾</span>保存</button></div>
                </form>
              </div>
            </div>
        );
    };

    const ScheduleSection = ({ appointments, clients, counselors, onUpdateAppointments }) => {
        const { useState } = React;
        const [view, setView] = useState('daily'); // 'daily' or 'overview'
        const [currentDate, setCurrentDate] = useState(new Date());
        const [showModal, setShowModal] = useState(false);
        const [modalDetails, setModalDetails] = useState({ date: null, time: null, location: '' });

        const openAppointmentModal = (date, time, location) => {
            setModalDetails({ date: date || currentDate.toISOString().split('T')[0], time: time || '09:00', location: location || '' });
            setShowModal(true);
        };
        
        const handleSaveAppointment = (appointmentData) => {
            onUpdateAppointments(appointmentData);
            setShowModal(false);
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                   <h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">🗓️</span>咨询日程</h2>
                   <div className="flex items-center gap-4">
                       <div className="flex items-center bg-gray-100 rounded-lg p-1">
                           <button onClick={() => setView('daily')} className={`px-3 py-1 text-sm rounded-md ${view === 'daily' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'}`}>每日视图</button>
                           <button onClick={() => setView('overview')} className={`px-3 py-1 text-sm rounded-md ${view === 'overview' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'}`}>三月总览</button>
                       </div>
                       <button onClick={() => openAppointmentModal()} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm"><span className="mr-2">➕</span>添加日程</button>
                   </div>
                </div>
                
                {view === 'daily' ? (
                    <ScheduleDailyView 
                        currentDate={currentDate}
                        setCurrentDate={setCurrentDate}
                        appointments={appointments}
                        clients={clients}
                        counselors={counselors}
                        onOpenModal={openAppointmentModal}
                    />
                ) : (
                    <ScheduleOverview appointments={appointments} />
                )}

                {showModal && <AppointmentModal 
                    onClose={() => setShowModal(false)}
                    onSave={handleSaveAppointment}
                    date={modalDetails.date}
                    time={modalDetails.time}
                    location={modalDetails.location}
                    clients={clients}
                    counselors={counselors}
                />}
            </div>
        );
    };
    
    const ScheduleDailyView = ({ currentDate, setCurrentDate, appointments, clients, counselors, onOpenModal }) => {
        const { useMemo } = React;
        const changeDay = (offset) => {
            setCurrentDate(prev => {
                const newDate = new Date(prev);
                newDate.setDate(prev.getDate() + offset);
                return newDate;
            });
        };
        
        const appointmentsForDay = useMemo(() => {
            const dateStr = currentDate.toISOString().split('T')[0];
            return appointments.filter(appt => appt.date === dateStr);
        }, [appointments, currentDate]);

        const renderHourlySchedule = () => {
            const hours = Array.from({length: 15}, (_, i) => 8 + i); // 8:00 to 22:00
            const dateStr = currentDate.toISOString().split('T')[0];

            return hours.map(hour => {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                const appointment = appointmentsForDay.find(a => a.time === timeStr);
                
                return (
                    <tr key={hour} className="border-b">
                        <td className="p-2 w-24 text-center text-sm text-gray-500 align-top">{timeStr}</td>
                        <td 
                            className="p-1 time-slot"
                            onClick={() => !appointment && onOpenModal(dateStr, timeStr)}
                        >
                            {appointment ? (
                                <div className="bg-blue-100 border-l-4 border-blue-500 p-2 rounded-r-lg">
                                    <p className="font-bold text-sm text-blue-800">{clients.find(c => c.id === appointment.clientId)?.name}</p>
                                    <p className="text-xs text-gray-600">咨询师: {counselors.find(c => c.id === appointment.counselorId)?.name}</p>
                                    {appointment.location && <p className="text-xs text-gray-600">地点: {appointment.location}</p>}
                                    <p className="text-xs text-gray-500 mt-1">{appointment.notes}</p>
                                </div>
                            ) : null}
                        </td>
                    </tr>
                );
            });
        };

        return (
            <div>
                 <div className="flex justify-between items-center mb-4">
                    <button onClick={() => changeDay(-1)} className="p-2 rounded-md hover:bg-gray-100">❮ 前一天</button>
                    <h3 className="text-xl font-semibold text-gray-700">{currentDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    <button onClick={() => changeDay(1)} className="p-2 rounded-md hover:bg-gray-100">后一天 ❯</button>
                </div>
                <div className="border rounded-lg overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="p-2 w-24 text-sm font-medium text-gray-600">时间</th>
                                <th className="p-2 text-sm font-medium text-gray-600 text-left">安排</th>
                            </tr>
                        </thead>
                        <tbody>
                            {renderHourlySchedule()}
                        </tbody>
                    </table>
                </div>
            </div>
        )
    };
    
    const ScheduleOverview = ({ appointments }) => {
        const { useMemo } = React;
        const appointmentsByDate = useMemo(() => {
            return appointments.reduce((acc, appt) => {
                (acc[appt.date] = acc[appt.date] || []).push(appt);
                return acc;
            }, {});
        }, [appointments]);

        const renderMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            
            for (let i = 0; i < firstDay; i++) {
                days.push(<div key={`empty-${i}`} className="border-t border-l"></div>);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointmentsByDate[dateStr] || [];
                const appointmentCount = dayAppointments.length;
                const counselorCount = new Set(dayAppointments.map(a => a.counselorId)).size;

                days.push(
                    <div key={day} className="border-t border-l p-1 text-sm h-20 flex flex-col">
                        <div className={`self-start ${new Date(dateStr).toDateString() === new Date().toDateString() ? 'bg-blue-600 text-white rounded-full h-6 w-6 flex items-center justify-center' : ''}`}>{day}</div>
                        {appointmentCount > 0 && 
                            <div className="flex-grow flex items-end justify-end gap-2 text-xs font-bold">
                                <span className="text-blue-600" title="单日咨询数量">{appointmentCount}</span>
                                <span className="text-red-600" title="在岗咨询师数量">{counselorCount}</span>
                            </div>
                        }
                    </div>
                );
            }
            return (
                <div>
                    <h3 className="text-lg font-semibold text-center mb-2">{date.toLocaleDateString('zh-CN', { month: 'long' })}</h3>
                    <div className="grid grid-cols-7 text-xs text-center border-r border-b">
                         {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="border-t border-l font-bold p-1 bg-gray-50">{d}</div>)}
                         {days}
                    </div>
                </div>
            )
        };
        
        const today = new Date();
        const month1 = new Date(today.getFullYear(), today.getMonth(), 1);
        const month2 = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        const month3 = new Date(today.getFullYear(), today.getMonth() + 2, 1);
        
        return (
            <div>
                <div className="flex justify-end gap-4 text-xs mb-2">
                    <span><span className="font-bold text-blue-600">■</span> 单日咨询数量</span>
                    <span><span className="font-bold text-red-600">■</span> 单日咨询师在岗</span>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {renderMonth(month1)}
                    {renderMonth(month2)}
                    {renderMonth(month3)}
                </div>
            </div>
        );
    };
    
    const AppointmentModal = ({ onClose, onSave, date, time, location, clients, counselors }) => {
        const { useState } = React;
        const [formData, setFormData] = useState({
            date: date,
            time: time,
            location: location || '',
            clientId: clients[0]?.id || '',
            counselorId: counselors[0]?.id || '',
            notes: '',
        });
        
        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({...prev, [name]: value}));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!formData.clientId || !formData.counselorId) {
                alert('请选择来访者和咨询师');
                return;
            }
            onSave(formData);
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
                <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                    <div className="flex justify-between items-center mb-4 pb-2 border-b">
                        <h3 className="text-xl font-semibold">添加/编辑日程</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-red-500">❌</button>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium">日期</label><input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full p-2 border rounded-md"/></div>
                        <div><label className="block text-sm font-medium">时间</label><input type="time" name="time" value={formData.time} onChange={handleChange} required className="w-full p-2 border rounded-md" step="3600"/></div>
                        <div><label className="block text-sm font-medium">咨询地点</label><input type="text" name="location" value={formData.location} onChange={handleChange} placeholder="例如：咨询室 201 或 线上会议" className="w-full p-2 border rounded-md"/></div>
                        <div><label className="block text-sm font-medium">来访者</label><select name="clientId" value={formData.clientId} onChange={handleChange} className="w-full p-2 border rounded-md">{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="block text-sm font-medium">咨询师</label><select name="counselorId" value={formData.counselorId} onChange={handleChange} className="w-full p-2 border rounded-md">{counselors.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="block text-sm font-medium">备注</label><textarea name="notes" value={formData.notes} onChange={handleChange} rows="3" className="w-full p-2 border rounded-md"></textarea></div>
                        <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">取消</button><button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm"><span className="mr-2">💾</span>保存</button></div>
                    </form>
                </div>
            </div>
        );
    };

    const ClientManagementSection = ({ clients, onAddClient, onSelectClient }) => {
        const { useState } = React;
        const [showAddClientModal, setShowAddClientModal] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const filteredClients = clients.filter(client => client.name.toLowerCase().includes(searchTerm.toLowerCase()));
        return (
            <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
                <div className="flex justify-between items-center mb-6 pb-4 border-b"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">👥</span>来访者管理</h2><button onClick={() => setShowAddClientModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-sm"><span className="mr-2">➕</span>添加新来访</button></div>
                <input type="text" placeholder="搜索来访者姓名..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 mb-4 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                {filteredClients.length > 0 ? (
                    <ul className="space-y-3">{filteredClients.map(client => (<li key={client.id} onClick={() => onSelectClient(client)} className="bg-gray-50 hover:bg-blue-50 border rounded-lg p-4 cursor-pointer flex justify-between items-center transition-all duration-200 hover:shadow-md"><div><p className="text-lg font-medium text-blue-700">{client.name} <span className="text-sm text-gray-500">({client.gender}, {client.age}岁)</span></p><p className="text-sm text-gray-600">加入日期: {client.joinDate}</p></div><span className="text-gray-400 font-bold">❯</span></li>))}</ul>
                ) : <p className="text-center text-gray-500 py-8">暂无匹配的来访者。</p>}
                {showAddClientModal && <AddClientModal onClose={() => setShowAddClientModal(false)} onAddClient={onAddClient} allClients={clients} />}
            </div>
        );
    };

    const AddClientModal = ({ onClose, onAddClient, clientToEdit, allClients }) => {
      const { useState } = React;
      const [formData, setFormData] = useState({
        name: clientToEdit?.name || '', age: clientToEdit?.age || '', gender: clientToEdit?.gender || '未透露',
        grade: clientToEdit?.grade || '', sexualOrientation: clientToEdit?.sexualOrientation || '',
        contact: clientToEdit?.contact || '', referredBy: clientToEdit?.referredBy || '',
        historyOfIllness: clientToEdit?.historyOfIllness || '', mentalStateScore: clientToEdit?.mentalStateScore || '5',
        disabilityStatus: clientToEdit?.disabilityStatus || '', religiousBelief: clientToEdit?.religiousBelief || '',
        ethnicIdentity: clientToEdit?.ethnicIdentity || '', personalFinance: clientToEdit?.personalFinance || '',
        familyFinance: clientToEdit?.familyFinance || '',
      });
      const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
      const handleSubmit = (e) => {
        e.preventDefault(); if (!formData.name.trim() || !formData.age) { alert('姓名和年龄为必填项。'); return; }
        const clientData = { ...formData, age: parseInt(formData.age), referredBy: formData.referredBy || null };
        onAddClient(clientData, clientToEdit); onClose();
      };
      const potentialReferrers = allClients.filter(c => c.id !== clientToEdit?.id);
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
          <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 z-10 border-b"><h3 className="text-xl font-semibold">{clientToEdit ? '编辑' : '添加'}来访者信息</h3><button onClick={onClose} className="text-gray-500 hover:text-red-500">❌</button></div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium">姓名 <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">年龄 <span className="text-red-500">*</span></label><input type="number" name="age" value={formData.age} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">性别</label><select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-2 border rounded-md"><option>未透露</option><option>男</option><option>女</option><option>其他</option></select></div>
                <div><label className="block text-sm font-medium">在读年级/职业</label><input type="text" name="grade" value={formData.grade} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">性取向</label><input type="text" name="sexualOrientation" value={formData.sexualOrientation} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">联系方式</label><input type="text" name="contact" value={formData.contact} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">转介绍来源</label><select name="referredBy" value={formData.referredBy || ''} onChange={handleChange} className="w-full p-2 border rounded-md"><option value="">无</option>{potentialReferrers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div><label className="block text-sm font-medium">心理状态评分(1-10)</label><select name="mentalStateScore" value={formData.mentalStateScore} onChange={handleChange} className="w-full p-2 border rounded-md">{[...Array(10).keys()].map(i => <option key={i+1} value={i+1}>{i+1}</option>)}</select></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">既往病史</label><input type="text" name="historyOfIllness" value={formData.historyOfIllness} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">残障情况</label><input type="text" name="disabilityStatus" value={formData.disabilityStatus} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">宗教信仰</label><input type="text" name="religiousBelief" value={formData.religiousBelief} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">种族认同</label><input type="text" name="ethnicIdentity" value={formData.ethnicIdentity} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">个人经济</label><input type="text" name="personalFinance" value={formData.personalFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">家庭经济</label><input type="text" name="familyFinance" value={formData.familyFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
              </div>
              <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md border">取消</button><button type="submit" className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md flex items-center shadow-sm"><span className="mr-2">💾</span>{clientToEdit ? '保存' : '添加'}</button></div>
            </form>
          </div>
        </div>
      );
    };

    const ClientDetailView = ({ client, allClients, onUpdateClient, onDeleteClient, globalLoadingMessage, setGlobalLoadingMessage, showAlert }) => {
      const { useState } = React;
      const [activeTab, setActiveTab] = useState('profile');
      const [showEditModal, setShowEditModal] = useState(false);
      const tabs = [{ id: 'profile', label: '档案与会话', icon: '👤' }, { id: 'conceptualization', label: 'AI个案概念化', icon: '📜' },{ id: 'analysis', label: '来访者评估', icon: '📊' }, { id: 'supervision', label: 'AI督导', icon: '🔬' }];
      
      const readFileAsText = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = event => resolve(event.target.result);
            reader.onerror = error => reject(error);
            reader.readAsText(file, 'UTF-8');
        });
      };
      
      const triggerAiGeneration = async (currentClient, sessionId, transcriptContent, transcriptName) => {
          const sessionIndex = currentClient.sessions.findIndex(s => s.id === sessionId);
          if (sessionIndex === -1) return;

          setGlobalLoadingMessage(`正在为 ${currentClient.name} (会话: ${currentClient.sessions[sessionIndex].date}) 生成AI报告...`);
          
          let processingClient = JSON.parse(JSON.stringify(currentClient));
          processingClient.sessions[sessionIndex].conceptualization.status = 'Processing';
          processingClient.sessions[sessionIndex].assessment.status = 'Processing';
          onUpdateClient(processingClient);

          try {
              const userPrompt = `来访者基本信息:\n${JSON.stringify(currentClient, null, 2)}\n\n咨询逐字稿内容:\n---\n${transcriptContent}\n---`;
              
              const [conceptualizationResult, assessmentResult] = await Promise.all([
                  callGeminiApi(getConceptualizationPromptText(), userPrompt),
                  callGeminiApi(getAssessmentPromptText(), userPrompt)
              ]);

              let finalClient = JSON.parse(JSON.stringify(processingClient));
              finalClient.sessions[sessionIndex].transcript = { name: transcriptName, content: transcriptContent };
              finalClient.sessions[sessionIndex].conceptualization = { status: 'Complete', content: conceptualizationResult };
              finalClient.sessions[sessionIndex].assessment = { status: 'Complete', content: assessmentResult };
              onUpdateClient(finalClient);
              showAlert('AI报告已成功生成！');

          } catch (error) {
              console.error('AI generation failed:', error);
              showAlert(`AI报告生成失败: ${error.message}`);
              let errorClient = JSON.parse(JSON.stringify(processingClient));
              errorClient.sessions[sessionIndex].conceptualization = { status: 'Error', content: error.message };
              errorClient.sessions[sessionIndex].assessment = { status: 'Error', content: error.message };
              onUpdateClient(errorClient);
          } finally {
              setGlobalLoadingMessage('');
          }
      };

      const handleAddSession = (newSessionData) => {
        const newSession = { id: `session-${client.id}-${Date.now()}`, ...newSessionData, transcript: null, conceptualization: { status: 'Pending' }, assessment: { status: 'Pending' }, supervision: { status: 'Pending', conceptualizationUploaded: null, assessmentUploaded: null, content: null } };
        onUpdateClient({ ...client, sessions: [...(client.sessions || []), newSession] });
      };

      const handleFileUpload = async (sessionId, file) => {
        try {
            const content = await readFileAsText(file);
            const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            let updatedClient = JSON.parse(JSON.stringify(client));
            updatedClient.sessions[sessionIndex].transcript = { name: file.name, content: content };
            onUpdateClient(updatedClient, (finalUpdatedClient) => {
                triggerAiGeneration(finalUpdatedClient, sessionId, content, file.name);
            });
        } catch(e) {
            showAlert(`读取文件失败: ${e.message}`);
        }
      };

      const handleSupervisionFileUploaded = async (sessionId, fileType, file) => {
          try {
              const fileContent = await readFileAsText(file);
              const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
              if (sessionIndex === -1) return;

              let updatedClient = JSON.parse(JSON.stringify(client));
              updatedClient.sessions[sessionIndex].supervision[fileType + 'Uploaded'] = { name: file.name, content: fileContent };
              onUpdateClient(updatedClient, (finalUpdatedClient) => {
                  const finalSession = finalUpdatedClient.sessions.find(s => s.id === sessionId);
                  if (finalSession.supervision.conceptualizationUploaded && finalSession.supervision.assessmentUploaded && finalSession.supervision.status !== 'Complete' && finalSession.supervision.status !== 'Processing') {
                      triggerSupervisionGeneration(finalUpdatedClient, sessionId);
                  }
              });
          } catch (e) {
              showAlert(`读取督导文件失败: ${e.message}`);
          }
      };
      
      const triggerSupervisionGeneration = async (clientForSupervision, sessionId) => {
          setGlobalLoadingMessage(`正在为 ${clientForSupervision.name} 生成最终督导报告...`);
          const sessionIndex = clientForSupervision.sessions.findIndex(s => s.id === sessionId);
          
          let processingClient = JSON.parse(JSON.stringify(clientForSupervision));
          processingClient.sessions[sessionIndex].supervision.status = 'Processing';
          onUpdateClient(processingClient);

          try {
              const currentSession = processingClient.sessions[sessionIndex];
              const promptForSupervision = `来访者基本信息:\n${JSON.stringify(clientForSupervision, null, 2)}\n\n咨询逐字稿内容:\n${currentSession.transcript.content}\n\nAI生成的个案概念化:\n${currentSession.supervision.conceptualizationUploaded.content}\n\nAI生成的来访者评估:\n${currentSession.supervision.assessmentUploaded.content}`;
              
              const supervisionContent = await callGeminiApi(getSupervisionPromptText(), promptForSupervision);
              
              let finalClient = JSON.parse(JSON.stringify(processingClient));
              finalClient.sessions[sessionIndex].supervision = { 
                  ...finalClient.sessions[sessionIndex].supervision,
                  status: 'Complete', 
                  content: supervisionContent 
              };
              onUpdateClient(finalClient);
              showAlert('AI督导报告已成功生成！');
          } catch(error) {
              showAlert(`AI督导报告生成失败: ${error.message}`);
              let errorClient = JSON.parse(JSON.stringify(processingClient));
              errorClient.sessions[sessionIndex].supervision = { ...errorClient.sessions[sessionIndex].supervision, status: 'Error', content: error.message };
              onUpdateClient(errorClient);
          } finally {
              setGlobalLoadingMessage('');
          }
      };
      
      const renderTabContent = () => {
        const isLoading = !!globalLoadingMessage;
        switch (activeTab) {
          case 'profile': return <ClientProfileTab client={client} allClients={allClients} onAddSession={handleAddSession} onFileUpload={handleFileUpload} isAiLoading={isLoading} />;
          case 'conceptualization': return <ReportDisplayTab client={client} reportType="conceptualization" title="AI个案概念化" themeColor="indigo" />;
          case 'analysis': return <ReportDisplayTab client={client} reportType="assessment" title="来访者评估" themeColor="green" />;
          case 'supervision': return <SupervisionReportTab client={client} onSupervisionFileUploaded={handleSupervisionFileUploaded} isAiLoading={isLoading} />;
          default: return null;
        }
      };

      return (
        <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn">
          <div className="flex flex-col md:flex-row justify-between md:items-center mb-4 pb-4 border-b gap-4"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-3xl">👤</span>{client.name} - 档案中心</h2><div><button onClick={() => setShowEditModal(true)} className="text-sm font-medium text-blue-600 hover:text-blue-800 mr-4 flex items-center"><span className="mr-1">✏️</span>编辑</button><button onClick={() => onDeleteClient(client.id)} className="text-sm font-medium text-red-600 hover:text-red-800 flex items-center"><span className="mr-1">🗑️</span>删除</button></div></div>
          <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-6 overflow-x-auto">{tabs.map(tab => <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-shrink-0 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center ${activeTab === tab.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}><span className="mr-2">{tab.icon}</span>{tab.label}</button>)}</nav></div>
          <div className="pt-6">{renderTabContent()}</div>
          {showEditModal && <AddClientModal onClose={() => setShowEditModal(false)} onAddClient={onUpdateClient} clientToEdit={client} allClients={allClients}/>}
        </div>
      );
    };

    const ClientProfileTab = ({ client, allClients, onAddSession, onFileUpload, isAiLoading }) => {
      const { useState, useRef } = React;
      const [showAddSession, setShowAddSession] = useState(false);
      const [newSessionDate, setNewSessionDate] = useState(new Date().toISOString().split('T')[0]);
      const handleCreateSession = () => { if (!newSessionDate) return; onAddSession({ date: newSessionDate, summary: `关于 ${newSessionDate} 的咨询` }); setShowAddSession(false); };
      
      const SessionCard = ({ session }) => {
        const fileInputRef = useRef(null);
        const status = session.conceptualization?.status;
        const colorMap = { Pending: 'yellow', Processing: 'blue', Complete: 'green', Error: 'red' };
        const statusColor = colorMap[status] || 'gray';

        const handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (file) onFileUpload(session.id, file);
        };
        return (
            <div className={`p-4 bg-white rounded-lg border border-gray-200 shadow-sm transition-all ${status === 'Processing' && 'animate-pulse'}`}>
                <div className="flex justify-between items-start">
                    <p className="font-semibold text-gray-800">咨询日期: {session.date}</p>
                    {session.transcript && <div className={`text-xs font-medium px-2 py-0.5 rounded-full bg-${statusColor}-100 text-${statusColor}-800`}>报告状态: {status}</div>}
                </div>
                <div className="mt-3 p-3 bg-gray-50 rounded-md text-center">
                    <p className="text-sm font-medium text-gray-600">咨询逐字稿</p>
                    {session.transcript ? (<div className="text-green-600 mt-1 flex items-center justify-center gap-2"><span className="text-xl">✅</span><p className="text-xs break-all font-mono">{session.transcript.name}</p></div>) : (
                        <>
                            <input type="file" ref={fileInputRef} onChange={handleFileSelect} className="hidden" accept=".txt,.md,.docx"/>
                            <button onClick={() => fileInputRef.current.click()} disabled={isAiLoading} className="mt-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-3 rounded shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">上传并生成AI报告</button>
                        </>
                    )}
                </div>
            </div>
        );
      }
      const referrer = client.referredBy ? allClients.find(c => c.id === client.referredBy) : null;
      const referredList = client.referredClients?.map(id => allClients.find(c => c.id === id)).filter(Boolean);
      return (
        <div className="space-y-6">
            <div className="p-4 bg-gray-50 rounded-lg border">
                <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><span className="mr-2">ℹ️</span>基本信息</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-sm">
                    <p><strong>姓名:</strong> {client.name}</p><p><strong>年龄:</strong> {client.age} 岁</p><p><strong>性别:</strong> {client.gender}</p>
                    <p><strong>职业/年级:</strong> {client.grade || '未提供'}</p><p><strong>性取向:</strong> {client.sexualOrientation || '未提供'}</p><p><strong>联系方式:</strong> {client.contact || '未提供'}</p>
                    <p><strong>转介绍来源:</strong> {referrer ? referrer.name : '无'}</p><p><strong>已转介绍:</strong> {referredList?.length > 0 ? referredList.map(c => c.name).join(', ') : '无'}</p><p><strong>心理状态评分:</strong> {client.mentalStateScore}/10</p>
                    <p className="md:col-span-3"><strong>既往病史:</strong> {client.historyOfIllness || '未提供'}</p>
                    <p className="md:col-span-3"><strong>残障情况:</strong> {client.disabilityStatus || '未提供'}</p>
                    <p><strong>宗教信仰:</strong> {client.religiousBelief || '未提供'}</p><p><strong>种族认同:</strong> {client.ethnicIdentity || '未提供'}</p>
                    <p><strong>个人经济:</strong> {client.personalFinance || '未提供'}</p><p><strong>家庭经济:</strong> {client.familyFinance || '未提供'}</p>
                </div>
            </div>
            <div>
                <div className="flex justify-between items-center mb-3"><h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="mr-2">📅</span>咨询会话工作流</h3><button onClick={() => setShowAddSession(true)} className="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md shadow-sm">添加新会话</button></div>
                {showAddSession && (<div className="p-4 mb-4 bg-blue-50 border rounded-lg flex items-center gap-4 animate-fadeIn"><input type="date" value={newSessionDate} onChange={e => setNewSessionDate(e.target.value)} className="p-2 border rounded-md"/><button onClick={handleCreateSession} className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md shadow-sm">创建</button><button onClick={() => setShowAddSession(false)} className="text-gray-600">取消</button></div>)}
                <div className="space-y-4">{client.sessions?.length > 0 ? [...client.sessions].reverse().map(session => <SessionCard key={session.id} session={session} />) : <p className="text-center text-gray-500 py-4">暂无咨询会话记录。</p>}</div>
            </div>
        </div>
      );
    };

    const ReportDisplayTab = ({ client, reportType, title, themeColor }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s[reportType] && s[reportType].status !== 'Pending');
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions.reverse()[0] : null);
        
        useEffect(() => {
            const sessions = (client.sessions || []).filter(s => s[reportType]?.status !== 'Pending');
            if (sessions.length > 0 && !sessions.some(s => s.id === selectedSession?.id)) {
                setSelectedSession(sessions.reverse()[0]);
            } else if (sessions.length === 0) {
                setSelectedSession(null);
            }
        }, [client, reportType, selectedSession]);

        const report = selectedSession ? selectedSession[reportType] : null;

        return (
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">历史记录</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无记录。</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? `bg-${themeColor}-100 border-${themeColor}-500` : `bg-white hover:bg-gray-100 border-transparent`}`}><p className={`font-semibold text-${themeColor}-600`}>咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 text-${session[reportType].status === 'Complete' ? 'green-600' : 'red-600'}`}>状态: {session[reportType].status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">{title}详情</h3>{report ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className={`font-bold text-lg text-${themeColor}-700`}>关于 {selectedSession.date} 咨询的{title}</h4><button onClick={()=>downloadTextAsFile(report.content, `${client.name}_${selectedSession.date}_${reportType}.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded hover:bg-gray-700">下载</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{report.content}</div></div> : <p className="text-gray-500 text-center pt-10">请从左侧选择记录查看。</p>}</div>
            </div>
        );
    }

    const SupervisionReportTab = ({ client, onSupervisionFileUploaded, isAiLoading }) => {
        const { useState, useEffect, useRef } = React;
        const eligibleSessions = (client.sessions || []).filter(s => s.transcript);
        const [selectedSession, setSelectedSession] = useState(eligibleSessions.length > 0 ? eligibleSessions[0] : null);
        useEffect(() => { const sessions = (client.sessions || []).filter(s => s.transcript); setSelectedSession(sessions.length > 0 ? sessions.reverse()[0] : null); }, [client]);
        
        const SupervisionWorkflow = ({ session }) => {
            const conceptualizationInputRef = useRef(null);
            const assessmentInputRef = useRef(null);
            const handleFileSelect = (event, fileType) => {
                const file = event.target.files[0];
                if(file) onSupervisionFileUploaded(session.id, fileType, file);
            }
            const isReadyForGeneration = session.supervision.conceptualizationUploaded && session.supervision.assessmentUploaded;

            return (
                <div className="p-4 bg-white border rounded-lg h-full space-y-4">
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">第1步: 上传已生成的报告（用于督导）</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><p className="text-sm text-center mb-1">个案概念化报告</p><button onClick={() => conceptualizationInputRef.current.click()} disabled={session.supervision.conceptualizationUploaded || session.conceptualization?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400 disabled:cursor-not-allowed">{session.supervision.conceptualizationUploaded ? `✅ 已上传` : '上传 .txt 文件'}</button><input type="file" ref={conceptualizationInputRef} onChange={(e) => handleFileSelect(e, 'conceptualization')} className="hidden" accept=".txt"/></div>
                            <div><p className="text-sm text-center mb-1">来访者评估报告</p><button onClick={() => assessmentInputRef.current.click()} disabled={session.supervision.assessmentUploaded || session.assessment?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400 disabled:cursor-not-allowed">{session.supervision.assessmentUploaded ? `✅ 已上传` : '上传 .txt 文件'}</button><input type="file" ref={assessmentInputRef} onChange={(e) => handleFileSelect(e, 'assessment')} className="hidden" accept=".txt"/></div>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">提示：请先确保初步报告已生成(状态为Complete)。上传两份报告后将自动触发最终督导报告生成。</p>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">第2步: 查看最终督导报告</h4>
                        {session.supervision.status === 'Processing' && <p className="text-sm text-blue-600 animate-pulse">正在生成中...</p>}
                        {session.supervision.status === 'Complete' ? <button onClick={()=>downloadTextAsFile(session.supervision.content, `${client.name}_${selectedSession.date}_督导报告.txt`)} className="text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow-sm">下载督导报告</button> : <p className="text-sm text-gray-500">状态: {session.supervision.status === 'Pending' ? '待上传文件' : session.supervision.status}</p>}
                        {session.supervision.status === 'Error' && <p className="text-sm text-red-600">{session.supervision.content}</p>}
                    </div>
                </div>
            );
        };
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">会话列表</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{eligibleSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无符合条件的会话。</p> : [...eligibleSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? 'bg-blue-100 border-blue-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-blue-600">咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.supervision.status === 'Complete' ? 'text-green-600' : 'text-yellow-600'}`}>督导状态: {session.supervision.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">AI督导工作流</h3>{selectedSession ? <SupervisionWorkflow session={selectedSession}/> : <p className="text-gray-500 text-center pt-10">请从左侧选择一个会话以开始督导流程。</p>}</div>
            </div>
        );
    };

    const CBTSection = ({ showAlert }) => {
      return (
          <div className="bg-white p-6 rounded-lg shadow-md animate-fadeIn max-w-4xl mx-auto">
              <h2 className="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3 flex items-center"><span className="text-2xl mr-3">🧠</span>辅助工具</h2>
              <div className="text-center p-8 bg-gray-50 rounded-lg">
                  <h3 className="text-xl font-bold text-gray-600">功能开发中</h3>
                  <p className="mt-2 text-gray-500">此模块（如CBT练习工具）正在积极开发中，敬请期待未来的更新！</p>
              </div>
          </div>
      );
    };

    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
