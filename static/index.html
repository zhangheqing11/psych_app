<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>心理咨询师助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- Helper function for API calls ---
    const callApi = async ({ systemPrompt, userPrompt, model = 'deepseek-chat', onChunk, onError }) => {
      const apiURL = `${window.location.origin}/api/call-ai`;
      const isStreaming = onChunk && typeof onChunk === 'function';

      try {
        const response = await fetch(apiURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model, systemPrompt, userPrompt, stream: isStreaming }),
        });
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        
        if (isStreaming) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullResponse = "";
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value);
              const lines = chunk.split("\n");
              for (const line of lines) {
                if (line.startsWith("data: ")) {
                  const dataStr = line.substring(6).trim();
                  if (dataStr === "[DONE]") return fullResponse;
                  try {
                    const data = JSON.parse(dataStr);
                    const deltaContent = data.choices[0]?.delta?.content;
                    if (deltaContent) { fullResponse += deltaContent; onChunk(deltaContent); }
                  } catch (e) { console.error("Error parsing stream data:", e); }
                }
              }
            }
            return fullResponse;
        } else {
             const data = await response.json();
             return data.choices[0].message.content;
        }

      } catch (err) {
        onError(err.message);
        return `对后端服务器的API调用失败: ${err.message}`;
      }
    };
    
    const downloadTextAsFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- Mock Initial Data ---
    const initialClients = [
      { 
        id: 'client-001', name: '王芳', age: 32, gender: '女', grade: '在职', sexualOrientation: '异性恋',
        contact: '138********', joinDate: '2023-10-15', referredBy: null, referredClients: ['client-002'],
        historyOfIllness: '无重大既往史', mentalStateScore: 7, disabilityStatus: '无', religiousBelief: '无',
        ethnicIdentity: '汉族', personalFinance: '稳定', familyFinance: '良好',
        sessions: [
          { 
            id: 'session-001-1', date: '2023-10-15', summary: '首次访谈，建立咨询关系。',
            transcript: { name: '首次访谈逐字稿.docx', content: '模拟的逐字稿内容...' },
            conceptualization: { status: 'Complete', content: 'AI生成的个案概念化报告示例内容...' },
            assessment: { status: 'Complete', content: 'AI生成的来访者评估报告示例内容...' },
            supervision: { status: 'Pending', conceptualizationUploaded: false, assessmentUploaded: false, content: null }
          },
        ]
      },
      { 
        id: 'client-002', name: '李明', age: 28, gender: '男', grade: '硕士在读', sexualOrientation: '未提供',
        contact: '159********', joinDate: '2024-01-20', referredBy: 'client-001', referredClients: [],
        historyOfIllness: '无', mentalStateScore: 5, disabilityStatus: '无', religiousBelief: '无',
        ethnicIdentity: '汉族', personalFinance: '依赖家庭', familyFinance: '中等',
        sessions: []
      },
    ];

    // --- PROMPTS ---
    const getConceptualizationPrompt = () => `...`;
    const getAssessmentPrompt = () => `...`;
    const getSupervisionPrompt = () => `...`;

    // --- Main Application Component ---
    const App = () => {
      const { useState, useEffect } = React;
      const [activeSection, setActiveSection] = useState('clientManagement');
      const [clients, setClients] = useState(() => {
        try { return JSON.parse(localStorage.getItem('psychClients')) || initialClients; } 
        catch (e) { return initialClients; }
      });
      const [selectedClient, setSelectedClient] = useState(null);
      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');

      useEffect(() => { localStorage.setItem('psychClients', JSON.stringify(clients)); }, [clients]);

      const handleUpdateClient = (updatedClientData, callback) => {
        let newClientsState = [...clients];
        const oldClientState = newClientsState.find(c => c.id === updatedClientData.id);
        
        if (oldClientState) {
            const oldReferredBy = oldClientState.referredBy;
            const newReferredBy = updatedClientData.referredBy;
            if (oldReferredBy !== newReferredBy) {
              if (oldReferredBy) {
                const oldReferrerIndex = newClientsState.findIndex(c => c.id === oldReferredBy);
                if (oldReferrerIndex > -1) { newClientsState[oldReferrerIndex].referredClients = newClientsState[oldReferrerIndex].referredClients.filter(id => id !== updatedClientData.id); }
              }
              if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1) { if (!newClientsState[newReferrerIndex].referredClients.includes(updatedClientData.id)) { newClientsState[newReferrerIndex].referredClients.push(updatedClientData.id); } }
              }
            }
        }
        
        const clientIndex = newClientsState.findIndex(c => c.id === updatedClientData.id);
        if (clientIndex > -1) { newClientsState[clientIndex] = updatedClientData; } 
        else {
            newClientsState.push(updatedClientData);
            const newReferredBy = updatedClientData.referredBy;
            if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1 && !newClientsState[newReferrerIndex].referredClients.includes(updatedClientData.id)) {
                    newClientsState[newReferrerIndex].referredClients.push(updatedClientData.id);
                }
            }
        }
        
        setClients(newClientsState);
        if (selectedClient?.id === updatedClientData.id || !oldClientState) { setSelectedClient(updatedClientData); }
        if (callback) callback(updatedClientData);
      };

      const handleAddClient = (newClient, clientToEdit) => {
        if(clientToEdit) {
          handleUpdateClient(newClient, clientToEdit);
        } else {
          const clientWithDefaults = { ...newClient, id: `client-${Date.now()}`, sessions: [], joinDate: new Date().toISOString().split('T')[0], referredBy: newClient.referredBy || null, referredClients: [] };
          handleUpdateClient(clientWithDefaults);
          setSelectedClient(clientWithDefaults); 
          setActiveSection('clientDetail');
        }
      };
      
      const handleDeleteClient = (clientId) => {
        const clientToDelete = clients.find(c => c.id === clientId);
        if (!clientToDelete) return;
        let updatedClients = clients.filter(client => client.id !== clientId);
        updatedClients = updatedClients.map(client => {
          if (client.referredBy === clientId) { return { ...client, referredBy: null }; }
          if (client.referredClients.includes(clientId)) { return { ...client, referredClients: client.referredClients.filter(id => id !== clientId) }; }
          return client;
        });
        console.warn(`尝试删除来访者 ${clientToDelete?.name}。`);
        setClients(updatedClients);
        if (selectedClient?.id === clientId) { setSelectedClient(null); setActiveSection('clientManagement'); }
      };

      const handleSelectClient = (client) => { setSelectedClient(client); setActiveSection('clientDetail'); };
      
      const renderSection = () => {
        switch (activeSection) {
          case 'clientManagement':
            return <ClientManagementSection clients={clients} onAddClient={handleAddClient} onSelectClient={handleSelectClient} />;
          case 'clientDetail':
            return selectedClient ? 
                   <ClientDetailView 
                      key={selectedClient.id} 
                      client={selectedClient} 
                      allClients={clients} 
                      onUpdateClient={handleUpdateClient} 
                      onDeleteClient={handleDeleteClient}
                      setGlobalLoadingMessage={setGlobalLoadingMessage}
                    /> : 
                   <div className="text-center p-10 text-gray-500">请先从列表中选择一位来访者。</div>;
          case 'cbtApplication':
            return <CBTSection />;
          default:
            return <ClientManagementSection clients={clients} onAddClient={handleAddClient} onSelectClient={handleSelectClient} />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-100 flex flex-col">
          <div className="bg-gray-800 text-white shadow-lg"><div className="container mx-auto px-4"><div className="flex items-center justify-between h-16"><div className="flex items-center"><span className="text-2xl mr-3">💌</span><h1 className="text-xl font-bold">心理咨询师助手</h1></div><div className="flex items-baseline space-x-4"><button onClick={()=>setActiveSection('clientManagement')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeSection!=='cbtApplication'?'bg-gray-900':'text-gray-300 hover:bg-gray-700'}`}><span className="mr-2">👥</span>来访者管理</button><button onClick={()=>setActiveSection('cbtApplication')} className={`px-3 py-2 ml-4 rounded-md text-sm font-medium flex items-center ${activeSection==='cbtApplication'?'bg-gray-900':'text-gray-300 hover:bg-gray-700'}`}><span className="mr-2">🛠️</span>咨询流程辅助工具 (待开发)</button></div></div></div></div>
          {globalLoadingMessage && (<div className="bg-yellow-400 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center"><span className="mr-2">⏳</span>{globalLoadingMessage}</div>)}
          <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
        </div>
      );
    };

    const ClientManagementSection = ({ clients, onAddClient, onSelectClient }) => {
        const { useState } = React;
        const [showAddClientModal, setShowAddClientModal] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const filteredClients = clients.filter(client => client.name.toLowerCase().includes(searchTerm.toLowerCase()));
        return (
            <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
            <div className="flex justify-between items-center mb-6 pb-4 border-b"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">👥</span>来访者管理</h2><button onClick={() => setShowAddClientModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><span className="mr-2">➕</span>添加新来访</button></div>
            <input type="text" placeholder="搜索来访者姓名..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 mb-4 border rounded-lg"/>
            {filteredClients.length > 0 ? (
                <ul className="space-y-3">{filteredClients.map(client => (<li key={client.id} onClick={() => onSelectClient(client)} className="bg-gray-50 hover:bg-blue-50 border rounded-lg p-4 cursor-pointer flex justify-between items-center"><div><p className="text-lg font-medium text-blue-700">{client.name} <span className="text-sm text-gray-500">({client.gender}, {client.age}岁)</span></p><p className="text-sm text-gray-600">加入日期: {client.joinDate}</p></div><span className="text-gray-400">❯</span></li>))}</ul>
            ) : <p className="text-center text-gray-500 py-8">暂无匹配的来访者。</p>}
            {showAddClientModal && <AddClientModal onClose={() => setShowAddClientModal(false)} onAddClient={onAddClient} allClients={clients} />}
            </div>
        );
    };

    const AddClientModal = ({ onClose, onAddClient, clientToEdit, allClients }) => {
      const { useState } = React;
      const [formData, setFormData] = useState({
        name: clientToEdit?.name || '', age: clientToEdit?.age || '', gender: clientToEdit?.gender || '未透露',
        grade: clientToEdit?.grade || '', sexualOrientation: clientToEdit?.sexualOrientation || '',
        contact: clientToEdit?.contact || '', referredBy: clientToEdit?.referredBy || '',
        historyOfIllness: clientToEdit?.historyOfIllness || '', mentalStateScore: clientToEdit?.mentalStateScore || '5',
        disabilityStatus: clientToEdit?.disabilityStatus || '', religiousBelief: clientToEdit?.religiousBelief || '',
        ethnicIdentity: clientToEdit?.ethnicIdentity || '', personalFinance: clientToEdit?.personalFinance || '',
        familyFinance: clientToEdit?.familyFinance || '',
      });
      const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
      const handleSubmit = (e) => {
        e.preventDefault(); if (!formData.name.trim() || !formData.age) { console.warn('姓名和年龄为必填项。'); return; }
        const clientData = { ...formData, age: parseInt(formData.age), referredBy: formData.referredBy || null };
        const dataToSubmit = clientToEdit ? { ...clientToEdit, ...clientData } : clientData;
        onAddClient(dataToSubmit, clientToEdit); onClose();
      };
      const potentialReferrers = allClients.filter(c => c.id !== clientToEdit?.id);
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
          <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 z-10"><h3 className="text-xl font-semibold">{clientToEdit ? '编辑' : '添加'}来访者信息</h3><button onClick={onClose} className="text-gray-500">❌</button></div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium">姓名 <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">年龄 <span className="text-red-500">*</span></label><input type="number" name="age" value={formData.age} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">性别</label><select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-2 border rounded-md"><option>未透露</option><option>男</option><option>女</option><option>其他</option></select></div>
                <div><label className="block text-sm font-medium">在读年级</label><input type="text" name="grade" value={formData.grade} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">性取向</label><input type="text" name="sexualOrientation" value={formData.sexualOrientation} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">联系方式</label><input type="text" name="contact" value={formData.contact} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">被...介绍</label><select name="referredBy" value={formData.referredBy || ''} onChange={handleChange} className="w-full p-2 border rounded-md"><option value="">无</option>{potentialReferrers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div><label className="block text-sm font-medium">心理状态评分(1-10)</label><select name="mentalStateScore" value={formData.mentalStateScore} onChange={handleChange} className="w-full p-2 border rounded-md">{[...Array(10).keys()].map(i => <option key={i+1} value={i+1}>{i+1}</option>)}</select></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">既往病史</label><input type="text" name="historyOfIllness" value={formData.historyOfIllness} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">残障情况</label><input type="text" name="disabilityStatus" value={formData.disabilityStatus} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">宗教信仰</label><input type="text" name="religiousBelief" value={formData.religiousBelief} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">种族认同</label><input type="text" name="ethnicIdentity" value={formData.ethnicIdentity} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">个人经济</label><input type="text" name="personalFinance" value={formData.personalFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">家庭经济</label><input type="text" name="familyFinance" value={formData.familyFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
              </div>
              <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-100 rounded-md border">取消</button><button type="submit" className="px-4 py-2 text-white bg-blue-600 rounded-md flex items-center"><span className="mr-2">💾</span>{clientToEdit ? '保存' : '添加'}</button></div>
            </form>
          </div>
        </div>
      );
    };

    const ClientDetailView = ({ client, allClients, onUpdateClient, onDeleteClient, setGlobalLoadingMessage }) => {
      const { useState } = React;
      const [activeTab, setActiveTab] = useState('profile');
      const [showEditModal, setShowEditModal] = useState(false);
      const [isAiLoading, setIsAiLoading] = useState(false);

      const tabs = [{ id: 'profile', label: '档案与会话', icon: '👤' }, { id: 'conceptualization', label: 'AI个案概念化', icon: '📜' },{ id: 'supervision', label: 'AI督导', icon: '🔬' },{ id: 'analysis', label: '来访者评估', icon: '📊' }];
      
      const handleAddSession = (newSessionData) => {
        const newSession = { id: `session-${client.id}-${Date.now()}`, ...newSessionData, transcript: null, conceptualization: { status: 'Pending' }, assessment: { status: 'Pending' }, supervision: { status: 'Pending', conceptualizationUploaded: false, assessmentUploaded: false } };
        onUpdateClient({ ...client, sessions: [...(client.sessions || []), newSession] });
      };

      const handleFileUpload = async (sessionId, file) => {
        if (!file) return;

        setGlobalLoadingMessage(`正在上传文件并为 ${client.name} 生成初步报告...`);
        setIsAiLoading(true);

        const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
        if (sessionIndex === -1) { setGlobalLoadingMessage(''); setIsAiLoading(false); return; }

        let updatedClient = JSON.parse(JSON.stringify(client));
        updatedClient.sessions[sessionIndex].conceptualization.status = 'Processing';
        updatedClient.sessions[sessionIndex].assessment.status = 'Processing';
        onUpdateClient(updatedClient);

        const formData = new FormData();
        formData.append('transcript', file);
        formData.append('client_info', JSON.stringify(client));

        try {
            const response = await fetch('/api/upload-and-analyze', { method: 'POST', body: formData });
            if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `服务器错误: ${response.status}`); }
            const result = await response.json();
            
            const finalClient = JSON.parse(JSON.stringify(updatedClient));
            finalClient.sessions[sessionIndex].transcript = { name: result.uploadedFileName, content: '（内容在服务器端处理）' };
            finalClient.sessions[sessionIndex].conceptualization = result.conceptualization;
            finalClient.sessions[sessionIndex].assessment = result.assessment;
            onUpdateClient(finalClient);
        } catch (error) {
            console.error('文件上传或分析失败:', error);
            const errorClient = JSON.parse(JSON.stringify(updatedClient));
            errorClient.sessions[sessionIndex].conceptualization = {status: 'Error', content: error.message};
            errorClient.sessions[sessionIndex].assessment = {status: 'Error', content: error.message};
            onUpdateClient(errorClient);
        } finally {
            setGlobalLoadingMessage('');
            setIsAiLoading(false);
        }
      };
      
      const handleSupervisionFileUploaded = async (sessionId, fileType) => {
          const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
          if (sessionIndex === -1) return;
          
          let updatedClient = JSON.parse(JSON.stringify(client));
          updatedClient.sessions[sessionIndex].supervision[fileType + 'Uploaded'] = true;
          
          onUpdateClient(updatedClient, async (finalUpdatedClient) => {
              const finalSession = finalUpdatedClient.sessions.find(s => s.id === sessionId);
              if(finalSession.supervision.conceptualizationUploaded && finalSession.supervision.assessmentUploaded && finalSession.supervision.status !== 'Complete' && finalSession.supervision.status !== 'Processing') {
                  await triggerSupervisionGeneration(finalUpdatedClient, sessionId);
              }
          });
      };
      
      const triggerSupervisionGeneration = async (clientForSupervision, sessionId) => {
          setGlobalLoadingMessage(`正在为 ${clientForSupervision.name} 生成最终督导报告...`);
          setIsAiLoading(true);
          const sessionIndex = clientForSupervision.sessions.findIndex(s => s.id === sessionId);
          
          let processingClient = JSON.parse(JSON.stringify(clientForSupervision));
          processingClient.sessions[sessionIndex].supervision.status = 'Processing';
          onUpdateClient(processingClient);

          try {
              const currentSession = processingClient.sessions[sessionIndex];
              const response = await fetch('/api/generate-supervision', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_info: clientForSupervision,
                    transcript_content: currentSession.transcript.content,
                    conceptualization_content: currentSession.conceptualization.content,
                    assessment_content: currentSession.assessment.content
                })
              });
              if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `服务器错误: ${response.status}`); }
              const result = await response.json();
              
              let finalClient = JSON.parse(JSON.stringify(processingClient));
              finalClient.sessions[sessionIndex].supervision = { 
                  ...finalClient.sessions[sessionIndex].supervision,
                  status: 'Complete', 
                  content: result.supervision.content 
              };
              onUpdateClient(finalClient);
          } catch(error) {
              let errorClient = JSON.parse(JSON.stringify(processingClient));
              errorClient.sessions[sessionIndex].supervision = { ...errorClient.sessions[sessionIndex].supervision, status: 'Error', content: error.message };
              onUpdateClient(errorClient);
          } finally {
              setGlobalLoadingMessage('');
              setIsAiLoading(false);
          }
      };

      const renderTabContent = () => {
        switch (activeTab) {
          case 'profile': return <ClientProfileTab client={client} allClients={allClients} onAddSession={handleAddSession} onFileUpload={handleFileUpload} isAiLoading={isAiLoading} />;
          case 'conceptualization': return <ConceptualizationTab client={client} />;
          case 'supervision': return <SupervisionReportTab client={client} onSupervisionFileUploaded={handleSupervisionFileUploaded} />;
          case 'analysis': return <AnalysisReportTab client={client} />;
          default: return null;
        }
      };

      return (
        <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
          <div className="flex flex-col md:flex-row justify-between md:items-center mb-4 pb-4 border-b gap-4"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-3xl">👤</span>{client.name} - 档案中心</h2><div><button onClick={() => setShowEditModal(true)} className="text-sm text-blue-600 mr-4 flex items-center"><span className="mr-1">✏️</span>编辑</button><button onClick={() => onDeleteClient(client.id)} className="text-sm text-red-500 flex items-center"><span className="mr-1">🗑️</span>删除</button></div></div>
          <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-6 overflow-x-auto">{tabs.map(tab => <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-shrink-0 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center ${activeTab === tab.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><span className="mr-2">{tab.icon}</span>{tab.label}</button>)}</nav></div>
          <div className="pt-6">{renderTabContent()}</div>
          {showEditModal && <AddClientModal onClose={() => setShowEditModal(false)} onAddClient={onUpdateClient} clientToEdit={client} allClients={allClients}/>}
        </div>
      );
    };
    
    const ClientProfileTab = ({ client, allClients, onAddSession, onFileUpload, isAiLoading }) => {
      const { useState, useRef } = React;
      const [showAddSession, setShowAddSession] = useState(false);
      const [newSessionDate, setNewSessionDate] = useState(new Date().toISOString().split('T')[0]);
      const handleCreateSession = () => { if (!newSessionDate) return; onAddSession({ date: newSessionDate, summary: `关于 ${newSessionDate} 的咨询` }); setShowAddSession(false); };
      
      const SessionCard = ({ session }) => {
        const fileInputRef = useRef(null);
        const status = session.conceptualization?.status === 'Processing' || session.assessment?.status === 'Processing' ? 'Processing' : 
                       (session.conceptualization?.status === 'Complete' && session.assessment?.status === 'Complete') ? 'Complete' : 'Pending';
        
        const handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (file) onFileUpload(session.id, file);
        };

        return (
            <div className={`p-4 bg-white rounded-lg border border-gray-300 shadow-sm ${status === 'Processing' && 'animate-pulse'}`}>
                <p className="font-semibold text-gray-800">咨询日期: {session.date}</p>
                <div className="mt-3 p-3 bg-gray-50 rounded-md text-center">
                    <p className="text-sm font-medium text-gray-600">咨询逐字稿</p>
                    {session.transcript ? (<div className="text-green-600 mt-1"><span className="text-xl">✅</span><p className="text-xs break-all">{session.transcript.name}</p></div>) : (
                        <>
                            <input type="file" ref={fileInputRef} onChange={handleFileSelect} className="hidden" accept=".txt,.md,.docx"/>
                            <button onClick={() => fileInputRef.current.click()} disabled={isAiLoading} className="mt-1 text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:opacity-50">上传并生成AI内容</button>
                        </>
                    )}
                </div>
                {session.transcript && <div className="mt-3 text-center text-xs text-gray-500">✨ 初步报告状态: <span className={status === 'Complete' ? 'text-green-600' : 'text-yellow-600'}>{status}</span></div>}
            </div>
        );
      }
      const referrer = client.referredBy ? allClients.find(c => c.id === client.referredBy) : null;
      const referredList = client.referredClients?.map(id => allClients.find(c => c.id === id)).filter(Boolean);
      return (
        <div className="space-y-6">
            <div className="p-4 bg-gray-50 rounded-lg border">
                <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><span className="mr-2">ℹ️</span>基本信息</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-sm">
                    <p><strong>姓名:</strong> {client.name}</p><p><strong>年龄:</strong> {client.age} 岁</p><p><strong>性别:</strong> {client.gender}</p>
                    <p><strong>在读年级:</strong> {client.grade || '未提供'}</p><p><strong>性取向:</strong> {client.sexualOrientation || '未提供'}</p><p><strong>联系方式:</strong> {client.contact || '未提供'}</p>
                    <p><strong>被...介绍:</strong> {referrer ? referrer.name : '无'}</p><p><strong>介绍...:</strong> {referredList?.length > 0 ? referredList.map(c => c.name).join(', ') : '无'}</p><p><strong>心理状态评分:</strong> {client.mentalStateScore}/10</p>
                    <p className="md:col-span-3"><strong>既往病史:</strong> {client.historyOfIllness || '未提供'}</p>
                    <p className="md:col-span-3"><strong>残障情况:</strong> {client.disabilityStatus || '未提供'}</p>
                    <p><strong>宗教信仰:</strong> {client.religiousBelief || '未提供'}</p><p><strong>种族认同:</strong> {client.ethnicIdentity || '未提供'}</p>
                    <p><strong>个人经济:</strong> {client.personalFinance || '未提供'}</p><p><strong>家庭经济:</strong> {client.familyFinance || '未提供'}</p>
                </div>
            </div>
            <div>
                <div className="flex justify-between items-center mb-3"><h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="mr-2">📅</span>咨询会话工作流</h3><button onClick={() => setShowAddSession(true)} className="text-sm bg-blue-600 text-white py-1 px-3 rounded-md">添加新会话</button></div>
                {showAddSession && (<div className="p-4 mb-4 bg-blue-50 border rounded-lg flex items-center gap-4"><input type="date" value={newSessionDate} onChange={e => setNewSessionDate(e.target.value)} className="p-2 border rounded-md"/><button onClick={handleCreateSession} className="bg-blue-500 text-white py-2 px-4 rounded-md">创建</button><button onClick={() => setShowAddSession(false)} className="text-gray-600">取消</button></div>)}
                <div className="space-y-4">{client.sessions?.length > 0 ? [...client.sessions].reverse().map(session => <SessionCard key={session.id} session={session} />) : <p className="text-center text-gray-500 py-4">暂无咨询会话记录。</p>}</div>
            </div>
        </div>
      );
    };
    
    const ConceptualizationTab = ({ client }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s.conceptualization && s.conceptualization.status !== 'Pending');
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions[0] : null);
        useEffect(() => { const sessions = (client.sessions || []).filter(s => s.conceptualization?.status !== 'Pending'); setSelectedSession(sessions.length > 0 ? sessions[0] : null); }, [client]);
        return (
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">历史记录</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无记录。</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? 'bg-indigo-100 border-indigo-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-indigo-600">咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.conceptualization.status === 'Complete' ? 'text-green-600' : 'text-red-600'}`}>状态: {session.conceptualization.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">个案概念化详情</h3>{selectedSession ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-lg text-indigo-700">关于 {selectedSession.date} 咨询的AI个案概念化</h4><button onClick={()=>downloadTextAsFile(selectedSession.conceptualization.content, `${client.name}_${selectedSession.date}_个案概念化.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded">下载</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{selectedSession.conceptualization.content}</div></div> : <p className="text-gray-500 text-center pt-10">请从左侧选择记录查看。</p>}</div>
            </div>
        );
    }
    const SupervisionReportTab = ({ client, onSupervisionFileUploaded }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s.transcript);
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions[0] : null);
        useEffect(() => { const sessions = (client.sessions || []).filter(s => s.transcript); setSelectedSession(sessions.length > 0 ? sessions[0] : null); }, [client]);
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">会话列表</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无会话。</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? 'bg-blue-100 border-blue-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-blue-600">咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.supervision.status === 'Complete' ? 'text-green-600' : 'text-yellow-600'}`}>{session.supervision.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">AI督导工作流</h3>{selectedSession ? <div className="p-4 bg-white border rounded-lg h-full space-y-4">
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">第1步: 上传AI生成的报告</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <div><p className="text-sm text-center mb-1">个案概念化</p><button onClick={() => onSupervisionFileUploaded(selectedSession.id, 'conceptualization')} disabled={selectedSession.supervision.conceptualizationUploaded || selectedSession.conceptualization?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400">{selectedSession.supervision.conceptualizationUploaded ? '已上传✅' : '上传'}</button></div>
                            <div><p className="text-sm text-center mb-1">来访者评估</p><button onClick={() => onSupervisionFileUploaded(selectedSession.id, 'assessment')} disabled={selectedSession.supervision.assessmentUploaded || selectedSession.assessment?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400">{selectedSession.supervision.assessmentUploaded ? '已上传✅' : '上传'}</button></div>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">请先确保概念化和评估报告已生成。上传后将自动触发最终督导报告生成。</p>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">第2步: 查看最终督导报告</h4>
                        {selectedSession.supervision.status === 'Complete' ? <button onClick={()=>downloadTextAsFile(selectedSession.supervision.content, `${client.name}_${selectedSession.date}_督导报告.txt`)} className="text-sm bg-green-500 text-white py-2 px-4 rounded">下载督导报告</button> : <p className="text-sm text-gray-500">状态: {selectedSession.supervision.status}</p>}
                    </div>
                </div> : <p className="text-gray-500 text-center pt-10">请从左侧选择一个会话以开始督导流程。</p>}</div>
            </div>
        );
    };

    const AnalysisReportTab = ({ client }) => {
        const { useState, useEffect } = React;
        const aiReports = (client.sessions || []).filter(s => s.assessment && s.assessment.status !== 'Pending');
        const [selectedReportSession, setSelectedReportSession] = useState(aiReports.length > 0 ? aiReports[0] : null);
        useEffect(() => { const reports = (client.sessions || []).filter(s => s.assessment && s.assessment.status !== 'Pending'); setSelectedReportSession(reports.length > 0 ? reports[0] : null); }, [client]);
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">历史评估</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiReports.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">暂无AI评估报告。</p> : [...aiReports].reverse().map(session => <li key={session.id} onClick={() => setSelectedReportSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedReportSession?.id === session.id ? 'bg-green-100 border-green-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-green-600">咨询日期: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.assessment.status === 'Complete' ? 'text-green-600' : 'text-red-600'}`}>状态: {session.assessment.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">评估详情</h3>{selectedReportSession ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-lg text-green-700">关于 {selectedReportSession.date} 咨询的评估报告</h4><button onClick={()=>downloadTextAsFile(selectedReportSession.assessment.content, `${client.name}_${selectedReportSession.date}_评估报告.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded">下载</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{selectedReportSession.assessment.content}</div></div> : <p className="text-gray-500 text-center pt-10">请选择报告查看。</p>}</div>
            </div>
        );
    };

    const CBTSection = ({...props}) => {
      const { useState } = React;
      const [userInput, setUserInput] = useState('');
      const [modelResponse, setModelResponse] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      const [activeModel, setActiveModel] = useState(null);
      const handleCBTInteraction = async (model) => {
          if (!userInput.trim()) { console.warn('请输入。'); return; }
          setIsLoading(true); setActiveModel(model); setError(null); setModelResponse(''); 
          const systemPrompt = "你是一位专业的CBT心理咨询师。你的任务是以共情、支持和引导的方式与用户对话。帮助用户识别、挑战和重构他们的自动化负性思维。使用苏格拉底式提问，并提供关于CBT概念的心理教育。你必须使用中文进行回复。";
          await callApi({ systemPrompt, userPrompt: userInput, model, onChunk: (chunk) => setModelResponse(prev => prev + chunk), onError: (err) => setError(`抱歉，与AI模型通信失败: ${err}`) });
          setIsLoading(false); setActiveModel(null);
      };
      const LoadingSpinner = () => <svg className="animate-spin mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
      return (
          <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn max-w-4xl mx-auto">
          <h2 className="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3 flex items-center"><span className="text-2xl mr-3">🧠</span>CBT辅助工具</h2>
          <div className="mb-4"><label htmlFor="cbtInput" className="block text-md font-medium text-gray-700 mb-2">请输入一个自动化思维、困扰情境或想要探讨的问题：</label><textarea id="cbtInput" value={userInput} onChange={(e) => setUserInput(e.target.value)} rows="5" placeholder="例如：我总是担心别人怎么看我，觉得自己不够好..." className="w-full p-3 border rounded-lg"/></div>
          <div className="flex items-center space-x-4">
              <button onClick={() => handleCBTInteraction('deepseek-chat')} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">{isLoading && activeModel === 'deepseek-chat' ? <LoadingSpinner /> : <span className="mr-2">⚡️</span>}获取快速CBT反馈</button>
              <button onClick={() => handleCBTInteraction('deepseek-reasoner')} disabled={isLoading} className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">{isLoading && activeModel === 'deepseek-reasoner' ? <LoadingSpinner /> : <span className="mr-2">✨</span>}获取深度CBT反馈</button>
          </div>
          {(modelResponse || error) && (<div className="mt-6 p-5 bg-gray-50 border rounded-lg shadow-inner"><h3 className="text-lg font-semibold text-gray-700 mb-2">模型反馈：</h3>{error ? <p className="text-red-500">{error}</p> : <p className="text-gray-800 whitespace-pre-wrap leading-relaxed">{modelResponse}</p>}</div>)}
          <div className="mt-8 p-4 bg-yellow-100 border text-yellow-800 rounded-lg"><h4 className="text-md font-semibold mb-1">API密钥安全提示：</h4><p className="text-sm">为方便演示，API密钥直接写在前端代码中。在生产环境中，请务必通过后端服务器调用API以保证安全。</p></div>
          </div>
      );
    };

    const InfoCard = ({ title, value, icon }) => ( <div className="bg-white p-4 rounded-lg shadow-md border flex items-center">{icon && <div className="mr-3 text-2xl">{icon}</div>}<div><p className="text-sm text-gray-500">{title}</p><p className="text-xl font-semibold text-gray-800">{value}</p></div></div> );
    
    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
