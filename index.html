<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒç†å’¨è¯¢å¸ˆåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- Helper function for API calls ---
    const callApi = async ({ systemPrompt, userPrompt, model = 'deepseek-chat', onChunk, onError }) => {
        const isStreaming = onChunk && typeof onChunk === 'function';
        // In a real app, this should call your backend, not directly the AI API
        const apiURL = '/api/call-ai';
        try {
            const response = await fetch(apiURL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model, systemPrompt, userPrompt, stream: isStreaming }),
            });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            
            if (isStreaming) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullResponse = "";
                while (true) {
                  const { done, value } = await reader.read();
                  if (done) break;
                  const chunk = decoder.decode(value);
                  const lines = chunk.split("\n");
                  for (const line of lines) {
                    if (line.startsWith("data: ")) {
                      const dataStr = line.substring(6).trim();
                      if (dataStr === "[DONE]") break;
                      try {
                        const data = JSON.parse(dataStr);
                        const deltaContent = data.choices[0]?.delta?.content;
                        if (deltaContent) { fullResponse += deltaContent; onChunk(deltaContent); }
                      } catch (e) { console.error("Error parsing stream data:", e); }
                    }
                  }
                }
                return fullResponse;
            } else {
                 const data = await response.json();
                 return data.choices[0].message.content;
            }
        } catch (err) {
            onError(err.message);
            return `å¯¹åç«¯æœåŠ¡å™¨çš„APIè°ƒç”¨å¤±è´¥: ${err.message}`;
        }
    };
    
    const downloadTextAsFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- Mock Initial Data ---
    const initialClients = [
      { 
        id: 'client-001', name: 'ç‹èŠ³', age: 32, gender: 'å¥³', grade: 'åœ¨èŒ', sexualOrientation: 'å¼‚æ€§æ‹',
        contact: '138********', joinDate: '2023-10-15', referredBy: null, referredClients: ['client-002'],
        historyOfIllness: 'æ— é‡å¤§æ—¢å¾€å²', mentalStateScore: 7, disabilityStatus: 'æ— ', religiousBelief: 'æ— ',
        ethnicIdentity: 'æ±‰æ—', personalFinance: 'ç¨³å®š', familyFinance: 'è‰¯å¥½',
        sessions: [
          { 
            id: 'session-001-1', date: '2023-10-15', summary: 'é¦–æ¬¡è®¿è°ˆï¼Œå»ºç«‹å’¨è¯¢å…³ç³»ã€‚',
            transcript: { name: 'é¦–æ¬¡è®¿è°ˆé€å­—ç¨¿.docx', content: 'æ¨¡æ‹Ÿçš„é€å­—ç¨¿å†…å®¹...' },
            conceptualization: { status: 'Complete', content: 'AIç”Ÿæˆçš„ä¸ªæ¡ˆæ¦‚å¿µåŒ–æŠ¥å‘Šç¤ºä¾‹å†…å®¹...' },
            assessment: { status: 'Complete', content: 'AIç”Ÿæˆçš„æ¥è®¿è€…è¯„ä¼°æŠ¥å‘Šç¤ºä¾‹å†…å®¹...' },
            supervision: { status: 'Pending', conceptualizationUploaded: false, assessmentUploaded: false, content: null }
          },
        ]
      },
      { 
        id: 'client-002', name: 'ææ˜', age: 28, gender: 'ç”·', grade: 'ç¡•å£«åœ¨è¯»', sexualOrientation: 'æœªæä¾›',
        contact: '159********', joinDate: '2024-01-20', referredBy: 'client-001', referredClients: [],
        historyOfIllness: 'æ— ', mentalStateScore: 5, disabilityStatus: 'æ— ', religiousBelief: 'æ— ',
        ethnicIdentity: 'æ±‰æ—', personalFinance: 'ä¾èµ–å®¶åº­', familyFinance: 'ä¸­ç­‰',
        sessions: []
      },
    ];

    // --- PROMPTS ---
    const getConceptualizationPrompt = () => `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å¿ƒç†å’¨è¯¢å¸ˆã€‚æ ¹æ®æ–‡ä»¶ä¸­çš„å’¨è¯¢é€å­—ç¨¿å†…å®¹ä»¥åŠæ¥è®¿çš„åŸºæœ¬ä¿¡æ¯ï¼Œæä¾›ä¸ªæ¡ˆæ¦‚å¿µåŒ–æŠ¥å‘Šã€‚æŠ¥å‘Šç”¨äºè¾…åŠ©å¦ä¸€ä½å’¨è¯¢å¸ˆæ”¹å–„è‡ªå·±çš„å’¨è¯¢æœåŠ¡è´¨é‡ã€‚ä¸ªæ¡ˆæ¦‚å¿µåŒ–æ•´ä½“ä¸Šåº”éµå¾ªâ€˜â€™ä¸­çš„æ­¥éª¤ï¼š
â€˜	1.é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆæ¥è®¿è€…çš„ç†è®ºèŒƒå¼,ä½¿ç”¨ç†è®ºå‡è®¾å»æŒ‡å¯¼ä¸ªæ¡ˆæ¦‚å¿µåŒ–å’Œæ²»ç–—æ–¹æ¡ˆçš„å»ºæ„
	2.åˆ©ç”¨ä¸€äº›å‡è®¾ã€æ”¯æŒæ€§çš„ææ–™æˆ–ç»“è®ºï¼Œä½œä¸ºä¸ªæ¡ˆæ¦‚å¿µåŒ–çš„å…³é”®ä¿¡æ¯
	3.æ¦‚è¿°æ²»ç–—è®¡åˆ’ï¼Œå°†é•¿æœŸã€çŸ­æœŸæ²»ç–—ç›®æ ‡ä½œä¸ºå‘å±•æ²»ç–—è®¡åˆ’çš„å…³é”®è¦ç‚¹ã€‚æ²»ç–—ç›®æ ‡çš„è¡¨è¿°è®©æ¥è®¿å¯ä»¥ç†è§£ï¼Œå°½é‡ç¬¦åˆå…¶æœŸæœ›ä¸ä»·å€¼è§‚ã€‚
4.æç¤ºå’¨è¯¢å¸ˆä½•ç§è¡¨è¾¾æ–¹å¼å¯¹æ¥è®¿å¯èƒ½æ˜¯æœ‰å¸å¼•åŠ›çš„ã€‚æç¤ºæ¥ä¸‹æ¥çš„å’¨è¯¢æ–¹å‘ï¼ˆå’¨è¯¢å¸ˆè¯¥æ€æ ·åšï¼‰ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå“ªäº›è¯é¢˜å¯èƒ½éœ€è¦è¢«æ·±å…¥è®¨è®ºå’Œè°ˆè®ºå“ªäº›è¯é¢˜å¯èƒ½å­˜åœ¨æ½œåœ¨é£é™©ã€‚â€™

å…³äºä¸ªæ¡ˆæ¦‚å¿µåŒ–çš„ç»“æ„è¦ç´ å’Œå†…å®¹ï¼Œå‚è€ƒ{}å†…çš„è¦æ±‚ï¼š
{	1.æ¦‚è¦ï¼šæ ¹æ®ç†è®ºè§†è§’å¯¹æ¥è®¿æ ¸å¿ƒä¼˜åŠ¿å’Œå±€é™çš„ç®€è¦åˆ†æå‡è®¾ã€‚å³å¯¹æ¥è®¿çš„æ ¸å¿ƒå°è±¡ã€æ€»è§ˆï¼Œä»¥å¸®åŠ©é€šè¿‡é˜…è¯»ä¸ªæ¡ˆæ¦‚å¿µåŒ–å¯¹ä¸ªæ¡ˆæœ‰å¤§è‡´äº†è§£ã€‚å†…å®¹åŒ…æ‹¬ï¼šäººå£å­¦ä¸ç¤¾ä¼šæ–‡åŒ–ç­‰åŸºæœ¬ä¿¡æ¯ã€é—®é¢˜æƒ…å†µä¸å’¨è¯¢ç›®æ ‡ç®€ä»‹ã€‚
	2.æ”¯æŒæ€§ç´ æï¼šä¸ºæ¦‚è¦æä¾›ç»†èŠ‚ä¾æ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š1.å¯¹æ¥è®¿ä¼˜åŠ¿çš„æ·±åº¦åˆ†æï¼ˆä¼˜åŠ¿çš„åœ°æ–¹ã€ç§¯æçš„å› ç´ ã€æˆåŠŸã€åº”å¯¹ç­–ç•¥ã€æŠ€èƒ½ã€ä¿ƒè¿›æ”¹å˜çš„å› å­)ï¼›2.å¯¹å¼±ç‚¹çš„æ·±åº¦åˆ†æï¼ˆæ‹…å¿ƒã€å›°éš¾ã€é—®é¢˜ã€ç—‡çŠ¶ã€ç¼ºé™·æŠ€æœ¯ã€æ²»ç–—éšœç¢ï¼‰ï¼›3.æ¥è®¿çš„æˆé•¿å²ã€éƒ¨åˆ†ç”Ÿæ´»å²ï¼Œå‘ˆç°è¿‡å»æˆé•¿å’Œç°åœ¨ç”Ÿæ´»ä¸­çš„å„ç§ç»†èŠ‚ï¼›å›°éš¾å’Œèµ„æºã€å’¨è¯¢å’Œç”Ÿæ´»ä¸­çš„æ¨¡å¼ç­‰ã€‚4.å’¨è¯¢ç›®æ ‡ï¼Œå®ç°ç›®æ ‡çš„å¯èƒ½è·¯å¾„ä¸é˜»ç¢
	3.Â åˆå§‹è¯„ä¼°ä¼šè°ˆåŠæŠ¥å‘Šï¼šèšç„¦æ¥è®¿å½“ä¸‹çš„åŠŸèƒ½ï¼ˆåŠŸèƒ½ç»´åº¦ï¼šåŠ¨åŠ›å­¦ï¼‰
	è¯„ä¼°æ¥è®¿é—®é¢˜çš„ä¸¥é‡ç¨‹åº¦ï¼ŒåŒæ—¶ï¼Œä¹Ÿè¦ä»ä»¥ä¸‹å‡ ä¸ªé¢†åŸŸè¯„ä¼°å’¨è¯¢å¸ˆä¸æ¥è®¿çš„æ½œåœ¨å·®å¼‚ï¼š1.å…ˆåå¤©æ®‹éšœï¼›2.å®—æ•™ä¿¡ä»°ï¼š3.ç§æ—å’Œæ°‘æ—è®¤åŒï¼›4.ä¸ªäººç»æµåœ°ä½ï¼›5.æ€§å–å‘ä¸æ€§åˆ«
è¿™ç§å·®å¼‚è¯„ä¼°æ˜¯ä¸ºäº†é‰´åˆ«æƒåŠ›å·®å¼‚ï¼ˆå’¨è¯¢ä¸“å®¶ä¸æ±‚åŠ©è€…ï¼‰å’Œé˜²æ­¢å‘ç”Ÿå‹è¿«/ä¾µçŠ¯ã€‚
}

å…³äºæ²»ç–—æ–¹æ¡ˆçš„å»ºç«‹ï¼Œéµå¾ª[]ä¸­çš„è¦æ±‚ï¼š
[ä¸€ã€æ²»ç–—æ–¹æ¡ˆçš„ç»“æ„è¦ç´ 
	1.æ²»ç–—æ–¹æ¡ˆç»¼è¿°ï¼šç®€è¦ä»‹ç»æ²»ç–—è®¡åˆ’æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚ä½¿ç”¨æ¥è®¿ç†è§£çš„è¯­è¨€å¢å¼ºå¯¹æ²»ç–—çš„æŒæ§æ„Ÿã€è´£ä»»å¿ƒã€‚å’Œæ¥è®¿å…±åŒç¡®è®¤ã€‚
	2.é•¿æœŸæ²»ç–—ç›®æ ‡ï¼šå®åˆ™ç”±å¤šä¸ªçŸ­æœŸç›®æ ‡æ„æˆã€‚
	3.çŸ­æœŸæ²»ç–—ç›®æ ‡ï¼šå…·ä½“ã€å¯æµ‹é‡ã€‚è¿™ç§ç§¯æå˜åŒ–åº”å¯¹äºæ¥è®¿æ˜¯å¯å®Œæˆçš„ã€æœ‰åŠ¨æœºçš„ï¼Œä»¥å†…åŒ–è¿›æ¥è®¿çš„å†…å¿ƒã€‚
Â 
äºŒã€æ²»ç–—æ–¹æ¡ˆçš„è§†è§’
	æ¯ä¸ªæ²»ç–—ç›®æ ‡å’Œæ”¯æŒææ–™åº”èšç„¦äºæ¥è®¿å„ç§ä¸»è¦ç¤¾ä¼šè§’è‰²ï¼ˆå‘˜å·¥ã€çˆ¶äº²ã€æœ‹å‹â€¦â€¦ï¼‰çš„åŠŸèƒ½æ°´å¹³æˆ–è¡Œä¸ºç—‡çŠ¶ã€‚
1.åŸºäºå‡è®¾æ¨¡å¼
	ä»¥åŠ¨åŠ›å­¦çš„ç†è®ºå‡è®¾ä¸ºæ ¸å¿ƒï¼Œå»ºæ„æ¦‚è¦ã€æ”¯æŒææ–™ã€æ²»ç–—ç›®æ ‡ç­‰ã€‚
2.åŸºäºç—‡çŠ¶æ¨¡å¼
	æ ¹æ®æ¥è®¿æŠ¥å‘Šçš„å®¢è§‚ç—‡çŠ¶æˆ–è¡Œä¸ºï¼Œåˆ†æè¡Œä¸ºçš„åŸå› å’Œå¯èƒ½ç»“æœã€‚é€šè¿‡åœ¨å’¨è¯¢ä¸­é‡æ¼”ä¸åŒæƒ…å¢ƒä¸‹çš„ç›¸å…³è¡Œä¸ºï¼Œæ¢ç´¢ä¸€ä¸ªè¡Œä¸ºçš„triggeræ˜¯ä»€ä¹ˆï¼Œç»ƒä¹ æ­£å¿µè§‰å¯Ÿã€‚å­¦ä¹ ç¨³å®šå’Œè°ƒé€‚æƒ…ç»ªçš„æŠ€æœ¯ã€‚
3.åŸºäºäººé™…å…³ç³»æ¨¡å¼
	æ ¹æ®æ¥è®¿ä¸é‡è¦ä»–äººå’Œå’¨è¯¢ä¸­çš„å…³ç³»æ¨¡å¼ï¼Œæ¢ç´¢å¹¶åˆ†æå…³ç³»å¦‚ä½•å»ºç«‹ã€åŠ å¼ºã€ç ´è£‚ï¼Œè¡Œä¸ºæ˜¯å“ªäº›ã€‚å¯ä»¥å‘ç°å®ç”Ÿæ´»ä¸­çš„ä¸åŒæ¨¡æ¿è¯¢é—®ã€å­¦ä¹ ã€‚
4.åŸºäºå†å²æ¨¡å¼
	ä»è¿‡å»ä¹ å¾—äº†ä»€ä¹ˆï¼Œè¿™äº›ä¹ å¾—çš„æ¨¡å¼å¦‚ä½•å¸¦æ¥å¿ƒç†é—®é¢˜ã€‚æ¥è®¿çš„éœ€è¦å’Œå½“å‰çŠ¶å†µï¼Œæœ€è¿«åˆ‡å…³æ³¨çš„ç„¦ç‚¹ï¼Œæ˜¯å¦‚ä½•ä¸è¿‡å»çš„ä¹ å¾—äº§ç”Ÿè”ç³»çš„ã€‚
Â 
ä¸‰ã€æ²»ç–—æ–¹æ¡ˆçš„æ ¼å¼è§„èŒƒ
1.åŸºæœ¬æ¨¡å¼
	ä¸»è¦èšç„¦äºæ¥è®¿è€…éœ€è¦è¾¾åˆ°çš„ã€å­¦ä¹ çš„æˆ–è€…éœ€è¦å‘å±•çš„å†…å®¹ã€‚
2.é—®é¢˜æ¨¡å¼
	æ ¹æ®éœ€è¦å‡å°‘çš„é€‚åº”ä¸è‰¯çš„è¡Œä¸ºæˆ–é—®é¢˜æ¥ç¡®å®šæ²»ç–—ç›®æ ‡ã€‚
3.çŸ­æœŸç›®æ ‡æ¨¡å¼
	æ¸…æ™°åœ°å‘ˆç°æ¥è®¿è€…å½“å‰çš„é—®é¢˜ã€é—®é¢˜çš„å½“ä¸‹çŠ¶æ€ã€æ²»ç–—è¿™ä¸ªé—®é¢˜ç«‹å³çš„åº”å¯¹è®¡åˆ’ï¼Œä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ²»ç–—æ–¹æ¡ˆçš„è¯´æ˜ã€‚åŒ…æ‹¬ï¼šæ¥è®¿ä¸»è§‚ç´ æã€å’¨è¯¢å¸ˆå®¢è§‚ç´ æã€åŸºäºä¸¤ç§ç´ æå’¨è¯¢å¸ˆå¼€å±•çš„è¯„ä¼°ã€ä¸æ¥è®¿å…±åŒå•†å®šçš„æ²»ç–—è®¡åˆ’ã€‚]
ä½ çš„æ•´ä½“ç›®æ ‡åº”è¯¥æ˜¯å¸®åŠ©å’¨è¯¢å¸ˆæå‡æœåŠ¡è´¨é‡ï¼ŒæŒ‡æ˜åç»­å’¨è¯¢æ–¹å‘ã€‚`;
    const getAssessmentPrompt = () => `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å¿ƒç†å’¨è¯¢å¸ˆã€‚åŸºäºæ–‡ä»¶ä¸­å’¨è¯¢é€å­—ç¨¿çš„å†…å®¹ï¼Œå¹¶éµå¾ªä»¥ä¸‹æˆ‘ç»™å‡ºçš„è¯„ä¼°ç»´åº¦ï¼Œå¯¹è¯¥æ¥è®¿åšå‡ºä¸“ä¸šåŒ–çš„è¯„ä¼°ã€‚
	ä¸€ã€ä¸ªäººä¿¡æ¯ç»´åº¦
	1.ç›®å‰å¿ƒç†çŠ¶æ€
	2.æˆé•¿å²ï¼ˆåˆä¸­åŠä»¥å‰ï¼‰ä¸å½“ä¸‹éƒ¨åˆ†ç”Ÿæ´»å²ï¼Œå‘ˆç°è¿‡å»æˆé•¿å’Œç°åœ¨ç”Ÿæ´»ä¸­çš„å„ç§ç»†èŠ‚ã€å›°éš¾å’Œèµ„æºã€‚å’¨è¯¢å’Œç”Ÿæ´»ä¸­çš„è¡Œä¸ºæ¨¡å¼
	3.æ—©æœŸåŠç°åœ¨äººé™…å…³ç³»å’Œä¾æ‹ç‰¹ç‚¹ï¼ˆåˆä¸­åŠä»¥å‰ï¼‰ï¼Œå’¨è¯¢å’Œç”Ÿæ´»ä¸­çš„å…³ç³»æ¨¡å¼
	4.ä¼˜åŠ¿çš„æ·±åº¦åˆ†æï¼ˆä¼˜åŠ¿ä¹‹å¤„ã€ç§¯æå› ç´ ã€è·å¾—çš„æˆåŠŸã€å¥åº·åº”å¯¹ç­–ç•¥ã€æŠ€èƒ½ã€ä¿ƒè¿›æ”¹å˜çš„å› å­
	5.å¼±ç‚¹çš„æ·±åº¦åˆ†æï¼ˆå›°éš¾ã€é—®é¢˜ã€ç—‡çŠ¶ã€ç¼ºé™·æˆ–åƒµåŒ–åº”å¯¹ã€æ²»ç–—é˜»ç¢ï¼‰
	äºŒã€åŠŸèƒ½ç»´åº¦
	1.è‡ªæˆ‘åŠŸèƒ½
	1.1è‡ªæˆ‘è§‰çŸ¥ï¼šå¦‚ä½•çœ‹å¾…è‡ªå·±ã€‚åŒ…æ‹¬ï¼š
	è‡ªæˆ‘èº«ä»½è®¤åŒï¼šå¯¹è‡ªå·±çš„å®šä¹‰ï¼ˆè®¤ä¸ºè‡ªå·±æ˜¯è°ï¼‰ã€ä»·å€¼è§‚ã€èƒ½åŠ›ä¸å±€é™æ€§ã€‚åœ¨é’å°‘å¹´æ—¶æœŸé€æ¸ç¨³å®š
	è‡ªæˆ‘è¯„ä»·ï¼šåæ˜ ä¸ªäººèƒ½åŠ›åœ¨ä¸»è§‚å’Œå®¢è§‚çš„ç›¸ç¬¦ç¨‹åº¦ï¼Œä¹ŸåŒ…æ‹¬å¯¹è‡ªæˆ‘ç†æƒ³æ„è±¡çš„å¹»æƒ³ï¼ˆå³ç†æƒ³çš„è‡ªæˆ‘æ˜¯ä»€ä¹ˆæ ·çš„ï¼‰ã€‚æ€æƒ³å’Œè¡ŒåŠ¨ç¬¦åˆï¼Œæˆ‘ä»¬çš„å†…åœ¨ç†æƒ³å°±ä¼šæ„Ÿåˆ°è‡ªæˆ‘å®ç°å’Œè‡ªè±ªï¼›å¦åˆ™å°±ä¼šäº§ç”Ÿå†…ç–šã€å¤±è´¥å’Œä¸€æ— æ˜¯å¤„çš„æ„Ÿè§‰ã€‚
	1.2è‡ªå°Šç®¡ç†ï¼šä»æ‰“å‡»ä¸­æ¢å¤åŸçŠ¶çš„èƒ½åŠ›ã€‚
	åŒ…æ‹¬è‡ªå°Šçš„è„†å¼±æ€§ï¼ˆæ°´å¹³é«˜ä½ã€ç¨³å®šæ€§ï¼‰ã€åº”å¯¹æŒ«è´¥è‡ªå°Šçš„æ–¹å¼ï¼ˆè‡ªæ‹è‡ªå¤§æˆ–è‡ªæˆ‘æŒ«è´¥/å—è™ï¼Œè€Œæ›´å¥åº·çš„æ–¹å¼æ˜¯ç›´é¢é—®é¢˜ è€Œä¸æ˜¯å›°åœ¨è‡ªæˆ‘ä¸­ï¼‰ã€åˆ©ç”¨ä»–äººè°ƒèŠ‚è‡ªå°Šã€‚è‡ªå°Šæ˜¯å¯¹è‡ªå·±çš„å°Šæ•¬å’Œæˆ–æ¬£èµï¼Œè‡ªå°Šé—®é¢˜ä½¿æˆ‘ä»¬å˜å¾—æ— æ³•æ‰¿å—æƒ…æ„Ÿå’Œç„¦è™‘ï¼Œæ— æ³•ç°å®è¯„ä»·èƒ½åŠ›å’Œå±€é™ï¼Œæ— æ³•æ§åˆ¶æˆ‘ä»¬çš„å†²åŠ¨ï¼Œæ— æ³•æ”¾æ¾ï¼Œç­‰ç­‰ã€‚
	æ­¤å¤–ï¼Œè‡ªæˆ‘è¯„ä»·çš„é—®é¢˜ä¹Ÿä¼šå¯¼è‡´è‡ªæˆ‘çŸ¥è§‰çš„æ‰­æ›²å’Œè‡ªå°Šç®¡ç†çš„å›°éš¾ã€‚æœ‰çš„äººä¼šé«˜ä¼°è‡ªå·±çš„èƒ½åŠ›(å¤¸å¤§)ï¼Œè€Œæœ‰çš„äººä¼šä½ä¼°è‡ªå·±çš„èƒ½åŠ›ï¼ˆæŠ‘éƒï¼‰ï¼Œåˆæˆ–è€…ç†æƒ³åŒ–ä»–äººã€‚ï¼ˆå«‰å¦’å…·æœ‰æ”»å‡»æ€§ï¼Œè€Œç¾¡æ…•å…·æœ‰é è¿‘çš„å€¾å‘ï¼‰
	2.äººé™…å…³ç³»åŠŸèƒ½ï¼šä¿æŒç¨³å®šã€ä¿¡ä»»ã€äº²å¯†å…³ç³»çš„èƒ½åŠ›
	å…³é”®ï¼š1.å…³ç³»ä¸­å¯¹è‡ªå·±å’Œå¯¹æ–¹çš„ä¿¡ä»»æ„Ÿã€2.æ„ŸçŸ¥åº¦ï¼šæ—¢å¥½åˆåçš„ç«‹ä½“æ€§ã€ç‹¬ç‰¹ä¸ªæ€§çš„ç‹¬ç«‹æ€§ï¼ˆæ˜ç™½ä»–äººçš„æ€æƒ³å’Œæ„Ÿå—ä¸è‡ªå·±ä¸åŒï¼Œå¿ƒæ™ºåŒ–èƒ½åŠ›ï¼‰ã€è¿‡å»åˆ°ç°åœ¨ä¸æœªæ¥å¯èƒ½å˜åŒ–çš„å®Œæ•´æ€§ã€‚3.å®‰å…¨æ„Ÿï¼šæŠµæŠ—é¢å¯¹åˆ†ç¦»ã€åˆ†æ­§ã€æ¶ˆææƒ…ç»ªã€‚4.äº²å¯†æ€§ï¼ˆè¾¹ç•Œæƒ…å†µï¼‰ï¼›5.ç›¸äº’ä¾å­˜åº¦ï¼šåˆé€‚çš„ä¾å­˜æ˜¯æ—¢ç»™äºˆä¹Ÿäº«å—çš„ã€‚
	Â 
	é™¤æ­¤ä»¥å¤–ä»ç„¶å…³é”®çš„è¦ç´ æœ‰ï¼šå…±æƒ…èƒ½åŠ›ã€æ¥è®¿æ„è¯†ä¸æ— æ„è¯†å¯¹ä»–äººçš„æœŸå¾…å’Œå¯¹å…³ç³»çš„å¹»æƒ³ã€‚Â 
	ä¸¤ç§å…³ç³»é—®é¢˜ï¼šæ— æ„è¯†æŠ•å°„ä¸å¹»æƒ³ã€ç¼ºä¹ç¤¾äº¤åŠŸèƒ½ã€‚å‰è€…æ­éœ²ï¼Œåè€…æ”¯æŒ
	åœ¨æˆé•¿çš„è¿‡ç¨‹ä¸­ï¼Œå°æ—¶å€™å’Œé‡è¦ä»–äººçš„äº’åŠ¨ä¸ºä»–ä»¬æ•´ä¸ªäººç”Ÿä¸­ä¸äººäº’åŠ¨çš„æ–¹å¼æ‰“ä¸‹äº†ä¸å¯ç£¨ç­çš„çƒ™å°ã€‚è¢«çˆ±æŠ¤å’Œç…§æ–™å¾—å¾ˆå¥½çš„äººå­¦ä¼šäº†æœŸå¾…ä»ä»–äººé‚£é‡Œä¹Ÿå¾—åˆ°è¿™äº›ï¼Œè€Œè¢«è™å¾…æˆ–å¿½è§†çš„äººå­¦ä¼šäº†é¢„æœŸè¢«è™å¾…ã€‚å³ä½¿äººä»¬æ„è¯†ä¸åˆ°è¿™äº›å†…åŒ–çš„æ— æ„è¯†çš„å…³ç³»æ¨¡å¼å’Œå¹»æƒ³ï¼Œä¹Ÿä¾ç„¶å½±å“ç€ä»–ä»¬çš„æ¯ä¸€æ¬¡è¡ŒåŠ¨ã€‚
	è¿™äº›å¹»æƒ³ä¹‹æ‰€ä»¥æ®‹ç•™åœ¨æ„è¯†ä¹‹å¤–ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å¼•å‘äº†ç¾æ„§ã€ç„¦è™‘æˆ–å…¶ä»–ä»¤äººä¸èˆ’æœçš„å¼ºçƒˆæƒ…æ„Ÿã€‚å¦‚æœä»–ä»¬æ„è¯†ä¸åˆ°è¿™äº›æ— æ„è¯†çš„éœ€æ±‚ï¼Œäººä»¬å°±æ— æ³•é€‰æ‹©èƒ½å’Œä»–ä»¬å»ºç«‹æˆç†Ÿæ»¡æ„çš„äººé™…å…³ç³»çš„ä»–äººã€‚ç”šè‡³æ„è¯†å±‚é¢çš„éœ€æ±‚å’Œæ— æ„è¯†çš„éœ€æ±‚æœ‰æ‰€å†²çªã€‚
	ç¤¾äº¤åŠŸèƒ½åŒ…æ‹¬ï¼šå…±æƒ…èƒ½åŠ›ã€å¯¹è‡ªæˆ‘ç¾è€»çš„ç¨‹åº¦ã€è¯†åˆ«ç¤¾ä¼šæ€§çº¿ç´¢çš„èƒ½åŠ›ã€‚è¿™äº›éƒ½å½±å“ç€èå…¥äººé™…å…³ç³»çš„èƒ½åŠ›ã€‚
	ä»¥èµ„è®¿å…³ç³»ä¸ºæ¨¡æ¿ï¼Œæ£€æŸ¥è¿‡å¾€æ¨¡å¼çš„é‡ç°å¹¶æä¾›ä¿®æ­£æœºä¼šã€‚å¦‚å’¨è¯¢å¸ˆåé¦ˆè‡ªå·±çš„æƒ³æ³•å’Œæ„Ÿå—ï¼Œä¿®æ­£æ¥è®¿çš„é”™è¯¯çŸ¥è§‰ï¼›å¼ºåŒ–é€‚åº”æ€§çš„é˜²å¾¡å¹¶å–ä»£éé€‚åº”æ€§çš„ï¼ˆé€‚åº”æ€§çš„åˆ¤æ–­æ ‡å‡†ï¼‰ï¼›é€šè¿‡æ¥è®¿çŒœæµ‹å’¨è¯¢å¸ˆ-å’¨è¯¢å¸ˆåé¦ˆï¼Œæå‡å¿ƒæ™ºåŒ–åŠŸèƒ½ç­‰ã€‚æœ€ç»ˆä½¿æ¥è®¿è®¤æ¸…è¿‡å¾€æ¨¡å¼ï¼Œå¹¶å¼€å§‹æ†§æ†¬ä»–ä»¬å¯ä»¥æ‹¥æœ‰å¯¹èº«è¾¹çš„äººæ›´ä¸ºç°å®çš„ã€å¤§ä¸ç›¸åŒçš„æœŸå¾…
	3.é€‚åº”åŠŸèƒ½ï¼šé¢å¯¹å‹åŠ›çš„è°ƒæ•´
	å†…åœ¨å‹åŠ›åŒ…æ‹¬æ€æƒ³å’Œå¹»æƒ³ã€æƒ…æ„Ÿå’Œç„¦è™‘ã€ç—›è‹¦å’Œå…¶ä»–èº«ä½“æ„Ÿè§‰;å¤–åœ¨å‹åŠ›åŒ…æ‹¬ä¸ä»–äººçš„äººé™…å…³ç³»ã€ä¸ç»æµçŠ¶å†µå’Œå·¥ä½œç›¸å…³çš„å‹åŠ›ã€åˆ›ä¼¤ä»¥åŠå…¶ä»–ç¯å¢ƒå› ç´ ã€‚äººä»¬åœ¨å¿å—å†…éƒ¨æˆ–å¤–éƒ¨çš„å‹åŠ›åˆºæ¿€æ—¶æœ‰ç€å„è‡ªçš„é˜ˆé™ï¼Œä¹Ÿæœ‰ç€é€‚åº”å†…éƒ¨å’Œå¤–éƒ¨å‹åŠ›åˆºæ¿€çš„ä¸åŒæ–¹å¼ï¼ŒåŒ…æ‹¬ï¼šé˜²å¾¡æœºåˆ¶ã€å†²åŠ¨æ§åˆ¶ã€æƒ…ç»ªç®¡ç†ã€æ„Ÿè§‰è°ƒèŠ‚
	æ„Ÿè§‰åˆºæ¿€ç®¡ç†èƒ½åŠ›ï¼šå¯¹å„ç§æ„Ÿå®˜åˆºæ¿€çš„è€å—å’Œæ³¨æ„åŠ›åˆ†é…èƒ½åŠ›
	æƒ…ç»ªç®¡ç†èƒ½åŠ›ï¼šè€å—ã€ç®¡ç†ã€ç¨³å®šä½“éªŒã€è¡¨è¾¾æƒ…ç»ªçš„èƒ½åŠ›ã€‚æƒ…ç»ªå¿«é€Ÿæ¿€çƒˆå˜åŒ–è¯´æ˜è¯¥èƒ½åŠ›å·®ã€‚
	å†²åŠ¨æ§åˆ¶å·®å¯èƒ½æœ‰ç‰©è´¨æˆç˜¾ã€æ§åˆ¶æ€§å¼ºã€æš´åŠ›ã€è¿æ³•è¡Œä¸ºç­‰é—®é¢˜
	Â 
	æ— æ„è¯†çš„è°ƒèŠ‚å‹åŠ›å³æ˜¯é˜²å¾¡æœºåˆ¶ï¼Œæˆ‘ä»¬åº”å¯¹å‹åŠ›çš„ä¸ªæ€§åŒ–æ–¹å¼åœ¨æ—©å¹´æ—¶å¾€å¾€å…·æœ‰é€‚åº”æ€§æ„ä¹‰ï¼Œè®©æˆ‘ä»¬å…å—è´Ÿé¢æ„Ÿå—çš„å¨èƒã€‚è¯„ä»·é˜²å¾¡æœºåˆ¶çš„ä¸‰ä¸ªç»´åº¦ï¼š
	1.é€‚åº”æ€§ï¼šå¸®åŠ©é€‚åº”å‹åŠ›çš„åŒæ—¶ï¼Œä¿æŠ¤æˆ–å¢å¼ºæœºèƒ½ã€‚é€‚åº”æ€§ä¸æ˜¯ç»å¯¹çš„ï¼Œä¸€ç§æƒ…å½¢ä¸‹çš„å¼ºé€‚åº”æ€§æœºåˆ¶å¯èƒ½æ˜¯å¦ä¸€ç§æƒ…å½¢ä¸‹çš„å¼±é€‚åº”æ€§æœºåˆ¶ã€‚2.çµæ´»æ€§ã€‚3.å¯¹æ€ç»´ä¸æƒ…æ„Ÿçš„è‡ªçŸ¥åŠ›
	ä¸é€‚åº”çš„ä¿¡å·ï¼š1é˜²å¾¡åŠ¨ç”¨äº†è¿‡å¤šçš„å¿ƒç†èƒ½é‡ï¼Œä»¥è‡³äºåªç»™æˆ‘ä»¬ç•™ä¸‹å¾ˆå°‘çš„ç²¾åŠ›å»å‘åŠ¨å…¶ä»–çš„é‡è¦åŠŸèƒ½ã€‚2é˜²å¾¡æŸå®³äº†ä½“éªŒæƒ…æ„Ÿï¼Œæˆ–æ‹¥æœ‰æˆç†Ÿæ»¡æ„çš„äººé™…å…³ç³»çš„èƒ½åŠ›ã€‚3æ³›åŒ–ã€åƒµåŒ–çš„é˜²å¾¡æ–¹å¼ã€‚4ä»¥è‡ªæˆ‘æ¯ç­æˆ–èº«ä½“ç—›è‹¦ä¸ºä»£ä»·
	ä¸é€‚åº”ä¿¡å·çš„è¯†åˆ«ï¼š1å¿ƒç†æˆ–è¡Œä¸ºè¡¨ç°ï¼›2ä¸»è§‚æˆ–å®¢è§‚çš„ç—›è‹¦ï¼›3äººé™…å…³ç³»é—®é¢˜ï¼›4åç§»æƒ…ï¼ˆè¿™ä¹Ÿæç¤ºç€ç”Ÿæ´»ä¸­ä»–äººå¯¹æ¥è®¿çš„æ„Ÿå—ï¼‰
	å¹²é¢„ç¬¬ä¸€æ­¥ï¼šå¸®åŠ©æ¥è®¿è€…è®¤æ¸…ä»–ä»¬çš„é€‚åº”æ–¹å¼æœ‰é—®é¢˜ï¼Œå½“å‰é˜²å¾¡çš„æ•ˆæœæ˜¯æœ‰é™çš„ã€‚å°†åƒµåŒ–çš„é˜²å¾¡ä¸æ–°ä¹ å¾—çš„é€‚åº”æ€§é˜²å¾¡ï¼Œä¸¤ç§æ–¹å¼çš„ç»“æœè¿›è¡Œæ¯”è¾ƒã€ç¡®è®¤ï¼Œèƒ½æ›´å¥½çš„ç•™åœ¨æ¥è®¿å¿ƒä¸­ã€‚
Â 
	4.è®¤çŸ¥åŠŸèƒ½
4.1ç»„ç»‡ä¸è§„åˆ’æ€ç»´ã€å†³ç­–åˆ¶è®¢å’Œé—®é¢˜è§£å†³èƒ½åŠ›ã€åˆ›é€ æ€§æ€ç»´
	Aæœ‰æ¡ç†ï¼Œä»¥ç»†èŠ‚ä¸ºå¯¼å‘ï¼Œä¼šæå‰è§„åˆ’ï¼Œå¹¶ä¸”å¯ä»¥å†·é™åœ°è§£å†³é—®é¢˜ã€‚Bæ›´åŠ éšæ„ï¼Œé¢‘ç¹åœ°æ”¹å˜ä¸»æ„ï¼Œä»¥ä¸€ç§æ›´æƒ…ç»ªåŒ–çš„æ–¹å¼è§£å†³é—®é¢˜ã€‚æœ€ç»ˆï¼Œä¸¤ä¸ªæ–¹æ¡ˆéƒ½å¯ä»¥å¤§è·æˆåŠŸï¼Œä½†æ˜¯å°±è®¡åˆ’ç­¹å¤‡å®ƒä»¬çš„æ€è·¯å’Œè¿‡ç¨‹è€Œè¨€ï¼Œæ˜¯ç›¸å½“ä¸åŒçš„ã€‚æˆ‘ä»¬çš„ä»»åŠ¡ä¸æ˜¯å»è¯„åˆ¤å“ªä¸ªæ–¹å¼æ›´å¥½ï¼Œè€Œæ˜¯æè¿°æˆ‘ä»¬çš„æ¥è®¿è§£å†³é—®é¢˜çš„é£æ ¼ï¼ŒåŒæ—¶å»æ€è€ƒè¿™äº›é£æ ¼æ˜¯å¦‚ä½•ç§¯ææˆ–æ¶ˆæåœ°å½±å“ä»–ä»¬çš„ç”Ÿæ´»çš„ã€‚
	4.2åˆ¤æ–­èƒ½åŠ›ï¼šæ„è¯†åˆ°ä¸€ä¸ªæœ‰æ„è¡Œä¸ºçš„é€‚å½“æ€§å’Œå¯èƒ½å‘ç”Ÿçš„ç»“æœï¼Œä¸”è¡Œä¸ºèƒ½å¤Ÿä½“ç°è¿™ç§æ„è¯†ï¼ˆçŸ¥é“è¸©æ²¹é—¨ä¼šå‡ºè½¦ç¥¸ä½†è¿˜æ˜¯è¸©äº†ï¼Œå†²åŠ¨ä¸å«æœ‰åˆ¤æ–­åŠ›ï¼‰
â€œæ˜è¾¨æ˜¯éâ€çš„é“å¾·åˆ¤æ–­åŠ›æ˜¯è¶…æˆ‘çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å†…ç–šæ„Ÿæ¥è¯„ä¼°,å¦‚æœæ»¡è¶³æ„¿æœ›çš„å†²åŠ¨æ— æ³•æ§åˆ¶æˆ–é“å¾·åˆ¤æ–­ä¸æ­£å¸¸ï¼Œéƒ½å±äºè®¤çŸ¥åŠŸèƒ½å¼‚å¸¸ã€‚åˆ¤æ–­åŠ›ä¸æ˜¯â€œå…¨æˆ–æ— â€çš„æ€§è´¨ï¼Œè€Œæ˜¯å¯ä»¥åœ¨ä¸åŒç¯å¢ƒä¸‹å¢å¤§æˆ–è¡°å‡çš„ã€‚
	4.3åæ€èƒ½åŠ›ï¼šè¯„ä¼°/æ£€éªŒè‡ªèº«æƒ³æ³•å’Œè¡Œä¸ºçš„èƒ½åŠ›ï¼Œä¿®æ­£ä¸ä¸€è‡´çš„æ€åº¦å’Œæ„Ÿå—çš„èƒ½åŠ›ã€‚
	â‘ å¿ƒç†æ„Ÿå—æ€§æ˜¯å’Œè‡ªçœåŠ›æœ‰æ‰€å…³è”çš„ï¼Œå®ƒæŒ‡çš„æ˜¯æ€è€ƒæŸäººäº§ç”Ÿæ€ç»´ã€æ„Ÿè§‰å’Œè¡Œä¸ºæ—¶çš„å¯èƒ½æœ‰çš„æ— æ„è¯†åŠ¨æœºçš„èƒ½åŠ›ã€‚è‡ªçœçš„èƒ½åŠ›å¸®åŠ©äººä»¬è®¤è¯†å’Œæ”¹å–„ä»–ä»¬å¯¹è‡ªå·±å’Œä¸ä»–äººå…³ç³»çš„æ„ŸçŸ¥ã€‚
	â‘¡ç°å®æ£€éªŒèƒ½åŠ›ï¼šåˆ†è¾¨ç°å®/äº‹å®ä¸å¹»æƒ³/ä¸»è§‚è‡†æµ‹çš„èƒ½åŠ›
	Â æ¥è®¿çš„è®¤çŸ¥åŠŸèƒ½å·®ï¼Œæ˜¯æ— æ„è¯†ä½¿å…¶é˜»æ»ï¼Œè¿˜æ˜¯ä»æœªä¹ å¾—ï¼Ÿå¦‚æœä¸€ä¸ªäººæœ‰èƒ½åŠ›æ‰§è¡ŒåŠŸèƒ½ä½†æ˜¯è¢«é˜»æ»äº†ï¼Œå°±è¢«è®¤ä¸ºæ˜¯ç”±å†²çªå¯¼è‡´çš„é—®é¢˜ï¼›è€Œå¦‚æœä¸€ä¸ªäººç¼ºä¹æ‰§è¡ŒåŠŸèƒ½çš„èƒ½åŠ›ï¼Œç”šè‡³ä»æ—©å¹´é—´å°±æœ‰è¿‡ç§ç§è¿¹è±¡ï¼Œå°±è¢«è®¤ä¸ºæ˜¯ç”±ç¼ºé™·å¯¼è‡´çš„
	å¦å¤–ï¼Œé—®é¢˜æ˜¯é•¿æœŸ/è¿‘æœŸçš„ã€æ˜¯æ€»ä½“æ€§çš„è¿˜æ˜¯é€‰æ‹©æ€§çš„ï¼Œéƒ½æœ‰åŠ©äºåŒºåˆ†å†²çª/ç¼ºé™·ã€‚ 
Â 
5.å·¥ä½œå’Œå¨±ä¹åŠŸèƒ½
	å·¥ä½œæ˜¯ä»˜å‡ºèº«ä½“æˆ–æ˜¯ç²¾ç¥åŠªåŠ›å»åšæŸäº‹ï¼Œæœ‰ç›®çš„æ€§çš„æ´»åŠ¨ã€‚ä¸€ä¸ªäººâ€œé€‰æ‹©â€åšäº†ä»€ä¹ˆï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬èŒä¸šï¼‰å¯ä»¥åæ˜ å‡ºä»–çš„ä¸ªäººå’Œäººé™…ç”Ÿæ´»ï¼Œä¹ŸåŒ¹é…äºä»–çš„å¿ƒæ™ºã€èƒ½åŠ›ã€å±€é™æ€§ã€‚
	å¨±ä¹æŒ‡æ”¾æ¾ã€æ²‰æµ¸äºå¹»æƒ³ã€æ— ç„¦è™‘çš„ä½“éªŒæ— æ„è¯†æƒ…æ„Ÿå’Œé©±åŠ›çš„èƒ½åŠ›ã€‚ä¼šå¨±ä¹çš„äººå¯èƒ½æ‹¥æœ‰æ›´å¥åº·çš„æƒ…ç»ªç”Ÿæ´»å¹¶ä¸”æˆé•¿å¾—æ›´é¡ºåˆ©ï¼Œç¼ºä¹ä¼‘é—²æ´»åŠ¨æš—ç¤ºä»–ä»¬åœ¨æ”¾æ¾å’Œäº«å—æ–¹é¢æœ‰å·¨å¤§é—®é¢˜ã€‚
	è¯„ä¼°å·¥ä½œå’Œå¨±ä¹é¢†åŸŸï¼š1.å¾ˆå¥½åœ°ä¸ä»–ä»¬çš„å‘å±•æ°´å¹³æˆ–å¹´é¾„ã€å¤©èµ‹ã€å±€é™æ€§åŒ¹é…ï¼›2.æ„Ÿåˆ°èˆ’æœæˆ–æ„‰æ‚¦ï¼›3.ç‰©è´¨åŸºç¡€è¶³ä»¥ç…§é¡¾è‡ªå·±å’Œå®¶äººã€‚
`;
    const getSupervisionPrompt = () => `
ä½ æ˜¯èµ„æ·±å¿ƒç†å’¨è¯¢ç£å¯¼å¸ˆï¼Œé‡‡ç”¨ç²¾ç¥åŠ¨åŠ›å­¦å–å‘æ•´åˆè§†è§’ã€‚
ä½ çš„æ ¸å¿ƒå…³æ³¨ç‚¹åŒ…æ‹¬ï¼šæ¥è®¿è€…ç¦ç¥‰ä¸ä¼¦ç†åˆè§„æ€§ã€å’¨è¯¢è¿‡ç¨‹å¾®è§‚åˆ†æã€å’¨è¯¢å¸ˆè‡ªæˆ‘è§‰å¯Ÿä¸ä¸“ä¸šå‘å±•ã€ä»¥åŠå…³ç³»åŠ¨åŠ›ç³»ç»Ÿè§£æ„ã€‚
è¯·æ ¹æ®æä¾›çš„æ¥è®¿è€…ä¿¡æ¯å’Œæ‰€æœ‰æ–‡ä»¶å†…å®¹ï¼Œä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œåˆ†æï¼Œå¹¶ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„ä¸´åºŠç£å¯¼æŠ¥å‘Šã€‚

# åˆ†æç»´åº¦ï¼š
1.  **æ¥è®¿è€…åˆ†æ:**
    * **æ˜¾æ€§å†…å®¹:** åˆ†æè¡¨å±‚é™ˆè¿°çš„äº‹å®ã€è¯‰æ±‚ï¼Œä»¥åŠå¯è§‚å¯Ÿçš„æƒ…ç»ªååº”å¼ºåº¦ä¸å˜åŒ–ã€‚
    * **éšæ€§å¿ƒç†è¿‡ç¨‹:** æ¢ç´¢è‡ªä½“è¡¨å¾ï¼ˆè‡ªæˆ‘ä»·å€¼æ„Ÿ/å®Œæ•´æ€§ï¼‰ã€å®¢ä½“å…³ç³»æ¨¡å¼ï¼ˆäº’åŠ¨æœŸå¾…/å†…åœ¨å·¥ä½œæ¨¡å‹ï¼‰ã€é˜²å¾¡æœºåˆ¶å±‚çº§ï¼ˆä»åŸå§‹åˆ°æˆç†Ÿï¼‰ã€ç§»æƒ…çº¿ç´¢ï¼ˆå¯¹å’¨è¯¢å¸ˆçš„è§’è‰²æŠ•å°„ï¼‰ï¼Œä»¥åŠæœªæ»¡è¶³çš„æ ¸å¿ƒéœ€æ±‚ã€‚
    * **å‘å±•æ€§è¯„ä¼°:** è¯„ä¼°å’¨è¯¢å‰åè¡¨å¾æ¨¡å¼çš„å˜åŒ–ã€å¿ƒç†åŒ–èƒ½åŠ›æ°´å¹³å’Œåæ€åŠŸèƒ½çš„è¿›å±•ã€‚
2.  **å’¨è¯¢å¸ˆåˆ†æ:**
    * **å¹²é¢„æŠ€æœ¯åˆ†æ:** å‘½åå…·ä½“æŠ€æœ¯ï¼ˆå¦‚ã€æ”¯æŒæ€§é¢è´¨ã€ã€éšå–»æ€§è¯ é‡Šã€ï¼‰ï¼Œè¯„ä¼°æŠ€æœ¯å®æ–½æ—¶åºï¼ˆæ˜¯å¦åŒ¹é…è¿›ç¨‹èŠ‚å¾‹ï¼‰ï¼Œä»¥åŠæŠ€æœ¯é€‰æ‹©ä¸ä¸ªæ¡ˆæ¦‚å¿µåŒ–çš„é€»è¾‘è”ç»“ã€‚
    * **å›åº”æ•ˆèƒ½è¯„ä¼°:** è¯„ä¼°ä¸æ¥è®¿è€…æ½œæ„è¯†çš„åŒ¹é…åº¦ï¼ˆ1-5çº§è¯„åˆ†ï¼‰ï¼Œå¯¹å’¨è¯¢è”ç›Ÿçš„å½±å“ï¼ˆå¼ºåŒ–/å‰Šå¼±/ä¸­æ€§ï¼‰ï¼Œä»¥åŠæ˜¯å¦æ‹“å±•å¿ƒç†ç©ºé—´ï¼ˆæ˜¯/å¦/éƒ¨åˆ†ï¼‰ã€‚
    * **åç§»æƒ…ç®¡ç†:** è¯†åˆ«å’¨è¯¢å¸ˆçš„èº«ä½“ã€æƒ…ç»ªã€è®¤çŸ¥ç­‰åç§»æƒ…çº¿ç´¢åŠå¤„ç†æ–¹å¼ã€‚
3.  **å…³ç³»åŠ¨åŠ›åˆ†æ:**
    * **ç§»æƒ…-åç§»æƒ…çŸ©é˜µ:** åˆ†ææŠ•å°„æ€§è®¤åŒæ¿€æ´»é¢†åŸŸã€äº’è¡¥æ€§/ä¸€è‡´æ€§åç§»æƒ…æ¨¡å¼ï¼Œä»¥åŠä¿®å¤æ€§ä½“éªŒå‘ç”ŸèŠ‚ç‚¹ã€‚
    * **æ­¤æ—¶æ­¤åœ°äº’åŠ¨:** åˆ†æ3è½®å¯¹è¯å†…çš„æƒ…æ„Ÿä¼ é€’ç²¾åº¦åŠéè¨€è¯­åŒæ­¥æ€§ï¼ˆè¯­éŸ³åœé¡¿/è¯­é€ŸåŒ¹é…ï¼‰ã€‚
    * **å¹³è¡Œè¿‡ç¨‹ç›‘æµ‹:** å¯»æ‰¾å’¨è¯¢å…³ç³»æ¨¡å¼åœ¨ç£å¯¼ä¸­çš„é‡ç°è¯æ®åŠæœºæ„ç³»ç»Ÿå‹åŠ›çš„ä¼ å¯¼è·¯å¾„ã€‚
4.  **ä¸“ä¸šå‘å±•æŒ‡å¯¼:**
    * **èƒ½åŠ›æˆé•¿ç‚¹:** æŒ‡å‡ºéœ€å¼ºåŒ–çš„ç†è®ºæ¨¡å—å’ŒæŠ€æœ¯ä¼˜åŒ–å»ºè®®ã€‚
    * **ç›²ç‚¹è­¦ç¤º:** æç¤ºæ–‡åŒ–åè§é£é™©å’Œä¼¦ç†æ•æ„ŸåŸŸã€‚

# è¾“å‡ºè§„æ ¼ï¼š
* **æ ¼å¼:** ç»“æ„åŒ–ä¸´åºŠç£å¯¼æŠ¥å‘Šã€‚
* **å¿…é¡»åŒ…å«çš„ç« èŠ‚:** å…³é”®äº¤äº’ç‰‡æ®µæ ‡è®°ï¼ˆæ—¶é—´æˆ³+å¯¹è¯æ‘˜è¦ï¼‰ã€åŠ¨åŠ›è¿‡ç¨‹æ¦‚å¿µåŒ–å›¾è°±ã€ä¼¦ç†é£é™©è¯„çº§ï¼ˆä½/ä¸­/é«˜ï¼‰ã€å…·ä½“å¯æ“ä½œæ”¹è¿›ç­–ç•¥ï¼ˆæŒ‰å®æ–½ä¼˜å…ˆçº§æ’åºï¼‰ï¼Œä»¥åŠç£å¯¼ååæ€é—®é¢˜ï¼ˆ3ä¸ªå¼€æ”¾å¼æé—®ï¼‰ã€‚
* **ç¦æ­¢:** ç»å¯¹åŒ–è¯Šæ–­è¡¨è¿°ï¼ˆå¦‚ã€æ¥è®¿è€…æ‚£æœ‰XXéšœç¢ã€ï¼‰ï¼Œè„±ç¦»æ–‡æœ¬çš„æ¨æµ‹æ€§è§£è¯»ã€‚

# ç‰¹æ®Šè¦æ±‚ï¼š
* æ ‡æ³¨æ¯é¡¹ç»“è®ºçš„æ–‡æœ¬è¯æ®æ¥æºï¼ˆå¦‚ã€L34æ¥è®¿è€…æ¡æ‹³é™ˆè¿°ã€ï¼‰ã€‚
* åŒºåˆ†è§‚å¯Ÿäº‹å®ä¸ç£å¯¼å‡è®¾ï¼ˆä½¿ç”¨ã€å¯èƒ½è¡¨æ˜ã€ã€æç¤ºã€ç­‰é™å®šè¯ï¼‰ã€‚
* æ•´åˆè‡³å°‘2ä¸ªç†è®ºè§†è§’ï¼ˆä¸»ä½“é—´æ€§/ä¾æ‹ç†è®º/å…³ç³»ç²¾ç¥åˆ†æç­‰ï¼‰ã€‚
`;

    // --- Main Application Component ---
    const App = () => {
      const { useState, useEffect } = React;
      const [activeSection, setActiveSection] = useState('clientManagement');
      const [clients, setClients] = useState(() => {
        try { return JSON.parse(localStorage.getItem('psychClients')) || initialClients; } 
        catch (e) { return initialClients; }
      });
      const [selectedClient, setSelectedClient] = useState(null);
      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');

      useEffect(() => { localStorage.setItem('psychClients', JSON.stringify(clients)); }, [clients]);

      const handleUpdateClient = (updatedClientData, callback) => {
        let newClientsState = [...clients];
        const oldClientState = newClientsState.find(c => c.id === updatedClientData.id);
        
        if (oldClientState) { // Handle updates for existing client
            const oldReferredBy = oldClientState.referredBy;
            const newReferredBy = updatedClientData.referredBy;

            if (oldReferredBy !== newReferredBy) {
              if (oldReferredBy) {
                const oldReferrerIndex = newClientsState.findIndex(c => c.id === oldReferredBy);
                if (oldReferrerIndex > -1) {
                  newClientsState[oldReferrerIndex] = {
                    ...newClientsState[oldReferrerIndex],
                    referredClients: newClientsState[oldReferrerIndex].referredClients.filter(id => id !== updatedClientData.id)
                  };
                }
              }
              if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1) {
                  const newReferrer = { ...newClientsState[newReferrerIndex] };
                  if (!newReferrer.referredClients.includes(updatedClientData.id)) {
                    newReferrer.referredClients.push(updatedClientData.id);
                  }
                  newClientsState[newReferrerIndex] = newReferrer;
                }
              }
            }
        }
        
        const clientIndex = newClientsState.findIndex(c => c.id === updatedClientData.id);
        if (clientIndex > -1) { 
            newClientsState[clientIndex] = updatedClientData; 
        } else { // Handle new client
            newClientsState.push(updatedClientData);
            const newReferredBy = updatedClientData.referredBy;
            if (newReferredBy) {
                const newReferrerIndex = newClientsState.findIndex(c => c.id === newReferredBy);
                if (newReferrerIndex > -1) {
                    if (!newClientsState[newReferrerIndex].referredClients.includes(updatedClientData.id)) {
                        newClientsState[newReferrerIndex].referredClients.push(updatedClientData.id);
                    }
                }
            }
        }
        
        setClients(newClientsState);
        if (selectedClient?.id === updatedClientData.id || !oldClientState) {
          setSelectedClient(updatedClientData);
        }
        if (callback) callback(updatedClientData);
      };

      const handleAddClient = (newClient, clientToEdit) => {
        if(clientToEdit) {
          handleUpdateClient(newClient);
        } else {
          const clientWithDefaults = { ...newClient, id: `client-${Date.now()}`, sessions: [], joinDate: new Date().toISOString().split('T')[0], referredBy: newClient.referredBy || null, referredClients: [] };
          handleUpdateClient(clientWithDefaults);
          setSelectedClient(clientWithDefaults); 
          setActiveSection('clientDetail');
        }
      };
      
      const handleDeleteClient = (clientId) => {
        const clientToDelete = clients.find(c => c.id === clientId);
        if (!clientToDelete) return;
        let updatedClients = clients.filter(client => client.id !== clientId);
        updatedClients = updatedClients.map(client => {
          if (client.referredBy === clientId) { return { ...client, referredBy: null }; }
          if (client.referredClients.includes(clientId)) { return { ...client, referredClients: client.referredClients.filter(id => id !== clientId) }; }
          return client;
        });
        console.warn(`å°è¯•åˆ é™¤æ¥è®¿è€… ${clientToDelete?.name}ã€‚`);
        setClients(updatedClients);
        if (selectedClient?.id === clientId) { setSelectedClient(null); setActiveSection('clientManagement'); }
      };

      const handleSelectClient = (client) => { setSelectedClient(client); setActiveSection('clientDetail'); };
      
      const renderSection = () => {
        switch (activeSection) {
          case 'clientManagement':
            return <ClientManagementSection clients={clients} onAddClient={handleAddClient} onSelectClient={handleSelectClient} />;
          case 'clientDetail':
            return selectedClient ? 
                   <ClientDetailView 
                      key={selectedClient.id} 
                      client={selectedClient} 
                      allClients={clients} 
                      onUpdateClient={handleUpdateClient} 
                      onDeleteClient={handleDeleteClient}
                      setGlobalLoadingMessage={setGlobalLoadingMessage}
                      isAiLoading={!!globalLoadingMessage}
                    /> : 
                   <div className="text-center p-10 text-gray-500">è¯·å…ˆä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä½æ¥è®¿è€…ã€‚</div>;
          case 'cbtApplication':
            return <CBTSection />;
          default:
            return <ClientManagementSection clients={clients} onAddClient={handleAddClient} onSelectClient={handleSelectClient} />;
        }
      };

      return (
        <div className="min-h-screen bg-gray-100 flex flex-col">
          <div className="bg-gray-800 text-white shadow-lg"><div className="container mx-auto px-4"><div className="flex items-center justify-between h-16"><div className="flex items-center"><span className="text-2xl mr-3">ğŸ’Œ</span><h1 className="text-xl font-bold">å¿ƒç†å’¨è¯¢å¸ˆåŠ©æ‰‹</h1></div><div><button onClick={()=>setActiveSection('clientManagement')} className={`px-3 py-2 rounded-md text-sm font-medium flex items-center ${activeSection!=='cbtApplication'?'bg-gray-900':'text-gray-300 hover:bg-gray-700'}`}><span className="mr-2">ğŸ‘¥</span>æ¥è®¿è€…ç®¡ç†</button><button onClick={()=>setActiveSection('cbtApplication')} className={`px-3 py-2 ml-4 rounded-md text-sm font-medium flex items-center ${activeSection==='cbtApplication'?'bg-gray-900':'text-gray-300 hover:bg-gray-700'}`}><span className="mr-2">ğŸ§ </span>CBTè¾…åŠ©å·¥å…·</button></div></div></div></div>
          {globalLoadingMessage && (<div className="bg-yellow-400 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center"><span className="mr-2">â³</span>{globalLoadingMessage}</div>)}
          <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
        </div>
      );
    };

    const ClientManagementSection = ({ clients, onAddClient, onSelectClient }) => {
        const { useState } = React;
        const [showAddClientModal, setShowAddClientModal] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const filteredClients = clients.filter(client => client.name.toLowerCase().includes(searchTerm.toLowerCase()));
        return (
            <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
            <div className="flex justify-between items-center mb-6 pb-4 border-b"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-2xl">ğŸ‘¥</span>æ¥è®¿è€…ç®¡ç†</h2><button onClick={() => setShowAddClientModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center"><span className="mr-2">â•</span>æ·»åŠ æ–°æ¥è®¿</button></div>
            <input type="text" placeholder="æœç´¢æ¥è®¿è€…å§“å..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 mb-4 border rounded-lg"/>
            {filteredClients.length > 0 ? (
                <ul className="space-y-3">{filteredClients.map(client => (<li key={client.id} onClick={() => onSelectClient(client)} className="bg-gray-50 hover:bg-blue-50 border rounded-lg p-4 cursor-pointer flex justify-between items-center"><div><p className="text-lg font-medium text-blue-700">{client.name} <span className="text-sm text-gray-500">({client.gender}, {client.age}å²)</span></p><p className="text-sm text-gray-600">åŠ å…¥æ—¥æœŸ: {client.joinDate}</p></div><span className="text-gray-400">â¯</span></li>))}</ul>
            ) : <p className="text-center text-gray-500 py-8">æš‚æ— åŒ¹é…çš„æ¥è®¿è€…ã€‚</p>}
            {showAddClientModal && <AddClientModal onClose={() => setShowAddClientModal(false)} onAddClient={onAddClient} allClients={clients} />}
            </div>
        );
    };

    const AddClientModal = ({ onClose, onAddClient, clientToEdit, allClients }) => {
      const { useState } = React;
      const [formData, setFormData] = useState({
        name: clientToEdit?.name || '', age: clientToEdit?.age || '', gender: clientToEdit?.gender || 'æœªé€éœ²',
        grade: clientToEdit?.grade || '', sexualOrientation: clientToEdit?.sexualOrientation || '',
        contact: clientToEdit?.contact || '', referredBy: clientToEdit?.referredBy || '',
        historyOfIllness: clientToEdit?.historyOfIllness || '', mentalStateScore: clientToEdit?.mentalStateScore || '5',
        disabilityStatus: clientToEdit?.disabilityStatus || '', religiousBelief: clientToEdit?.religiousBelief || '',
        ethnicIdentity: clientToEdit?.ethnicIdentity || '', personalFinance: clientToEdit?.personalFinance || '',
        familyFinance: clientToEdit?.familyFinance || '',
      });
      const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
      const handleSubmit = (e) => {
        e.preventDefault(); if (!formData.name.trim() || !formData.age) { console.warn('å§“åå’Œå¹´é¾„ä¸ºå¿…å¡«é¡¹ã€‚'); return; }
        const clientData = { ...formData, age: parseInt(formData.age), referredBy: formData.referredBy || null };
        const dataToSubmit = clientToEdit ? { ...clientToEdit, ...clientData } : clientData;
        onAddClient(dataToSubmit, clientToEdit); onClose();
      };
      const potentialReferrers = allClients.filter(c => c.id !== clientToEdit?.id);
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
          <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 z-10"><h3 className="text-xl font-semibold">{clientToEdit ? 'ç¼–è¾‘' : 'æ·»åŠ '}æ¥è®¿è€…ä¿¡æ¯</h3><button onClick={onClose} className="text-gray-500">âŒ</button></div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium">å§“å <span className="text-red-500">*</span></label><input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å¹´é¾„ <span className="text-red-500">*</span></label><input type="number" name="age" value={formData.age} onChange={handleChange} required className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">æ€§åˆ«</label><select name="gender" value={formData.gender} onChange={handleChange} className="w-full p-2 border rounded-md"><option>æœªé€éœ²</option><option>ç”·</option><option>å¥³</option><option>å…¶ä»–</option></select></div>
                <div><label className="block text-sm font-medium">åœ¨è¯»å¹´çº§</label><input type="text" name="grade" value={formData.grade} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">æ€§å–å‘</label><input type="text" name="sexualOrientation" value={formData.sexualOrientation} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">è”ç³»æ–¹å¼</label><input type="text" name="contact" value={formData.contact} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">è¢«...ä»‹ç»</label><select name="referredBy" value={formData.referredBy || ''} onChange={handleChange} className="w-full p-2 border rounded-md"><option value="">æ— </option>{potentialReferrers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div><label className="block text-sm font-medium">å¿ƒç†çŠ¶æ€è¯„åˆ†(1-10)</label><select name="mentalStateScore" value={formData.mentalStateScore} onChange={handleChange} className="w-full p-2 border rounded-md">{[...Array(10).keys()].map(i => <option key={i+1} value={i+1}>{i+1}</option>)}</select></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">æ—¢å¾€ç—…å²</label><input type="text" name="historyOfIllness" value={formData.historyOfIllness} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">æ®‹éšœæƒ…å†µ</label><input type="text" name="disabilityStatus" value={formData.disabilityStatus} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å®—æ•™ä¿¡ä»°</label><input type="text" name="religiousBelief" value={formData.religiousBelief} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">ç§æ—è®¤åŒ</label><input type="text" name="ethnicIdentity" value={formData.ethnicIdentity} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">ä¸ªäººç»æµ</label><input type="text" name="personalFinance" value={formData.personalFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                <div><label className="block text-sm font-medium">å®¶åº­ç»æµ</label><input type="text" name="familyFinance" value={formData.familyFinance} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
              </div>
              <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-100 rounded-md border">å–æ¶ˆ</button><button type="submit" className="px-4 py-2 text-white bg-blue-600 rounded-md flex items-center"><span className="mr-2">ğŸ’¾</span>{clientToEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button></div>
            </form>
          </div>
        </div>
      );
    };

    const ClientDetailView = ({ client, allClients, onUpdateClient, onDeleteClient, setGlobalLoadingMessage, isAiLoading }) => {
      const { useState, useEffect } = React;
      const [activeTab, setActiveTab] = useState('profile');
      const [showEditModal, setShowEditModal] = useState(false);
      const tabs = [{ id: 'profile', label: 'æ¡£æ¡ˆä¸ä¼šè¯', icon: 'ğŸ‘¤' }, { id: 'conceptualization', label: 'AIä¸ªæ¡ˆæ¦‚å¿µåŒ–', icon: 'ğŸ“œ' },{ id: 'supervision', label: 'AIç£å¯¼', icon: 'ğŸ”¬' },{ id: 'analysis', label: 'æ¥è®¿è€…è¯„ä¼°', icon: 'ğŸ“Š' }];
      
      const triggerAiGenerationIfNeeded = async (currentClient, sessionId) => {
        const session = currentClient.sessions.find(s => s.id === sessionId);
        if (session && session.transcript && session.conceptualization.status === 'Pending') {
            setGlobalLoadingMessage(`æ­£åœ¨ä¸º ${currentClient.name} (ä¼šè¯: ${session.date}) ç”ŸæˆAIå†…å®¹...`);
            const sessionIndex = currentClient.sessions.findIndex(s => s.id === sessionId);
            
            let processingClient = JSON.parse(JSON.stringify(currentClient));
            processingClient.sessions[sessionIndex].conceptualization.status = 'Processing';
            processingClient.sessions[sessionIndex].assessment.status = 'Processing';
            onUpdateClient(processingClient);

            const userPromptContent = `æ¥è®¿è€…åŸºæœ¬ä¿¡æ¯:\nå§“å: ${client.name}\nå¹´é¾„: ${client.age}\næ€§åˆ«: ${client.gender}\nåœ¨è¯»å¹´çº§: ${client.grade}\næ€§å–å‘: ${client.sexualOrientation}\næ—¢å¾€ç—…å²: ${client.historyOfIllness}\nå¿ƒç†çŠ¶æ€è¯„åˆ†: ${client.mentalStateScore}/10\næ®‹éšœæƒ…å†µ: ${client.disabilityStatus}\nå®—æ•™ä¿¡ä»°: ${client.religiousBelief}\nç§æ—è®¤åŒ: ${client.ethnicIdentity}\nä¸ªäººç»æµ: ${client.personalFinance}\nå®¶åº­ç»æµ: ${client.familyFinance}\n\næ–‡ä»¶å†…å®¹æ‘˜è¦:\nå’¨è¯¢é€å­—ç¨¿: ${session.transcript.content}`;
            
            const conceptualizationPromise = callApi({ systemPrompt: getConceptualizationPrompt(), userPrompt: userPromptContent, model: 'deepseek-chat' });
            const assessmentPromise = callApi({ systemPrompt: getAssessmentPrompt(), userPrompt: userPromptContent, model: 'deepseek-chat' });
            const [conceptualizationResult, assessmentResult] = await Promise.all([conceptualizationPromise, assessmentPromise]);

            let finalClient = JSON.parse(JSON.stringify(processingClient));
            finalClient.sessions[sessionIndex].conceptualization = { status: conceptualizationResult.includes('APIè°ƒç”¨å¤±è´¥') ? 'Error' : 'Complete', content: conceptualizationResult };
            finalClient.sessions[sessionIndex].assessment = { status: assessmentResult.includes('APIè°ƒç”¨å¤±è´¥') ? 'Error' : 'Complete', content: assessmentResult };

            onUpdateClient(finalClient);
            setGlobalLoadingMessage('');
        }
      };
      
      const handleAddSession = (newSessionData) => {
        const newSession = { id: `session-${client.id}-${Date.now()}`, ...newSessionData, transcript: null, conceptualization: { status: 'Pending' }, assessment: { status: 'Pending' }, supervision: { status: 'Pending', conceptualizationUploaded: false, assessmentUploaded: false } };
        onUpdateClient({ ...client, sessions: [...(client.sessions || []), newSession] });
      };

      const handleFileUpload = (sessionId, fileType, file) => {
        const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
        if (sessionIndex === -1) return;
        const updatedClient = { ...client };
        updatedClient.sessions[sessionIndex][fileType] = file;
        onUpdateClient(updatedClient, (finalUpdatedClient) => {
            triggerAiGenerationIfNeeded(finalUpdatedClient, sessionId);
        });
      };
      
      const handleSupervisionFileUploaded = (sessionId, fileType) => {
          const sessionIndex = client.sessions.findIndex(s => s.id === sessionId);
          if (sessionIndex === -1) return;
          let updatedClient = JSON.parse(JSON.stringify(client));
          updatedClient.sessions[sessionIndex].supervision[fileType + 'Uploaded'] = true;
          
          onUpdateClient(updatedClient, (finalUpdatedClient) => {
              const finalSession = finalUpdatedClient.sessions.find(s => s.id === sessionId);
              if(finalSession.supervision.conceptualizationUploaded && finalSession.supervision.assessmentUploaded && finalSession.supervision.status !== 'Complete' && finalSession.supervision.status !== 'Processing') {
                  triggerSupervisionGeneration(finalUpdatedClient, sessionId);
              }
          });
      };
      
      const triggerSupervisionGeneration = async (clientForSupervision, sessionId) => {
          setGlobalLoadingMessage(`æ­£åœ¨ä¸º ${clientForSupervision.name} (ä¼šè¯: ${clientForSupervision.sessions.find(s=>s.id === sessionId).date}) ç”ŸæˆAIç£å¯¼æŠ¥å‘Š...`);
          const sessionIndex = clientForSupervision.sessions.findIndex(s => s.id === sessionId);
          
          let processingClient = JSON.parse(JSON.stringify(clientForSupervision));
          processingClient.sessions[sessionIndex].supervision.status = 'Processing';
          onUpdateClient(processingClient);

          const currentSession = processingClient.sessions[sessionIndex];
          const userPromptForSupervision = `æ¥è®¿è€…åŸºæœ¬ä¿¡æ¯: (åŒä¸Š)\n\nå’¨è¯¢é€å­—ç¨¿å†…å®¹: ${currentSession.transcript.content}\n\nAIç”Ÿæˆçš„ä¸ªæ¡ˆæ¦‚å¿µåŒ–:\n${currentSession.conceptualization.content}\n\nAIç”Ÿæˆçš„æ¥è®¿è€…è¯„ä¼°:\n${currentSession.assessment.content}`;
          
          const supervisionResult = await callApi({ systemPrompt: getSupervisionPrompt(), userPrompt: userPromptForSupervision, model: 'deepseek-chat' });
          
          let finalClient = JSON.parse(JSON.stringify(processingClient));
          finalClient.sessions[sessionIndex].supervision = { 
              ...finalClient.sessions[sessionIndex].supervision,
              status: supervisionResult.includes('APIè°ƒç”¨å¤±è´¥') ? 'Error' : 'Complete', 
              content: supervisionResult 
          };
          onUpdateClient(finalClient);
          setGlobalLoadingMessage('');
      };

      const renderTabContent = () => {
        switch (activeTab) {
          case 'profile': return <ClientProfileTab client={client} allClients={allClients} onAddSession={handleAddSession} onFileUpload={handleFileUpload} onSupervisionFileUpload={handleSupervisionFileUploaded} isAiLoading={isAiLoading} />;
          case 'conceptualization': return <ConceptualizationTab client={client} />;
          case 'supervision': return <SupervisionReportTab client={client} onSupervisionFileUploaded={handleSupervisionFileUploaded} />;
          case 'analysis': return <AnalysisReportTab client={client} />;
          default: return null;
        }
      };

      return (
        <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn">
          <div className="flex flex-col md:flex-row justify-between md:items-center mb-4 pb-4 border-b gap-4"><h2 className="text-2xl font-semibold text-gray-700 flex items-center"><span className="mr-3 text-3xl">ğŸ‘¤</span>{client.name} - æ¡£æ¡ˆä¸­å¿ƒ</h2><div><button onClick={() => setShowEditModal(true)} className="text-sm text-blue-600 mr-4 flex items-center"><span className="mr-1">âœï¸</span>ç¼–è¾‘</button><button onClick={() => onDeleteClient(client.id)} className="text-sm text-red-500 flex items-center"><span className="mr-1">ğŸ—‘ï¸</span>åˆ é™¤</button></div></div>
          <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-6 overflow-x-auto">{tabs.map(tab => <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-shrink-0 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center ${activeTab === tab.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}><span className="mr-2">{tab.icon}</span>{tab.label}</button>)}</nav></div>
          <div className="pt-6">{renderTabContent()}</div>
          {showEditModal && <AddClientModal onClose={() => setShowEditModal(false)} onAddClient={onUpdateClient} clientToEdit={client} allClients={allClients}/>}
        </div>
      );
    };
    
    const ClientProfileTab = ({ client, allClients, onAddSession, onFileUpload, isAiLoading }) => {
      const { useState } = React;
      const [showAddSession, setShowAddSession] = useState(false);
      const [newSessionDate, setNewSessionDate] = useState(new Date().toISOString().split('T')[0]);
      const handleCreateSession = () => { if (!newSessionDate) return; onAddSession({ date: newSessionDate, summary: `å…³äº ${newSessionDate} çš„å’¨è¯¢` }); setShowAddSession(false); };
      const handleMockUpload = (sessionId, fileType) => {
        const fileName = prompt(`æ¨¡æ‹Ÿä¸Šä¼ : è¯·è¾“å…¥ "å’¨è¯¢é€å­—ç¨¿" çš„æ–‡ä»¶å:`);
        if(fileName) onFileUpload(sessionId, fileType, { name: fileName, content: `è¿™æ˜¯æ–‡ä»¶"${fileName}"çš„æ¨¡æ‹Ÿå†…å®¹ã€‚` });
      }
      const SessionCard = ({ session }) => {
        const status = session.conceptualization?.status === 'Processing' || session.assessment?.status === 'Processing' ? 'Processing' : 
                       (session.conceptualization?.status === 'Complete' && session.assessment?.status === 'Complete') ? 'Complete' : 'Pending';
        return (
            <div className={`p-4 bg-white rounded-lg border border-gray-300 shadow-sm ${status === 'Processing' && 'animate-pulse'}`}>
                <p className="font-semibold text-gray-800">å’¨è¯¢æ—¥æœŸ: {session.date}</p>
                <div className="mt-3 p-3 bg-gray-50 rounded-md text-center">
                    <p className="text-sm font-medium text-gray-600">å’¨è¯¢é€å­—ç¨¿</p>
                    {session.transcript ? (<div className="text-green-600 mt-1"><span className="text-xl">âœ…</span><p className="text-xs break-all">{session.transcript.name}</p></div>) : (<button onClick={() => handleMockUpload(session.id, 'transcript')} disabled={isAiLoading} className="mt-1 text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:opacity-50">ä¸Šä¼ å¹¶ç”ŸæˆAIå†…å®¹</button>)}
                </div>
                {session.transcript && <div className="mt-3 text-center text-xs text-gray-500">âœ¨ AIå†…å®¹çŠ¶æ€: <span className={status === 'Complete' ? 'text-green-600' : 'text-yellow-600'}>{status}</span></div>}
            </div>
        );
      }
      const referrer = client.referredBy ? allClients.find(c => c.id === client.referredBy) : null;
      const referredList = client.referredClients?.map(id => allClients.find(c => c.id === id)).filter(Boolean);
      return (
        <div className="space-y-6">
            <div className="p-4 bg-gray-50 rounded-lg border">
                <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><span className="mr-2">â„¹ï¸</span>åŸºæœ¬ä¿¡æ¯</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-sm">
                    <p><strong>å§“å:</strong> {client.name}</p><p><strong>å¹´é¾„:</strong> {client.age} å²</p><p><strong>æ€§åˆ«:</strong> {client.gender}</p>
                    <p><strong>åœ¨è¯»å¹´çº§:</strong> {client.grade || 'æœªæä¾›'}</p><p><strong>æ€§å–å‘:</strong> {client.sexualOrientation || 'æœªæä¾›'}</p><p><strong>è”ç³»æ–¹å¼:</strong> {client.contact || 'æœªæä¾›'}</p>
                    <p><strong>è¢«...ä»‹ç»:</strong> {referrer ? referrer.name : 'æ— '}</p><p><strong>ä»‹ç»...:</strong> {referredList?.length > 0 ? referredList.map(c => c.name).join(', ') : 'æ— '}</p><p><strong>å¿ƒç†çŠ¶æ€è¯„åˆ†:</strong> {client.mentalStateScore}/10</p>
                    <p className="md:col-span-3"><strong>æ—¢å¾€ç—…å²:</strong> {client.historyOfIllness || 'æœªæä¾›'}</p>
                    <p className="md:col-span-3"><strong>æ®‹éšœæƒ…å†µ:</strong> {client.disabilityStatus || 'æœªæä¾›'}</p>
                    <p><strong>å®—æ•™ä¿¡ä»°:</strong> {client.religiousBelief || 'æœªæä¾›'}</p><p><strong>ç§æ—è®¤åŒ:</strong> {client.ethnicIdentity || 'æœªæä¾›'}</p>
                    <p><strong>ä¸ªäººç»æµ:</strong> {client.personalFinance || 'æœªæä¾›'}</p><p><strong>å®¶åº­ç»æµ:</strong> {client.familyFinance || 'æœªæä¾›'}</p>
                </div>
            </div>
            <div>
                <div className="flex justify-between items-center mb-3"><h3 className="text-lg font-semibold text-gray-700 flex items-center"><span className="mr-2">ğŸ“…</span>å’¨è¯¢ä¼šè¯å·¥ä½œæµ</h3><button onClick={() => setShowAddSession(true)} className="text-sm bg-blue-600 text-white py-1 px-3 rounded-md">æ·»åŠ æ–°ä¼šè¯</button></div>
                {showAddSession && (<div className="p-4 mb-4 bg-blue-50 border rounded-lg flex items-center gap-4"><input type="date" value={newSessionDate} onChange={e => setNewSessionDate(e.target.value)} className="p-2 border rounded-md"/><button onClick={handleCreateSession} className="bg-blue-500 text-white py-2 px-4 rounded-md">åˆ›å»º</button><button onClick={() => setShowAddSession(false)} className="text-gray-600">å–æ¶ˆ</button></div>)}
                <div className="space-y-4">{client.sessions?.length > 0 ? [...client.sessions].reverse().map(session => <SessionCard key={session.id} session={session} />) : <p className="text-center text-gray-500 py-4">æš‚æ— å’¨è¯¢ä¼šè¯è®°å½•ã€‚</p>}</div>
            </div>
        </div>
      );
    };
    
    const ConceptualizationTab = ({ client }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s.conceptualization && s.conceptualization.status !== 'Pending');
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions[0] : null);
        useEffect(() => { const sessions = (client.sessions || []).filter(s => s.conceptualization?.status !== 'Pending'); setSelectedSession(sessions.length > 0 ? sessions[0] : null); }, [client]);
        return (
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">å†å²è®°å½•</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">æš‚æ— è®°å½•ã€‚</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? 'bg-indigo-100 border-indigo-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-indigo-600">å’¨è¯¢æ—¥æœŸ: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.conceptualization.status === 'Complete' ? 'text-green-600' : 'text-red-600'}`}>çŠ¶æ€: {session.conceptualization.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">ä¸ªæ¡ˆæ¦‚å¿µåŒ–è¯¦æƒ…</h3>{selectedSession ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-lg text-indigo-700">å…³äº {selectedSession.date} å’¨è¯¢çš„AIä¸ªæ¡ˆæ¦‚å¿µåŒ–</h4><button onClick={()=>downloadTextAsFile(selectedSession.conceptualization.content, `${client.name}_${selectedSession.date}_ä¸ªæ¡ˆæ¦‚å¿µåŒ–.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded">ä¸‹è½½</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{selectedSession.conceptualization.content}</div></div> : <p className="text-gray-500 text-center pt-10">è¯·ä»å·¦ä¾§é€‰æ‹©è®°å½•æŸ¥çœ‹ã€‚</p>}</div>
            </div>
        );
    }
    const SupervisionReportTab = ({ client, onSupervisionFileUploaded }) => {
        const { useState, useEffect } = React;
        const aiSessions = (client.sessions || []).filter(s => s.transcript);
        const [selectedSession, setSelectedSession] = useState(aiSessions.length > 0 ? aiSessions[0] : null);
        useEffect(() => { const sessions = (client.sessions || []).filter(s => s.transcript); setSelectedSession(sessions.length > 0 ? sessions[0] : null); }, [client]);
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">ä¼šè¯åˆ—è¡¨</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiSessions.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">æš‚æ— ä¼šè¯ã€‚</p> : [...aiSessions].reverse().map(session => <li key={session.id} onClick={() => setSelectedSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedSession?.id === session.id ? 'bg-blue-100 border-blue-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-blue-600">å’¨è¯¢æ—¥æœŸ: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.supervision.status === 'Complete' ? 'text-green-600' : 'text-yellow-600'}`}>{session.supervision.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">AIç£å¯¼å·¥ä½œæµ</h3>{selectedSession ? <div className="p-4 bg-white border rounded-lg h-full space-y-4">
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">ç¬¬1æ­¥: ä¸Šä¼ AIç”Ÿæˆçš„æŠ¥å‘Š</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <div><p className="text-sm text-center mb-1">ä¸ªæ¡ˆæ¦‚å¿µåŒ–</p><button onClick={() => onSupervisionFileUploaded(selectedSession.id, 'conceptualization')} disabled={selectedSession.supervision.conceptualizationUploaded || selectedSession.conceptualization?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400">{selectedSession.supervision.conceptualizationUploaded ? 'å·²ä¸Šä¼ âœ…' : 'ä¸Šä¼ '}</button></div>
                            <div><p className="text-sm text-center mb-1">æ¥è®¿è€…è¯„ä¼°</p><button onClick={() => onSupervisionFileUploaded(selectedSession.id, 'assessment')} disabled={selectedSession.supervision.assessmentUploaded || selectedSession.assessment?.status !== 'Complete'} className="w-full text-xs bg-indigo-500 text-white py-1 px-2 rounded disabled:bg-gray-400">{selectedSession.supervision.assessmentUploaded ? 'å·²ä¸Šä¼ âœ…' : 'ä¸Šä¼ '}</button></div>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">è¯·å…ˆç¡®ä¿æ¦‚å¿µåŒ–å’Œè¯„ä¼°æŠ¥å‘Šå·²ç”Ÿæˆã€‚ä¸Šä¼ åå°†è‡ªåŠ¨è§¦å‘æœ€ç»ˆç£å¯¼æŠ¥å‘Šç”Ÿæˆã€‚</p>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-md">
                        <h4 className="text-md font-medium text-gray-700 mb-2">ç¬¬2æ­¥: æŸ¥çœ‹æœ€ç»ˆç£å¯¼æŠ¥å‘Š</h4>
                        {selectedSession.supervision.status === 'Complete' ? <button onClick={()=>downloadTextAsFile(selectedSession.supervision.content, `${client.name}_${selectedSession.date}_ç£å¯¼æŠ¥å‘Š.txt`)} className="text-sm bg-green-500 text-white py-2 px-4 rounded">ä¸‹è½½ç£å¯¼æŠ¥å‘Š</button> : <p className="text-sm text-gray-500">çŠ¶æ€: {selectedSession.supervision.status}</p>}
                    </div>
                </div> : <p className="text-gray-500 text-center pt-10">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯ä»¥å¼€å§‹ç£å¯¼æµç¨‹ã€‚</p>}</div>
            </div>
        );
    };

    const AnalysisReportTab = ({ client }) => {
        const { useState, useEffect } = React;
        const aiReports = (client.sessions || []).filter(s => s.assessment && s.assessment.status !== 'Pending');
        const [selectedReportSession, setSelectedReportSession] = useState(aiReports.length > 0 ? aiReports[0] : null);
        useEffect(() => { const reports = (client.sessions || []).filter(s => s.assessment && s.assessment.status !== 'Pending'); setSelectedReportSession(reports.length > 0 ? reports[0] : null); }, [client]);
        return (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-gray-50 p-4 rounded-lg border"><h3 className="text-lg font-medium text-gray-700 mb-3">å†å²è¯„ä¼°</h3><ul className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">{aiReports.length === 0 ? <p className="text-sm text-gray-500 text-center py-4">æš‚æ— AIè¯„ä¼°æŠ¥å‘Šã€‚</p> : [...aiReports].reverse().map(session => <li key={session.id} onClick={() => setSelectedReportSession(session)} className={`p-3 rounded-lg cursor-pointer border-2 ${selectedReportSession?.id === session.id ? 'bg-green-100 border-green-500' : 'bg-white hover:bg-gray-100 border-transparent'}`}><p className="font-semibold text-green-600">å’¨è¯¢æ—¥æœŸ: {session.date}</p><p className={`text-xs font-medium mt-1 ${session.assessment.status === 'Complete' ? 'text-green-600' : 'text-red-600'}`}>çŠ¶æ€: {session.assessment.status}</p></li>)}</ul></div>
                <div className="md:col-span-2"><h3 className="text-lg font-medium mb-3 text-gray-700">è¯„ä¼°è¯¦æƒ…</h3>{selectedReportSession ? <div className="p-4 bg-white border rounded-lg h-full"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-lg text-green-700">å…³äº {selectedReportSession.date} å’¨è¯¢çš„è¯„ä¼°æŠ¥å‘Š</h4><button onClick={()=>downloadTextAsFile(selectedReportSession.assessment.content, `${client.name}_${selectedReportSession.date}_è¯„ä¼°æŠ¥å‘Š.txt`)} className="text-xs bg-gray-600 text-white py-1 px-2 rounded">ä¸‹è½½</button></div><div className="whitespace-pre-wrap text-gray-800 bg-gray-50 p-3 mt-3 rounded-md overflow-y-auto max-h-[55vh]">{selectedReportSession.assessment.content}</div></div> : <p className="text-gray-500 text-center pt-10">è¯·é€‰æ‹©æŠ¥å‘ŠæŸ¥çœ‹ã€‚</p>}</div>
            </div>
        );
    };

    const CBTSection = ({...props}) => {
      const { useState } = React;
      const [userInput, setUserInput] = useState('');
      const [modelResponse, setModelResponse] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      const [activeModel, setActiveModel] = useState(null);
      const handleCBTInteraction = async (model) => {
          if (!userInput.trim()) { console.warn('è¯·è¾“å…¥ã€‚'); return; }
          setIsLoading(true); setActiveModel(model); setError(null); setModelResponse(''); 
          const systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„CBTå¿ƒç†å’¨è¯¢å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»¥å…±æƒ…ã€æ”¯æŒå’Œå¼•å¯¼çš„æ–¹å¼ä¸ç”¨æˆ·å¯¹è¯ã€‚å¸®åŠ©ç”¨æˆ·è¯†åˆ«ã€æŒ‘æˆ˜å’Œé‡æ„ä»–ä»¬çš„è‡ªåŠ¨åŒ–è´Ÿæ€§æ€ç»´ã€‚ä½¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®ï¼Œå¹¶æä¾›å…³äºCBTæ¦‚å¿µçš„å¿ƒç†æ•™è‚²ã€‚ä½ å¿…é¡»ä½¿ç”¨ä¸­æ–‡è¿›è¡Œå›å¤ã€‚";
          await callApi({ systemPrompt, userPrompt: userInput, model, onChunk: (chunk) => setModelResponse(prev => prev + chunk), onError: (err) => setError(`æŠ±æ­‰ï¼Œä¸AIæ¨¡å‹é€šä¿¡å¤±è´¥: ${err}`) });
          setIsLoading(false); setActiveModel(null);
      };
      const LoadingSpinner = () => <svg className="animate-spin mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
      return (
          <div className="bg-white p-6 rounded-xl shadow-xl animate-fadeIn max-w-4xl mx-auto">
          <h2 className="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3 flex items-center"><span className="text-2xl mr-3">ğŸ§ </span>CBTè¾…åŠ©å·¥å…·</h2>
          <div className="mb-4"><label htmlFor="cbtInput" className="block text-md font-medium text-gray-700 mb-2">è¯·è¾“å…¥ä¸€ä¸ªè‡ªåŠ¨åŒ–æ€ç»´ã€å›°æ‰°æƒ…å¢ƒæˆ–æƒ³è¦æ¢è®¨çš„é—®é¢˜ï¼š</label><textarea id="cbtInput" value={userInput} onChange={(e) => setUserInput(e.target.value)} rows="5" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ€»æ˜¯æ‹…å¿ƒåˆ«äººæ€ä¹ˆçœ‹æˆ‘ï¼Œè§‰å¾—è‡ªå·±ä¸å¤Ÿå¥½..." className="w-full p-3 border rounded-lg"/></div>
          <div className="flex items-center space-x-4">
              <button onClick={() => handleCBTInteraction('deepseek-chat')} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">{isLoading && activeModel === 'deepseek-chat' ? <LoadingSpinner /> : <span className="mr-2">âš¡ï¸</span>}è·å–å¿«é€ŸCBTåé¦ˆ</button>
              <button onClick={() => handleCBTInteraction('deepseek-reasoner')} disabled={isLoading} className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">{isLoading && activeModel === 'deepseek-reasoner' ? <LoadingSpinner /> : <span className="mr-2">âœ¨</span>}è·å–æ·±åº¦CBTåé¦ˆ</button>
          </div>
          {(modelResponse || error) && (<div className="mt-6 p-5 bg-gray-50 border rounded-lg shadow-inner"><h3 className="text-lg font-semibold text-gray-700 mb-2">æ¨¡å‹åé¦ˆï¼š</h3>{error ? <p className="text-red-500">{error}</p> : <p className="text-gray-800 whitespace-pre-wrap leading-relaxed">{modelResponse}</p>}</div>)}
          <div className="mt-8 p-4 bg-yellow-100 border text-yellow-800 rounded-lg"><h4 className="text-md font-semibold mb-1">APIå¯†é’¥å®‰å…¨æç¤ºï¼š</h4><p className="text-sm">ä¸ºæ–¹ä¾¿æ¼”ç¤ºï¼ŒAPIå¯†é’¥ç›´æ¥å†™åœ¨å‰ç«¯ä»£ç ä¸­ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¯·åŠ¡å¿…é€šè¿‡åç«¯æœåŠ¡å™¨è°ƒç”¨APIä»¥ä¿è¯å®‰å…¨ã€‚</p></div>
          </div>
      );
    };

    const InfoCard = ({ title, value, icon }) => ( <div className="bg-white p-4 rounded-lg shadow-md border flex items-center">{icon && <div className="mr-3 text-2xl">{icon}</div>}<div><p className="text-sm text-gray-500">{title}</p><p className="text-xl font-semibold text-gray-800">{value}</p></div></div> );
    
    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
