<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿ƒç†å’¨è¯¢å¸ˆåŠ©æ‰‹</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback if Tailwind fails to load
    if (!window.tailwind) {
      document.write('<style>body{font-family:Inter,sans-serif;margin:0;padding:0;background:#f9fafb}.bg-gray-100{background-color:#f3f4f6}.bg-white{background-color:#fff}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.rounded-lg{border-radius:.5rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.text-center{text-align:center}.text-xl{font-size:1.25rem}.font-bold{font-weight:700}.text-blue-600{color:#2563eb}.hover\\:bg-blue-700:hover{background-color:#1d4ed8}.min-h-screen{min-height:100vh}.flex{display:flex}.items-center{align-items:center}.justify-center{justify-content:center}.space-y-4>:not([hidden])~:not([hidden]){margin-top:1rem}.w-full{width:100%}.max-w-md{max-width:28rem}.border{border-width:1px}.rounded-md{border-radius:.375rem}.mt-1{margin-top:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.bg-blue-600{background-color:#2563eb}.text-white{color:#fff}.cursor-pointer{cursor:pointer}</style>');
    }
  </script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fallback scripts if CDN fails -->
  <script>
    // Check if React loaded
    if (typeof React === 'undefined') {
      console.error('React failed to load from CDN. Please check your internet connection.');
      document.body.innerHTML = '<div style="text-align:center;padding:50px;font-family:Arial,sans-serif;"><h2>åŠ è½½å¤±è´¥</h2><p>æ— æ³•ä»CDNåŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</p><p>é”™è¯¯ï¼šReactåº“åŠ è½½å¤±è´¥</p></div>';
    }
    // Check if ReactDOM loaded
    if (typeof ReactDOM === 'undefined') {
      console.error('ReactDOM failed to load from CDN. Please check your internet connection.');
      document.body.innerHTML = '<div style="text-align:center;padding:50px;font-family:Arial,sans-serif;"><h2>åŠ è½½å¤±è´¥</h2><p>æ— æ³•ä»CDNåŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</p><p>é”™è¯¯ï¼šReactDOMåº“åŠ è½½å¤±è´¥</p></div>';
    }
    // Check if Babel loaded
    if (typeof Babel === 'undefined') {
      console.error('Babel failed to load from CDN. Please check your internet connection.');
      document.body.innerHTML = '<div style="text-align:center;padding:50px;font-family:Arial,sans-serif;"><h2>åŠ è½½å¤±è´¥</h2><p>æ— æ³•ä»CDNåŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</p><p>é”™è¯¯ï¼šBabelåº“åŠ è½½å¤±è´¥</p></div>';
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    .custom-modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .custom-modal-content {
      background: white; padding: 2rem; border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center; max-width: 90%; width: 450px;
    }
    .custom-modal-button {
      margin-top: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
      border: none; background-color: #3B82F6; color: white;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s;
    }
    .custom-modal-button:hover { background-color: #2563EB; }
    .time-slot { display: flex; flex-direction: column; gap: 4px; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    // Global error handler for unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

    // Global error handler for JavaScript errors  
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.error);
    });

    const App = () => {
      const { useState, useEffect, useCallback } = React;
      
      const [appData, setAppData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [currentUser, setCurrentUser] = useState(null); // Will store { username, role }

      const [globalLoadingMessage, setGlobalLoadingMessage] = useState('');
      const [alertInfo, setAlertInfo] = useState({ show: false, message: '' });

      // Check for persisted user on initial load
      useEffect(() => {
        const persistedUser = localStorage.getItem('currentUser');
        if (persistedUser) {
          try {
            setCurrentUser(JSON.parse(persistedUser));
          } catch(e) {
            console.error("Failed to parse user from localStorage", e);
            localStorage.removeItem('currentUser');
          }
        }
        setIsLoading(false);
      }, []);

      const showAlert = useCallback((message) => {
        setAlertInfo({ show: true, message });
      }, []);
      
      const fetchData = useCallback(async () => {
        if (!currentUser) {
            setAppData(null);
            setIsLoading(false);
            return;
        }

        setIsLoading(true);
        let dataPath;
        if (currentUser.role === 'manager') {
            dataPath = '/api/data/manager';
        } else if (currentUser.role === 'counselor') {
            dataPath = `/api/data/counselor/${currentUser.username}`;
        } else { // client
            dataPath = '/api/data/all';
        }

        try {
            const res = await fetch(dataPath);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            const data = await res.json();
            setAppData(data);
        } catch (error) {
            console.error("Failed to fetch data:", error);
            if (error.message.includes('404')) {
                showAlert("APIç«¯ç‚¹æœªæ‰¾åˆ°ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œå¹¶ä¸”è·¯ç”±é…ç½®æ­£ç¡®ã€‚");
            } else if (error.message.includes('Failed to fetch')) {
                showAlert("ç½‘ç»œè¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚");
            } else {
                showAlert(`åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
            }
        } finally {
            setIsLoading(false);
        }
      }, [currentUser]);
      
      useEffect(() => {
        fetchData();
      }, [fetchData]);

      // Generic save function now routes based on role
      const saveData = useCallback(async (dataToSave, isClientProfileUpdate = false) => {
          if (!currentUser) return showAlert("è¯·å…ˆç™»å½•ã€‚");

          let url, body;
          if (currentUser.role === 'manager') {
              url = '/api/data/manager';
              body = JSON.stringify(dataToSave); // Manager saves the whole blob
          } else if (currentUser.role === 'counselor') {
              url = `/api/data/counselor/${currentUser.username}`;
              body = JSON.stringify(dataToSave); // Counselor saves their perspective
          } else if (currentUser.role === 'client' && isClientProfileUpdate) {
              url = `/api/data/client/${currentUser.username}`;
              body = JSON.stringify(dataToSave); // Client saves their profile
          } else {
              return showAlert("æ— æƒä¿å­˜æ•°æ®ã€‚");
          }

          try {
              const response = await fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: body,
              });
              if (!response.ok) {
                  const err = await response.json();
                  throw new Error(err.message || "ä¿å­˜å¤±è´¥");
              }
              // No automatic fetchData here to allow for optimistic updates
          } catch (error) {
              console.error("Failed to save data:", error);
              showAlert(`ä¿å­˜æ•°æ®å¤±è´¥: ${error.message}`);
          }
      }, [currentUser]);

      const handleRegister = async (username, password, role, secretCode) => {
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role, secret_code: secretCode }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message); // The message from backend now contains the binding code
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch (error) {
            showAlert('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };

      const handleLogin = async (username, password, role) => {
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role }),
            });
            const data = await response.json();
            if (response.ok) {
                showAlert(data.message);
                const user = { username: data.username, role: data.role };
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                return true;
            } else {
                showAlert(data.message);
                return false;
            }
        } catch(error) {
            showAlert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            return false;
        }
      };
      
      const handleLogout = () => {
          localStorage.removeItem('currentUser');
          setCurrentUser(null);
          setAppData(null);
      }
      
      const renderPortal = () => {
          if (isLoading || (currentUser && !appData && currentUser.role !== 'client')) {
              return (
                  <div className="min-h-screen flex items-center justify-center bg-gray-50">
                      <div className="text-center p-8">
                          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                          <h2 className="text-xl font-semibold text-gray-700 mb-2">æ­£åœ¨åŠ è½½...</h2>
                          <p className="text-gray-500">è¯·ç¨å€™ï¼Œæ­£åœ¨è¿æ¥æœåŠ¡å™¨</p>
                          {currentUser && (
                              <p className="text-sm text-gray-400 mt-2">ç”¨æˆ·: {currentUser.username} ({currentUser.role})</p>
                          )}
                      </div>
                  </div>
              )
          }
          if (!currentUser) {
              return <AuthModal onLogin={handleLogin} onRegister={handleRegister} showAlert={showAlert} />;
          }
          switch (currentUser.role) {
              case 'manager':
                  return <ManagerPortal user={currentUser} allData={appData} setAllData={setAppData} onSave={saveData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} />;
              case 'counselor':
                  return <CounselorPortal user={currentUser} initialData={appData} onLogout={handleLogout} showAlert={showAlert} globalLoadingMessage={globalLoadingMessage} setGlobalLoadingMessage={setGlobalLoadingMessage} fetchData={fetchData} />;
              case 'client':
                  return <ClientPortal user={currentUser} allData={appData} onLogout={handleLogout} onSave={saveData} showAlert={showAlert} />;
              default:
                  return <div className="min-h-screen flex items-center justify-center">æ— æ³•è¯†åˆ«çš„ç”¨æˆ·è§’è‰²ã€‚</div>;
          }
      };

      return (
          <>
            {alertInfo.show && (
              <div className="custom-modal-backdrop animate-fadeIn" onClick={() => setAlertInfo({ show: false, message: '' })}>
                <div className="custom-modal-content" onClick={(e) => e.stopPropagation()}>
                  <p className="text-gray-800 whitespace-pre-wrap">{alertInfo.message}</p>
                  <button className="custom-modal-button" onClick={() => setAlertInfo({ show: false, message: '' })}>å…³é—­</button>
                </div>
              </div>
            )}
            {renderPortal()}
          </>
      );
    };
    
    // --- All Components ---

    const AuthModal = ({ onLogin, onRegister, showAlert }) => {
        const { useState } = React;
        const [mode, setMode] = useState('login');
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [role, setRole] = useState('counselor');
        const [secretCode, setSecretCode] = useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            
            if (!username) { showAlert('è¯·è¾“å…¥ç”¨æˆ·åã€‚'); return; }
            if (!password) { showAlert('è¯·è¾“å…¥å¯†ç ã€‚'); return; }

            if (mode === 'register') {
              if (password.length < 6) { showAlert('å¯†ç å¿…é¡»è‡³å°‘ä¸º6ä¸ªå­—ç¬¦ã€‚'); return; }
              if (password !== confirmPassword) { showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸åŒ¹é…ï¼'); return; }
              if (role === 'counselor' && !secretCode) { showAlert('è¯·è¾“å…¥å’¨è¯¢å¸ˆ/ç®¡ç†æ³¨å†Œå£ä»¤ã€‚'); return; }
              await onRegister(username, password, role, secretCode);
            } else {
              await onLogin(username, password, role);
            }
        };
        
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-lg shadow-xl p-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</h2>
                    
                    <div className="flex justify-center mb-6">
                        <div className="bg-gray-200 p-1 rounded-full flex">
                            <button onClick={() => setRole('counselor')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'counselor' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>å’¨è¯¢å¸ˆ/ç®¡ç†</button>
                            <button onClick={() => setRole('client')} className={`px-4 py-1 text-sm font-semibold rounded-full ${role === 'client' ? 'bg-blue-600 text-white' : 'text-gray-600'}`}>æ¥è®¿è€…</button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-sm font-medium text-gray-700">ç”¨æˆ·å</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>
                        
                                                <div><label className="text-sm font-medium text-gray-700">å¯†ç </label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required /></div>

                        {mode === 'register' && (
                          <>
                            <div><label className="text-sm font-medium text-gray-700">ç¡®è®¤å¯†ç </label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-2 mt-1 border rounded-md" required/></div>
                            {role === 'counselor' && (
                              <div><label className="text-sm font-medium text-gray-700">æ³¨å†Œå£ä»¤</label><input type="password" value={secretCode} onChange={e => setSecretCode(e.target.value)} placeholder="å’¨è¯¢å¸ˆ/ç®¡ç†å‘˜éœ€è¦å£ä»¤" className="w-full p-2 mt-1 border rounded-md" required/></div>
                            )}
                          </>
                        )}
                        <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold">{mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ'}</button>
                    </form>

                    <p className="text-xs text-center text-gray-500 mt-4">
                      {mode === 'login' ? 'æ²¡æœ‰è´¦æˆ·ï¼Ÿ' : 'å·²æœ‰è´¦æˆ·ï¼Ÿ'}
                      <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-blue-600 hover:underline ml-1">
                        {mode === 'login' ? 'ç‚¹å‡»æ³¨å†Œ' : 'è¿”å›ç™»å½•'}
                      </button>
                    </p>
                </div>
            </div>
        );
    };
    
    // ================================================================================================
    // =================================== MANAGER PORTAL START =======================================
    // ================================================================================================
    const ManagerPortal = ({ user, allData, setAllData, onSave, onLogout, showAlert, globalLoadingMessage, setGlobalLoadingMessage }) => {
        const { useState } = React;
        const [activeSection, setActiveSection] = useState('counselorManagement');
        const [selectedClient, setSelectedClient] = useState(null);

        const handleUpdateData = (newData) => {
            setAllData(newData);
            onSave(newData);
        };

        const handleUpdateClient = (updatedClientData) => {
            const newCounselorData = { ...allData.counselor_data };
            const clientIndex = newCounselorData.clients.findIndex(c => c.id === updatedClientData.id);
            if (clientIndex > -1) {
                newCounselorData.clients[clientIndex] = updatedClientData;
            } else {
                newCounselorData.clients.push(updatedClientData);
            }
            handleUpdateData({ ...allData, counselor_data: newCounselorData });
        };
        
        const handleDeleteClient = (clientId) => {
            const clientToDelete = allData.counselor_data.clients.find(c => c.id === clientId);
            if (!clientToDelete) return;

            const updatedCounselorData = { ...allData.counselor_data };
            updatedCounselorData.clients = updatedCounselorData.clients.filter(c => c.id !== clientId);
            updatedCounselorData.counselors = updatedCounselorData.counselors.map(c => ({
                ...c, assignedClientIds: c.assignedClientIds.filter(id => id !== clientId)
            }));
            updatedCounselorData.appointments = updatedCounselorData.appointments.filter(a => a.clientId !== clientId);

            const updatedUsers = { ...allData.users };
            if (clientToDelete.username) {
                delete updatedUsers[clientToDelete.username];
            }
            
            handleUpdateData({ users: updatedUsers, counselor_data: updatedCounselorData });
            showAlert(`æ¥è®¿è€… ${clientToDelete.name} å·²è¢«åˆ é™¤ã€‚`);
            if (selectedClient?.id === clientId) setSelectedClient(null);
        };

        const handleUpdateCounselors = (updatedCounselors) => {
            handleUpdateData({ ...allData, counselor_data: { ...allData.counselor_data, counselors: updatedCounselors } });
        };

        const handleDeleteCounselor = (counselorId) => {
            const counselorToDelete = allData.counselor_data.counselors.find(c => c.id !== counselorId);
            if(!counselorToDelete) return;
            if (allData.counselor_data.appointments.some(a => a.counselorId === counselorId)) {
                return showAlert('æ— æ³•åˆ é™¤è¯¥å’¨è¯¢å¸ˆï¼Œå…¶ä»æœ‰å…³è”çš„æ—¥ç¨‹å®‰æ’ã€‚');
            }
            const updatedCounselors = allData.counselor_data.counselors.filter(c => c.id !== counselorId);
            const updatedUsers = { ...allData.users };
            if (counselorToDelete.username) {
                delete updatedUsers[counselorToDelete.username];
            }
            handleUpdateData({ users: updatedUsers, counselor_data: { ...allData.counselor_data, counselors: updatedCounselors } });
            showAlert('å’¨è¯¢å¸ˆå·²åˆ é™¤ã€‚');
        };

        const handleUpdateAppointments = (appointmentData, isDelete = false) => {
            let updatedAppointments;
            if (isDelete) {
                updatedAppointments = allData.counselor_data.appointments.filter(a => a.id !== appointmentData.id);
            } else {
                const index = allData.counselor_data.appointments.findIndex(a => a.id === appointmentData.id);
                updatedAppointments = [...allData.counselor_data.appointments];
                if (index > -1) updatedAppointments[index] = appointmentData;
                else updatedAppointments.push({ ...appointmentData, id: `appt-${Date.now()}` });
            }
            handleUpdateData({ ...allData, counselor_data: { ...allData.counselor_data, appointments: updatedAppointments } });
        };
        
        const handleSaveUser = (username, password, role, isNew = false) => {
            const updatedUsers = { ...allData.users };
            if(updatedUsers[username] && isNew) return showAlert('ç”¨æˆ·åå·²å­˜åœ¨');
            updatedUsers[username] = { password, role };
            handleUpdateData({ ...allData, users: updatedUsers });
        };

        const navItems = [
            { id: 'counselorManagement', label: 'å’¨è¯¢å¸ˆç®¡ç†', icon: 'ğŸ§‘â€ğŸ«' },
            { id: 'clientManagement', label: 'æ¥è®¿è€…ç®¡ç†', icon: 'ğŸ‘¥' },
            { id: 'schedule', label: 'å’¨è¯¢æ—¥ç¨‹', icon: 'ğŸ—“ï¸' },
        ];
        
        const renderSection = () => {
            const { users, counselor_data } = allData;
            switch(activeSection) {
                case 'counselorManagement':
                    return <CounselorManagementSection 
                                isManagerView={true} 
                                counselors={counselor_data.counselors} 
                                clients={counselor_data.clients} 
                                appointments={counselor_data.appointments}
                                users={users}
                                onUpdateCounselors={handleUpdateCounselors}
                                onDeleteCounselor={handleDeleteCounselor}
                                onSaveUser={handleSaveUser}
                            />;
                case 'clientManagement':
                    return <ClientManagementSection 
                                isManagerView={true}
                                clients={counselor_data.clients}
                                users={users}
                                onSelectClient={setSelectedClient}
                                onSaveUser={handleSaveUser}
                                onUpdateClient={handleUpdateClient}
                                onDeleteClient={handleDeleteClient}
                                onClientDetailBack={() => setSelectedClient(null)}
                                selectedClient={selectedClient}
                                setGlobalLoadingMessage={setGlobalLoadingMessage}
                                showAlert={showAlert}
                            />;
                case 'schedule':
                     return <ScheduleSection 
                                appointments={counselor_data.appointments} 
                                clients={counselor_data.clients} 
                                counselors={counselor_data.counselors} 
                                onUpdateAppointments={handleUpdateAppointments} 
                            />;
                default: return <div/>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col">
                <header className="bg-white shadow-sm sticky top-0 z-40">
                    <div className="container mx-auto px-4">
                        <div className="flex items-center justify-between h-16">
                            <h1 className="text-xl font-bold text-gray-800">å¹³å°ç®¡ç†</h1>
                            <div className="flex items-center gap-4">
                                <nav className="hidden md:flex items-center space-x-1">
                                    {navItems.map(item => (
                                        <button key={item.id} onClick={() => setActiveSection(item.id)}
                                            className={`px-3 py-2 rounded-md text-sm font-medium flex items-center transition-colors duration-200 ${activeSection === item.id ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}>
                                            <span className="mr-2">{item.icon}</span>{item.label}
                                        </button>
                                    ))}
                                </nav>
                                <div className="border-l pl-4 flex items-center gap-2">
                                    <span className="text-sm text-gray-500 hidden lg:inline">{user.username}</span>
                                    <button onClick={onLogout} className="text-sm font-medium text-gray-500 hover:text-red-600">ç™»å‡º</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                {globalLoadingMessage && (<div className="bg-yellow-100 text-yellow-800 text-center p-2 animate-pulse flex items-center justify-center sticky top-16 z-30"><span className="mr-2">â³</span>{globalLoadingMessage}</div>)}
                <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">{renderSection()}</main>
            </div>
        );
    };


    // ================================================================================================
    // =================================== CLIENT PORTAL START ========================================
    // ================================================================================================
    const ClientPortal = ({ user, allData, onLogout, onSave, showAlert }) => {
        const { useState, useMemo, useEffect } = React;
        const [clientProfile, setClientProfile] = useState(null);
        const [activeSection, setActiveSection] = useState('dashboard');
        const [selectedCounselor, setSelectedCounselor] = useState(null);

        useEffect(() => {
            const fetchSelfData = async () => {
                try {
                    const res = await fetch(`/api/client/me/${user.username}`);
                    if (!res.ok) {
                        // If the client-specific endpoint fails, try to find the client in the general data
                        console.warn('Client-specific endpoint failed, trying general data...');
                        if (allData && allData.clients) {
                            const clientData = allData.clients.find(c => c.username === user.username);
                            if (clientData) {
                                setClientProfile(clientData);
                                return;
                            }
                        }
                        throw new Error('Could not fetch client profile');
                    }
                    const selfData = await res.json();
                    setClientProfile(selfData);
                } catch (error) {
                    console.error('Error fetching client profile:', error);
                    // Fallback: try to use data from allData
                    if (allData && allData.clients) {
                        const clientData = allData.clients.find(c => c.username === user.username);
                        if (clientData) {
                            setClientProfile(clientData);
                            return;
                        }
                    }
                    showAlert('æ— æ³•åŠ è½½æ‚¨çš„ä¸ªäººä¿¡æ¯ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                }
            };
            if (user && user.username) {
                fetchSelfData();
            }
        }, [user.username, allData]);

        const assignedCounselor = clientProfile && allData && allData.counselors ? allData.counselors.find(c => c.assignedClientIds?.includes(clientProfile.id)) : null;
        const clientAppointments = clientProfile && allData && allData.appointments ? allData.appointments.filter(a => a.clientId === clientProfile.id) : [];

        const { totalHours, monthlyHours } = useMemo(() => {
            if (!clientAppointments) return { totalHours: 0, monthlyHours: 0 };
         